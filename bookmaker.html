<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookmaker Manager - CRM System</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Estilos espec√≠ficos para a p√°gina de Bookmaker */
        .bookmaker-container {
            padding: 20px;
        }

        .bookmaker-header {
            margin-bottom: 25px;
        }

        .bookmaker-panel {
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }

        .btn:hover {
            background-color: #0069d9;
        }

        .bookmaker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .bookmaker-table th, 
        .bookmaker-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .bookmaker-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-buttons .btn {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-edit {
            background-color: #ffc107;
        }

        .btn-delete {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>CRM</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="index.html" data-section="homepage">
                            <span class="icon">üè†</span>
                            <span>Homepage</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="bookmaker.html" data-section="bookmaker">
                            <span class="icon">üìö</span>
                            <span>Bookmaker Manager</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="user">
                            <span class="icon">üë§</span>
                            <span>User Manager</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="content">
            <header class="content-header">
                <h2 id="section-title">Bookmaker Manager</h2>
            </header>

            <div class="bookmaker-container">
                <div class="bookmaker-panel">
                    <div class="bookmaker-header">
                        <h3>Gerenciar Bookmakers</h3>
                        <p>Adicione, edite ou remova bookmakers no sistema.</p>
                    </div>

                    <div class="bookmaker-actions" style="margin-bottom: 20px;">
                        <button class="btn" id="addOwner" style="margin-right: 10px;">Add Owner</button>
                        <button class="btn" id="addGroup" style="margin-right: 10px;">Add Group</button>
                        <button class="btn" id="addBookmaker">Add Bookmaker</button>
                    </div>

                    <table class="bookmaker-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>URL</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>Bookmaker A</td>
                                <td>https://bookmakera.com</td>
                                <td>Ativo</td>
                                <td class="action-buttons">
                                    <button class="btn btn-edit">Editar</button>
                                    <button class="btn btn-delete">Excluir</button>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Bookmaker B</td>
                                <td>https://bookmakerb.com</td>
                                <td>Ativo</td>
                                <td class="action-buttons">
                                    <button class="btn btn-edit">Editar</button>
                                    <button class="btn btn-delete">Excluir</button>
                                </td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>Bookmaker C</td>
                                <td>https://bookmaker.com</td>
                                <td>Inativo</td>
                                <td class="action-buttons">
                                    <button class="btn btn-edit">Editar</button>
                                    <button class="btn btn-delete">Excluir</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Owner Modal -->
    <div id="ownerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Owner</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="owner-settings">Owner Settings</div>
                    <div class="tab" data-tab="owner-billing">Owner Billing Details</div>
                </div>

                <div class="tab-content active" id="owner-settings">
                    <div class="form-group">
                        <label for="owner-status">Owner Status</label>
                        <select id="owner-status" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="owner-name">Owner Name</label>
                        <input type="text" id="owner-name" class="form-control" placeholder="Enter owner name">
                    </div>
                    <div class="form-group">
                        <label for="owner-logo">Owner Logo</label>
                        <input type="file" id="owner-logo" class="form-control" accept="image/*">
                        <div id="logo-preview" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <div class="tab-content" id="owner-billing">
                    <div class="form-check">
                        <input type="checkbox" id="apply-billing" class="form-control" style="width: auto;">
                        <label for="apply-billing">Apply Billing Details by Owner?</label>
                    </div>

                    <div id="billing-details" style="display: none;">
                        <div class="form-group">
                            <label for="billing-name">Name</label>
                            <input type="text" id="billing-name" class="form-control" placeholder="Enter billing name">
                        </div>
                        <div class="form-group">
                            <label for="billing-vat">VAT</label>
                            <input type="text" id="billing-vat" class="form-control" placeholder="Enter VAT number">
                        </div>
                        <div class="form-group">
                            <label for="billing-address1">Address 1</label>
                            <input type="text" id="billing-address1" class="form-control" placeholder="Enter address line 1">
                        </div>
                        <div class="form-group">
                            <label for="billing-address2">Address 2</label>
                            <input type="text" id="billing-address2" class="form-control" placeholder="Enter address line 2">
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="billing-city">City</label>
                                <input type="text" id="billing-city" class="form-control" placeholder="Enter city">
                            </div>
                            <div class="form-col">
                                <label for="billing-state">State/Province/Region</label>
                                <input type="text" id="billing-state" class="form-control" placeholder="Enter state/province">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="billing-zipcode">Zip-Code</label>
                                <input type="text" id="billing-zipcode" class="form-control" placeholder="Enter zip code">
                            </div>
                            <div class="form-col">
                                <label for="billing-country">Country</label>
                                <div class="country-selector">
                                    <input type="text" id="country-search" class="country-search" placeholder="Search country">
                                    <div id="country-list" class="country-list"></div>
                                    <div id="selected-country" class="selected-country" style="display: none;">
                                        <span id="selected-flag" class="country-flag"></span>
                                        <span id="selected-name"></span>
                                        <span class="country-remove">√ó</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background-color: #6c757d;">Cancel</button>
                <button class="btn" id="save-owner">Save Owner</button>
            </div>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Group</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="group-settings">Group Settings</div>
                    <div class="tab" data-tab="group-account">Group Account Settings</div>
                    <div class="tab" data-tab="group-billing">Group Billing Settings</div>
                    <div class="tab" data-tab="group-deal">Group Deal Settings</div>
                </div>

                <!-- Group Settings Tab -->
                <div class="tab-content active" id="group-settings">
                    <div class="form-group">
                        <label for="group-status">Group Status</label>
                        <select id="group-status" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="group-name">Group Name</label>
                        <input type="text" id="group-name" class="form-control" placeholder="Enter group name">
                    </div>
                    <div class="form-group">
                        <label for="group-logo">Group Logo</label>
                        <input type="file" id="group-logo" class="form-control" accept="image/*">
                        <div id="group-logo-preview" class="image-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="group-url">Group URL</label>
                        <input type="url" id="group-url" class="form-control" placeholder="Enter group URL">
                    </div>
                    <div class="form-group">
                        <label for="group-affiliate-url">Group Affiliate URL</label>
                        <input type="url" id="group-affiliate-url" class="form-control" placeholder="Enter group affiliate URL">
                    </div>
                </div>

                <!-- Group Account Settings Tab -->
                <div class="tab-content" id="group-account">
                    <div class="form-check">
                        <input type="checkbox" id="apply-account" class="form-check-input">
                        <label for="apply-account">Apply Account Settings by Group?</label>
                    </div>

                    <div id="account-details" style="display: none;">
                        <div class="form-group">
                            <label for="account-owner">Owner</label>
                            <select id="account-owner" class="form-control">
                                <option value="">Select an owner</option>
                                <!-- Owners will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-status">Account Status</label>
                            <select id="account-status" class="form-control">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-username">Username/Email</label>
                            <input type="text" id="account-username" class="form-control" placeholder="Enter username or email">
                        </div>
                        <div class="form-group">
                            <label for="account-password">Password</label>
                            <input type="password" id="account-password" class="form-control" placeholder="Enter password">
                        </div>
                    </div>
                </div>

                <!-- Group Billing Settings Tab -->
                <div class="tab-content" id="group-billing">
                    <div class="form-check">
                        <input type="checkbox" id="apply-group-billing" class="form-check-input">
                        <label for="apply-group-billing">Apply Billing Settings by Group?</label>
                    </div>

                    <div id="group-billing-details" style="display: none;">
                        <div class="form-group">
                            <label for="group-billing-name">Name</label>
                            <input type="text" id="group-billing-name" class="form-control" placeholder="Enter billing name">
                        </div>
                        <div class="form-group">
                            <label for="group-billing-vat">VAT</label>
                            <input type="text" id="group-billing-vat" class="form-control" placeholder="Enter VAT number">
                        </div>
                        <div class="form-group">
                            <label for="group-billing-address1">Address 1</label>
                            <input type="text" id="group-billing-address1" class="form-control" placeholder="Enter address line 1">
                        </div>
                        <div class="form-group">
                            <label for="group-billing-address2">Address 2</label>
                            <input type="text" id="group-billing-address2" class="form-control" placeholder="Enter address line 2">
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="group-billing-city">City</label>
                                <input type="text" id="group-billing-city" class="form-control" placeholder="Enter city">
                            </div>
                            <div class="form-col">
                                <label for="group-billing-state">State/Province/Region</label>
                                <input type="text" id="group-billing-state" class="form-control" placeholder="Enter state/province">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="group-billing-zipcode">Zip-Code</label>
                                <input type="text" id="group-billing-zipcode" class="form-control" placeholder="Enter zip code">
                            </div>
                            <div class="form-col">
                                <label for="group-billing-country">Country</label>
                                <div class="country-selector">
                                    <input type="text" id="group-country-search" class="country-search" placeholder="Search country">
                                    <div id="group-country-list" class="country-list"></div>
                                    <div id="group-selected-country" class="selected-country" style="display: none;">
                                        <span id="group-selected-flag" class="country-flag"></span>
                                        <span id="group-selected-name"></span>
                                        <span class="country-remove">√ó</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Deal Settings Tab -->
                <div class="tab-content" id="group-deal">
                    <div class="form-check">
                        <input type="checkbox" id="apply-deal" class="form-check-input">
                        <label for="apply-deal">Apply Deal Settings by Group?</label>
                    </div>

                    <div id="deal-details" style="display: none;">
                        <div class="form-group">
                            <label for="deal-type">Deal Type</label>
                            <select id="deal-type" class="form-control">
                                <option value="revshare">Rev Share</option>
                                <option value="cpa">CPA</option>
                                <option value="hybrid">Hybrid</option>
                                <option value="flatfee">Flat Fee</option>
                                <option value="other">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deal-description">Deal Description</label>
                            <textarea id="deal-description" class="form-control" rows="4" placeholder="Enter deal description"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background-color: #6c757d;">Cancel</button>
                <button class="btn" id="save-group">Save Group</button>
            </div>
        </div>
    </div>

    <!-- Bookmaker Modal -->
    <div id="bookmakerModal" class="modal">
        <div class="modal-content bookmaker-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Bookmaker</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="bookmaker-settings">Bookmaker Settings</div>
                    <div class="tab" data-tab="bookmaker-account">Bookmaker Account Settings</div>
                    <div class="tab" data-tab="bookmaker-deal">Bookmaker Deal Settings</div>
                </div>

                <!-- Bookmaker Settings Tab -->
                <div class="tab-content active" id="bookmaker-settings">
                    <div class="form-group">
                        <label for="bookmaker-group">Bookmaker Group</label>
                        <select id="bookmaker-group" class="form-control">
                            <option value="">Select a group</option>
                            <!-- Groups will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookmaker-status">Bookmaker Status</label>
                        <select id="bookmaker-status" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookmaker-name">Bookmaker Name</label>
                        <input type="text" id="bookmaker-name" class="form-control" placeholder="Enter bookmaker name">
                    </div>
                    <div class="form-group">
                        <label for="bookmaker-logo">Bookmaker Logo</label>
                        <input type="file" id="bookmaker-logo" class="form-control" accept="image/*">
                        <div id="bookmaker-logo-preview" class="image-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="bookmaker-affiliate-url">Bookmaker Affiliate URL</label>
                        <input type="url" id="bookmaker-affiliate-url" class="form-control" placeholder="Enter bookmaker affiliate URL">
                    </div>
                    <div class="form-group">
                        <label for="bookmaker-geographies">Geographies</label>
                        <div class="country-selector">
                            <input type="text" id="bookmaker-geography-search" class="country-search" placeholder="Search countries">
                            <div id="bookmaker-geography-list" class="geography-list"></div>
                        </div>
                        <div class="selected-geographies" id="selected-geographies">
                            <!-- Selected countries will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Bookmaker Account Settings Tab -->
                <div class="tab-content" id="bookmaker-account">
                    <div class="form-group">
                        <button type="button" id="add-account" class="btn" style="margin-bottom: 15px;">Add Account</button>
                    </div>

                    <div id="accounts-container">
                        <!-- Accounts will be added here dynamically -->
                    </div>
                </div>
                
                <!-- Bookmaker Deal Settings Tab -->
                <div class="tab-content" id="bookmaker-deal">
                    <div class="form-group">
                        <p><strong>Deal Management:</strong> Os dados de Deal Type e Deal Description podem ser definidos por Account e opcionalmente por Geography.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="bookmaker-deal-type">Default Deal Type</label>
                        <select id="bookmaker-deal-type" class="form-control">
                            <option value="revshare">Rev Share</option>
                            <option value="cpa">CPA</option>
                            <option value="hybrid">Hybrid</option>
                            <option value="flatfee">Flat Fee</option>
                            <option value="other">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookmaker-deal-description">Default Deal Description</label>
                        <textarea id="bookmaker-deal-description" class="form-control" rows="4" placeholder="Enter deal description"></textarea>
                    </div>
                    
                    <div id="deals-by-account-container">
                        <h4>Deals por Account</h4>
                        <div id="account-deals-list" style="margin-top: 15px;">
                            <p><i>Nenhuma Account criada ainda. Adicione Accounts na aba "Bookmaker Account Settings"</i></p>
                        </div>
                    </div>

                    <div id="account-form" style="display: none; border: 1px solid #e0e0e0; padding: 15px; margin-top: 15px; border-radius: 4px;">
                        <div class="form-group">
                            <label for="bookmaker-account-owner">Owner</label>
                            <select id="bookmaker-account-owner" class="form-control">
                                <option value="">Select an owner</option>
                                <!-- Owners will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-status">Account Status</label>
                            <select id="account-status" class="form-control">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bookmaker-account-username">Username/Email</label>
                            <input type="text" id="bookmaker-account-username" class="form-control" placeholder="Enter username or email">
                        </div>
                        <div class="form-group">
                            <label for="bookmaker-account-password">Password</label>
                            <input type="password" id="bookmaker-account-password" class="form-control" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label for="account-geographies">Associated Geographies</label>
                            <div class="country-selector">
                                <input type="text" id="account-geography-search" class="country-search" placeholder="Search countries">
                                <div id="account-geography-list" class="geography-list"></div>
                            </div>
                            <div class="selected-geographies" id="account-selected-geographies">
                                <!-- Selected countries will appear here -->
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <button type="button" id="save-account" class="btn">Save Account</button>
                            <button type="button" id="cancel-account" class="btn" style="background-color: #6c757d; margin-left: 10px;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background-color: #6c757d;">Cancel</button>
                <button class="btn" id="save-bookmaker">Save Bookmaker</button>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="owner-modal.css">
    <link rel="stylesheet" href="group-modal.css">
    <link rel="stylesheet" href="bookmaker-modal.css">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get country data from countries.js
            let countriesData = [];
            // Array para armazenar owners registrados
            let ownersData = [];
            // Array para armazenar groups registrados
            let groupsData = [];
            // Array para armazenar bookmakers registrados
            let bookmakersData = [];
            // Array para armazenar geographies selecionadas
            let selectedGeographies = [];

            // Try to import countries first
            // Load the countries.js file as a regular script
            const countriesScript = document.createElement('script');
            countriesScript.src = './countries.js';
            countriesScript.onload = function() {
                // Access the countries through the global variable
                if (window.countriesModule && window.countriesModule.countries) {
                    countriesData = window.countriesModule.countries;
                    initCountrySelectors();
                    initGeographySelector();
                } else {
                    console.error("Countries module not properly loaded");
                    fetchCountries();
                }
            };
            countriesScript.onerror = function() {
                console.error("Error loading countries script");
                fetchCountries();
            };
            document.head.appendChild(countriesScript);

            function fetchCountries() {
                // Fallback method to get countries
                fetch('./countries.js')
                    .then(response => response.text())
                    .then(text => {
                        // Extract the countries array from the JS file content
                        try {
                            const startIndex = text.indexOf('const countries = [');
                            const endIndex = text.indexOf('module.exports');
                            if (startIndex !== -1 && endIndex !== -1) {
                                const countriesStr = text.substring(startIndex, endIndex);
                                // Using Function constructor to safely evaluate the array
                                const getCountries = new Function('return ' + countriesStr.replace('const countries = ', '').trim().slice(0, -1));
                                countriesData = getCountries();
                                initCountrySelectors();
                                initGeographySelector();
                            }
                        } catch (error) {
                            console.error("Error parsing countries:", error);
                        }
                    })
                    .catch(error => console.error("Error fetching countries:", error));
            }

            // OWNER MODAL FUNCTIONALITY
            const ownerModal = document.getElementById('ownerModal');
            const ownerCloseBtn = ownerModal.querySelector('.modal-close');
            const ownerCancelBtn = ownerModal.querySelector('.modal-footer .btn:first-child');

            // Open owner modal when Add Owner button is clicked
            document.getElementById('addOwner').addEventListener('click', function() {
                ownerModal.classList.add('active');
            });

            // Close modal when close button or cancel is clicked
            ownerCloseBtn.addEventListener('click', function() {
                closeOwnerModal();
            });
            ownerCancelBtn.addEventListener('click', function() {
                closeOwnerModal();
            });

            function closeOwnerModal() {
                ownerModal.classList.remove('active');
                resetOwnerForm();
            }

            // Toggle billing details based on checkbox
            const applyBillingCheckbox = document.getElementById('apply-billing');
            const billingDetailsSection = document.getElementById('billing-details');

            applyBillingCheckbox.addEventListener('change', function() {
                billingDetailsSection.style.display = this.checked ? 'block' : 'none';
            });

            // Logo preview functionality for owner
            const ownerLogoInput = document.getElementById('owner-logo');
            const logoPreview = document.getElementById('logo-preview');

            ownerLogoInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        logoPreview.innerHTML = `
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 150px;">
                            <button type="button" id="remove-logo" style="display: block; margin-top: 5px;" class="btn btn-sm btn-delete">Remove</button>
                        `;

                        document.getElementById('remove-logo').addEventListener('click', function() {
                            ownerLogoInput.value = '';
                            logoPreview.innerHTML = '';
                        });
                    };

                    reader.readAsDataURL(file);
                }
            });

            // Function to initialize both country selectors (owner and group)
            function initCountrySelectors() {
                // Initialize owner country selector
                initCountrySelector('country-search', 'country-list', 'selected-country', 'selected-flag', 'selected-name');

                // Initialize group country selector
                initCountrySelector('group-country-search', 'group-country-list', 'group-selected-country', 'group-selected-flag', 'group-selected-name');
            }

            // Country selector functionality (reusable)
            function initCountrySelector(searchId, listId, selectedId, flagId, nameId) {
                const countrySearch = document.getElementById(searchId);
                const countryList = document.getElementById(listId);
                const selectedCountry = document.getElementById(selectedId);
                const selectedFlag = document.getElementById(flagId);
                const selectedName = document.getElementById(nameId);
                const countryRemove = selectedCountry.querySelector('.country-remove');

                if (!countrySearch || !countryList || !selectedCountry) {
                    console.error(`One of the country selector elements not found: ${searchId}, ${listId}, ${selectedId}`);
                    return;
                }

                // Populate country list
                function renderCountryList(filter = '') {
                    countryList.innerHTML = '';

                    const filteredCountries = filter 
                        ? countriesData.filter(c => c.name.toLowerCase().includes(filter.toLowerCase())) 
                        : countriesData;

                    filteredCountries.forEach(country => {
                        const item = document.createElement('div');
                        item.className = 'country-item';
                        item.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        `;

                        item.addEventListener('click', function() {
                            // Set selected country
                            selectedFlag.textContent = country.flag;
                            selectedName.textContent = country.name;
                            selectedCountry.style.display = 'flex';
                            countrySearch.value = '';
                            countryList.classList.remove('active');

                            // Store the country data
                            selectedCountry.dataset.code = country.code;
                        });

                        countryList.appendChild(item);
                    });
                }

                // Show country list on focus
                countrySearch.addEventListener('focus', function() {
                    countryList.classList.add('active');
                    renderCountryList();
                });

                // Filter countries on search
                countrySearch.addEventListener('input', function() {
                    renderCountryList(this.value);
                    countryList.classList.add('active');
                });

                // Remove selected country
                countryRemove.addEventListener('click', function() {
                    selectedCountry.style.display = 'none';
                    delete selectedCountry.dataset.code;
                });

                // Close country list when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.country-selector')) {
                        countryList.classList.remove('active');
                    }
                });

                // Initial render
                renderCountryList();
            }

            // Save owner
            document.getElementById('save-owner').addEventListener('click', function() {
                const ownerId = Date.now().toString(); // Generate a unique ID
                const ownerData = {
                    id: ownerId,
                    status: document.getElementById('owner-status').value,
                    name: document.getElementById('owner-name').value,
                    // Logo handling would typically involve uploading the file to a server
                    applyBilling: document.getElementById('apply-billing').checked
                };

                if (ownerData.applyBilling) {
                    ownerData.billing = {
                        name: document.getElementById('billing-name').value,
                        vat: document.getElementById('billing-vat').value,
                        address1: document.getElementById('billing-address1').value,
                        address2: document.getElementById('billing-address2').value,
                        city: document.getElementById('billing-city').value,
                        state: document.getElementById('billing-state').value,
                        zipCode: document.getElementById('billing-zipcode').value,
                        country: document.getElementById('selected-country').dataset.code
                    };
                }

                // Add to owners array
                ownersData.push(ownerData);

                // Update owner dropdown in group modal
                updateOwnerDropdown();

                console.log('Owner data:', ownerData);
                alert('Owner added successfully!');
                closeOwnerModal();
            });

            function resetOwnerForm() {
                // Reset form fields
                document.getElementById('owner-status').value = 'active';
                document.getElementById('owner-name').value = '';
                document.getElementById('owner-logo').value = '';
                document.getElementById('logo-preview').innerHTML = '';

                document.getElementById('apply-billing').checked = false;
                document.getElementById('billing-details').style.display = 'none';

                document.getElementById('billing-name').value = '';
                document.getElementById('billing-vat').value = '';
                document.getElementById('billing-address1').value = '';
                document.getElementById('billing-address2').value = '';
                document.getElementById('billing-city').value = '';
                document.getElementById('billing-state').value = '';
                document.getElementById('billing-zipcode').value = '';

                document.getElementById('country-search').value = '';
                document.getElementById('selected-country').style.display = 'none';
                delete document.getElementById('selected-country').dataset.code;

                // Reset to first tab
                ownerModal.querySelector('.tab[data-tab="owner-settings"]').click();
            }

            // Update the owner dropdown in the group modal
            function updateOwnerDropdown() {
                const ownerDropdown = document.getElementById('account-owner');
                if (!ownerDropdown) return;

                // Clear current options except the first one
                while (ownerDropdown.options.length > 1) {
                    ownerDropdown.remove(1);
                }

                // Add owners to dropdown
                ownersData.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner.id;
                    option.textContent = owner.name;
                    ownerDropdown.appendChild(option);
                });
            }

            // GROUP MODAL FUNCTIONALITY
            const groupModal = document.getElementById('groupModal');
            const groupCloseBtn = groupModal.querySelector('.modal-close');
            const groupCancelBtn = groupModal.querySelector('.modal-footer .btn:first-child');
            const groupSaveBtn = document.getElementById('save-group');

            // Open group modal when Add Group button is clicked
            document.getElementById('addGroup').addEventListener('click', function() {
                groupModal.classList.add('active');
                // Update owner dropdown when opening modal
                updateOwnerDropdown();
            });

            // Close modal when close button or cancel is clicked
            groupCloseBtn.addEventListener('click', function() {
                closeGroupModal();
            });
            groupCancelBtn.addEventListener('click', function() {
                closeGroupModal();
            });

            function closeGroupModal() {
                groupModal.classList.remove('active');
                resetGroupForm();
            }

            // Tab functionality for all modals
            const tabsContainers = document.querySelectorAll('.tabs');

            tabsContainers.forEach(container => {
                const tabs = container.querySelectorAll('.tab');
                // Find the parent modal
                const modal = container.closest('.modal');
                // Get all tab contents in this modal
                const tabContents = modal.querySelectorAll('.tab-content');

                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const target = this.getAttribute('data-tab');

                        // Remove active class from all tabs and contents within this modal
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));

                        // Add active class to clicked tab and corresponding content
                        this.classList.add('active');
                        modal.querySelector(`#${target}`).classList.add('active');
                    });
                });
            });

            // Logo preview functionality for group
            const groupLogoInput = document.getElementById('group-logo');
            const groupLogoPreview = document.getElementById('group-logo-preview');

            groupLogoInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        groupLogoPreview.innerHTML = `
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 150px;">
                            <button type="button" id="remove-group-logo" style="display: block; margin-top: 5px;" class="btn btn-sm btn-delete">Remove</button>
                        `;

                        document.getElementById('remove-group-logo').addEventListener('click', function() {
                            groupLogoInput.value = '';
                            groupLogoPreview.innerHTML = '';
                        });
                    };

                    reader.readAsDataURL(file);
                }
            });

            // Toggle account details
            const applyAccountCheckbox = document.getElementById('apply-account');
            const accountDetailsSection = document.getElementById('account-details');

            applyAccountCheckbox.addEventListener('change', function() {
                accountDetailsSection.style.display = this.checked ? 'block' : 'none';
            });
            
            // Atualizar os deals quando o usu√°rio muda para a aba de deals
            document.querySelector('.tab[data-tab="bookmaker-deal"]').addEventListener('click', function() {
                renderAccountDeals();
            });

            // Toggle group billing details
            const applyGroupBillingCheckbox = document.getElementById('apply-group-billing');
            const groupBillingDetailsSection = document.getElementById('group-billing-details');

            applyGroupBillingCheckbox.addEventListener('change', function() {
                groupBillingDetailsSection.style.display = this.checked ? 'block' : 'none';
            });

            // Toggle deal details
            const applyDealCheckbox = document.getElementById('apply-deal');
            const dealDetailsSection = document.getElementById('deal-details');

            applyDealCheckbox.addEventListener('change', function() {
                dealDetailsSection.style.display = this.checked ? 'block' : 'none';
            });

            // Save group
            groupSaveBtn.addEventListener('click', function() {
                const groupId = Date.now().toString(); // Generate a unique ID
                const groupData = {
                    id: groupId,
                    status: document.getElementById('group-status').value,
                    name: document.getElementById('group-name').value,
                    url: document.getElementById('group-url').value,
                    affiliateUrl: document.getElementById('group-affiliate-url').value
                };

                // Check if account settings are enabled
                if (document.getElementById('apply-account').checked) {
                    groupData.account = {
                        owner: document.getElementById('account-owner').value,
                        status: document.getElementById('account-status').value,
                        username: document.getElementById('account-username').value,
                        password: document.getElementById('account-password').value
                    };
                }

                // Check if billing settings are enabled
                if (document.getElementById('apply-group-billing').checked) {
                    groupData.billing = {
                        name: document.getElementById('group-billing-name').value,
                        vat: document.getElementById('group-billing-vat').value,
                        address1: document.getElementById('group-billing-address1').value,
                        address2: document.getElementById('group-billing-address2').value,
                        city: document.getElementById('group-billing-city').value,
                        state: document.getElementById('group-billing-state').value,
                        zipCode: document.getElementById('group-billing-zipcode').value,
                        country: document.getElementById('group-selected-country').dataset.code
                    };
                }

                // Check if deal settings are enabled
                if (document.getElementById('apply-deal').checked) {
                    groupData.deal = {
                        type: document.getElementById('deal-type').value,
                        description: document.getElementById('deal-description').value
                    };
                }

                // Add to groups array
                groupsData.push(groupData);

                // Update group dropdown in bookmaker modal
                updateGroupDropdown();

                console.log('Group data:', groupData);
                alert('Group added successfully!');
                closeGroupModal();
            });

            function resetGroupForm() {
                // Reset Group Settings tab
                document.getElementById('group-status').value = 'active';
                document.getElementById('group-name').value = '';
                document.getElementById('group-logo').value = '';
                document.getElementById('group-logo-preview').innerHTML = '';
                document.getElementById('group-url').value = '';
                document.getElementById('group-affiliate-url').value = '';

                // Reset Group Account Settings tab
                document.getElementById('apply-account').checked = false;
                document.getElementById('account-details').style.display = 'none';
                document.getElementById('account-owner').selectedIndex = 0;
                document.getElementById('account-status').value = 'active';
                document.getElementById('account-username').value = '';
                document.getElementById('account-password').value = '';

                // Reset Group Billing Settings tab
                document.getElementById('apply-group-billing').checked = false;
                document.getElementById('group-billing-details').style.display = 'none';
                document.getElementById('group-billing-name').value = '';
                document.getElementById('group-billing-vat').value = '';
                document.getElementById('group-billing-address1').value = '';
                document.getElementById('group-billing-address2').value = '';
                document.getElementById('group-billing-city').value = '';
                document.getElementById('group-billing-state').value = '';
                document.getElementById('group-billing-zipcode').value = '';
                document.getElementById('group-country-search').value = '';
                document.getElementById('group-selected-country').style.display = 'none';
                delete document.getElementById('group-selected-country').dataset.code;

                // Reset Group Deal Settings tab
                document.getElementById('apply-deal').checked = false;
                document.getElementById('deal-details').style.display = 'none';
                document.getElementById('deal-type').value = 'revshare';
                document.getElementById('deal-description').value = '';

                // Reset to first tab
                groupModal.querySelector('.tab[data-tab="group-settings"]').click();
            }

            // Update the group dropdown in the bookmaker modal
            function updateGroupDropdown() {
                const groupDropdown = document.getElementById('bookmaker-group');
                if (!groupDropdown) return;

                // Clear current options except the first one
                while (groupDropdown.options.length > 1) {
                    groupDropdown.remove(1);
                }

                // Add groups to dropdown
                groupsData.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    groupDropdown.appendChild(option);
                });
            }

            // BOOKMAKER MODAL FUNCTIONALITY
            const bookmakerModal = document.getElementById('bookmakerModal');
            const bookmakerCloseBtn = bookmakerModal.querySelector('.modal-close');
            const bookmakerCancelBtn = bookmakerModal.querySelector('.modal-footer .btn:first-child');
            const bookmakerSaveBtn = document.getElementById('save-bookmaker');

            // Open bookmaker modal when Add Bookmaker button is clicked
            document.getElementById('addBookmaker').addEventListener('click', function() {
                bookmakerModal.classList.add('active');
                // Update group dropdown when opening modal
                updateGroupDropdown();
            });

            // Close modal when close button or cancel is clicked
            bookmakerCloseBtn.addEventListener('click', function() {
                closeBookmakerModal();
            });
            bookmakerCancelBtn.addEventListener('click', function() {
                closeBookmakerModal();
            });

            function closeBookmakerModal() {
                bookmakerModal.classList.remove('active');
                resetBookmakerForm();
            }

            // Logo preview functionality for bookmaker
            const bookmakerLogoInput = document.getElementById('bookmaker-logo');
            const bookmakerLogoPreview = document.getElementById('bookmaker-logo-preview');

            bookmakerLogoInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        bookmakerLogoPreview.innerHTML = `
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 150px;">
                            <button type="button" id="remove-bookmaker-logo" style="display: block; margin-top: 5px;" class="btn btn-sm btn-delete">Remove</button>
                        `;

                        document.getElementById('remove-bookmaker-logo').addEventListener('click', function() {
                            bookmakerLogoInput.value = '';
                            bookmakerLogoPreview.innerHTML = '';
                        });
                    };

                    reader.readAsDataURL(file);
                }
            });

            // Initialize geography selector for multiple country selection
            function initGeographySelector() {
                const geographySearch = document.getElementById('bookmaker-geography-search');
                const geographyList = document.getElementById('bookmaker-geography-list');
                const selectedGeographiesContainer = document.getElementById('selected-geographies');

                if (!geographySearch || !geographyList || !selectedGeographiesContainer) {
                    console.error("Geography selector elements not found");
                    return;
                }

                // Populate country list for multiple selection
                function renderGeographyList(filter = '') {
                    geographyList.innerHTML = '';

                    const filteredCountries = filter 
                        ? countriesData.filter(c => c.name.toLowerCase().includes(filter.toLowerCase())) 
                        : countriesData;

                    filteredCountries.forEach(country => {
                        // Skip if already selected
                        if (selectedGeographies.some(selected => selected.code === country.code)) {
                            return;
                        }

                        const item = document.createElement('div');
                        item.className = 'geography-item';
                        item.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        `;

                        item.addEventListener('click', function() {
                            // Add to selected geographies
                            addGeography(country);

                            // Clear search and hide list
                            geographySearch.value = '';
                            geographyList.classList.remove('active');

                            // Re-render geography list to exclude selected items
                            renderGeographyList();
                        });

                        geographyList.appendChild(item);
                    });
                }

                // Add a country to selected geographies
                function addGeography(country) {
                    // Check if already selected
                    if (selectedGeographies.some(selected => selected.code === country.code)) {
                        return;
                    }

                    // Add to selected array
                    selectedGeographies.push(country);

                    // Add to UI
                    renderSelectedGeographies();
                }

                // Remove a country from selected geographies
                function removeGeography(countryCode) {
                    selectedGeographies = selectedGeographies.filter(country => country.code !== countryCode);
                    renderSelectedGeographies();
                    // Re-render geography list since a country was removed
                    renderGeographyList(geographySearch.value);
                }

                // Render selected geographies in the UI
                function renderSelectedGeographies() {
                    selectedGeographiesContainer.innerHTML = '';

                    if (selectedGeographies.length === 0) {
                        selectedGeographiesContainer.innerHTML = '<i>No countries selected</i>';
                        return;
                    }

                    selectedGeographies.forEach(country => {
                        const tag = document.createElement('div');
                        tag.className = 'geography-tag';
                        tag.dataset.code = country.code;
                        tag.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                            <span class="remove-geography">√ó</span>
                        `;

                        tag.querySelector('.remove-geography').addEventListener('click', function() {
                            removeGeography(country.code);
                        });

                        selectedGeographiesContainer.appendChild(tag);
                    });
                }

                // Show geography list on focus
                geographySearch.addEventListener('focus', function() {
                    geographyList.classList.add('active');
                    renderGeographyList();
                });

                // Filter countries on search
                geographySearch.addEventListener('input', function() {
                    renderGeographyList(this.value);
                    geographyList.classList.add('active');
                });

                // Close geography list when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.country-selector')) {
                        geographyList.classList.remove('active');
                    }
                });

                // Initial render
                renderSelectedGeographies();
                renderGeographyList();
            }

            // Bookmaker Account Settings functionality
            const addAccountBtn = document.getElementById('add-account');
            const accountForm = document.getElementById('account-form');
            const accountsContainer = document.getElementById('accounts-container');
            const saveAccountBtn = document.getElementById('save-account');
            const cancelAccountBtn = document.getElementById('cancel-account');

            // Array to store the accounts for this bookmaker
            let bookmakerAccounts = [];
            let selectedAccountGeographies = [];
            let currentEditIndex = -1;

            // Add account button click
            addAccountBtn.addEventListener('click', function() {
                showAccountForm();
                currentEditIndex = -1;
                // Update owner dropdown in the account form
                updateAccountOwnerDropdown();
            });

            // Cancel account button click
            cancelAccountBtn.addEventListener('click', function() {
                hideAccountForm();
            });

            // Save account button click
            saveAccountBtn.addEventListener('click', function() {
                const ownerSelect = document.getElementById('bookmaker-account-owner');
                const ownerId = ownerSelect.value;
                const ownerName = ownerSelect.options[ownerSelect.selectedIndex].text;

                // Obtenha os valores corretos dos campos de formul√°rio
                const statusField = document.getElementById('account-status');
                const usernameField = document.getElementById('bookmaker-account-username');
                const passwordField = document.getElementById('bookmaker-account-password');

                const accountData = {
                    id: Date.now().toString(),
                    owner: {
                        id: ownerId,
                        name: ownerName
                    },
                    status: statusField.value,
                    username: usernameField.value,
                    password: passwordField.value,
                    geographies: selectedAccountGeographies.map(country => ({
                        code: country.code,
                        name: country.name,
                        flag: country.flag,
                        // Inicialmente, cada geografia usa o deal padr√£o da conta
                        dealType: null,
                        dealDescription: null
                    })),
                    // Deal padr√£o da conta
                    dealType: null,
                    dealDescription: null
                };

                console.log("Valores dos campos:", {
                    username: usernameField.value,
                    password: passwordField.value
                });

                // Validate
                if (!accountData.owner.id) {
                    alert('Please select an owner');
                    return;
                }

                if (!accountData.username) {
                    alert('Please enter a username/email');
                    return;
                }

                if (!accountData.password) {
                    alert('Please enter a password');
                    return;
                }

                if (currentEditIndex >= 0) {
                    // Update existing account
                    bookmakerAccounts[currentEditIndex] = accountData;
                } else {
                    // Add new account
                    bookmakerAccounts.push(accountData);
                }

                // Update UI
                renderBookmakerAccounts();
                hideAccountForm();
                resetAccountForm();
            });

            // Function to show the account form
            function showAccountForm() {
                accountForm.style.display = 'block';
                // Copy selected geographies to account geographies for selection
                updateAccountGeographies();
            }

            // Function to hide the account form
            function hideAccountForm() {
                accountForm.style.display = 'none';
            }

            // Function to render selected account geographies in the UI
            function renderSelectedAccountGeographies() {
                const selectedGeographiesContainer = document.getElementById('account-selected-geographies');
                
                if (!selectedGeographiesContainer) return;
                
                selectedGeographiesContainer.innerHTML = '';

                if (selectedAccountGeographies.length === 0) {
                    selectedGeographiesContainer.innerHTML = '<i>No countries selected</i>';
                    return;
                }

                selectedAccountGeographies.forEach(country => {
                    const tag = document.createElement('div');
                    tag.className = 'geography-tag';
                    tag.dataset.code = country.code;
                    tag.innerHTML = `
                        <span class="country-flag">${country.flag}</span>
                        <span>${country.name}</span>
                        <span class="remove-geography">√ó</span>
                    `;

                    tag.querySelector('.remove-geography').addEventListener('click', function() {
                        selectedAccountGeographies = selectedAccountGeographies.filter(c => c.code !== country.code);
                        renderSelectedAccountGeographies();
                    });

                    selectedGeographiesContainer.appendChild(tag);
                });
            }
            
            // Atualiza os tabs para manter deals atualizados
            bookmakerModal.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    if (tabId === 'bookmaker-deal') {
                        renderAccountDeals();
                    }
                });
            });
            
            // Function to reset the account form
            function resetAccountForm() {
                document.getElementById('bookmaker-account-owner').selectedIndex = 0;
                document.getElementById('account-status').value = 'active';
                document.getElementById('bookmaker-account-username').value = '';
                document.getElementById('bookmaker-account-password').value = '';
                selectedAccountGeographies = [];
                renderSelectedAccountGeographies();
            }

            // Function to render the bookmaker accounts in the UI
            function renderBookmakerAccounts() {
                accountsContainer.innerHTML = '';

                if (bookmakerAccounts.length === 0) {
                    accountsContainer.innerHTML = '<p><i>No accounts added yet</i></p>';
                    return;
                }

                bookmakerAccounts.forEach((account, index) => {
                    const accountEl = document.createElement('div');
                    accountEl.className = 'account-item';
                    accountEl.style.border = '1px solid #e0e0e0';
                    accountEl.style.borderRadius = '4px';
                    accountEl.style.padding = '10px';
                    accountEl.style.marginBottom = '10px';

                    const geographiesText = account.geographies.length > 0 
                        ? account.geographies.map(g => `${g.flag} ${g.name}`).join(', ')
                        : 'No geographies selected';
                    
                    const dealText = account.dealType 
                        ? `<span style="color: #28a745;">Deal definido</span>` 
                        : `<span style="color: #dc3545;">Deal n√£o definido</span>`;

                    accountEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${account.username}</strong> (${account.owner.name})
                                <div style="font-size: 0.9em; color: #666;">Status: ${account.status}</div>
                                <div style="font-size: 0.9em; margin-top: 5px;">
                                    <strong>Geographies:</strong> ${geographiesText}
                                </div>
                                <div style="font-size: 0.9em; margin-top: 5px;">
                                    <strong>Deal:</strong> ${dealText}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-edit edit-account" data-index="${index}" style="padding: 3px 8px; font-size: 12px;">Edit</button>
                                <button class="btn btn-delete delete-account" data-index="${index}" style="padding: 3px 8px; font-size: 12px;">Delete</button>
                            </div>
                        </div>
                    `;

                    accountsContainer.appendChild(accountEl);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-account').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        editAccount(index);
                    });
                });

                document.querySelectorAll('.delete-account').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        deleteAccount(index);
                    });
                });
            }

            // Function to edit an account
            function editAccount(index) {
                const account = bookmakerAccounts[index];
                currentEditIndex = index;

                // Update owner dropdown
                updateAccountOwnerDropdown();

                // Set form values
                const ownerSelect = document.getElementById('bookmaker-account-owner');
                for (let i = 0; i < ownerSelect.options.length; i++) {
                    if (ownerSelect.options[i].value === account.owner.id) {
                        ownerSelect.selectedIndex = i;
                        break;
                    }
                }

                document.getElementById('account-status').value = account.status;
                document.getElementById('bookmaker-account-username').value = account.username;
                document.getElementById('bookmaker-account-password').value = account.password;

                // Set selected geographies
                selectedAccountGeographies = account.geographies.map(geo => {
                    const country = countriesData.find(c => c.code === geo.code);
                    return country || geo;
                });

                renderSelectedAccountGeographies();
                showAccountForm();
            }

            // Function to delete an account
            function deleteAccount(index) {
                if (confirm('Are you sure you want to delete this account?')) {
                    bookmakerAccounts.splice(index, 1);
                    renderBookmakerAccounts();
                }
            }

            // Update the owner dropdown in the account form
            function updateAccountOwnerDropdown() {
                const ownerDropdown = document.getElementById('bookmaker-account-owner');
                if (!ownerDropdown) return;

                // Clear current options except the first one
                while (ownerDropdown.options.length > 1) {
                    ownerDropdown.remove(1);
                }

                // Add owners to dropdown
                ownersData.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner.id;
                    option.textContent = owner.name;
                    ownerDropdown.appendChild(option);
                });
            }

            // Initialize account geography selector
            function updateAccountGeographies() {
                // Initialize with the bookmaker geographies
                initAccountGeographySelector();
            }

            // Initialize geography selector for account geographies
            function initAccountGeographySelector() {
                const geographySearch = document.getElementById('account-geography-search');
                const geographyList = document.getElementById('account-geography-list');
                const selectedGeographiesContainer = document.getElementById('account-selected-geographies');

                if (!geographySearch || !geographyList || !selectedGeographiesContainer) {
                    console.error("Account geography selector elements not found");
                    return;
                }

                // Populate country list for multiple selection with only the countries selected in bookmaker settings
                function renderAccountGeographyList(filter = '') {
                    geographyList.innerHTML = '';

                    // Filter from the main bookmaker geographies
                    const availableGeographies = selectedGeographies.filter(country => 
                        !selectedAccountGeographies.some(selected => selected.code === country.code)
                    );

                    const filteredCountries = filter 
                        ? availableGeographies.filter(c => c.name.toLowerCase().includes(filter.toLowerCase())) 
                        : availableGeographies;

                    filteredCountries.forEach(country => {
                        const item = document.createElement('div');
                        item.className = 'geography-item';
                        item.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        `;

                        item.addEventListener('click', function() {
                            // Add to selected account geographies
                            addAccountGeography(country);

                            // Clear search and hide list
                            geographySearch.value = '';
                            geographyList.classList.remove('active');

                            // Re-render geography list
                            renderAccountGeographyList();
                        });

                        geographyList.appendChild(item);
                    });
                }

                // Add a country to selected account geographies
                function addAccountGeography(country) {
                    // Check if already selected
                    if (selectedAccountGeographies.some(selected => selected.code === country.code)) {
                        return;
                    }

                    // Add to selected array
                    selectedAccountGeographies.push(country);

                    // Add to UI
                    renderSelectedAccountGeographies();
                }

                // Remove a country from selected account geographies
                function removeAccountGeography(countryCode) {
                    selectedAccountGeographies = selectedAccountGeographies.filter(country => country.code !== countryCode);
                    renderSelectedAccountGeographies();
                    renderAccountGeographyList(geographySearch.value);
                }

                // Handle removing geography specifically within this context
                function removeAccountGeography(countryCode) {
                    selectedAccountGeographies = selectedAccountGeographies.filter(country => country.code !== countryCode);
                    renderSelectedAccountGeographies();
                    renderAccountGeographyList(geographySearch.value);
                }
                
                // Use the global renderSelectedAccountGeographies function

                // Show geography list on focus
                geographySearch.addEventListener('focus', function() {
                    geographyList.classList.add('active');
                    renderAccountGeographyList();
                });

                // Filter countries on search
                geographySearch.addEventListener('input', function() {
                    renderAccountGeographyList(this.value);
                    geographyList.classList.add('active');
                });

                // Close geography list when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('#account-geography-list') && !e.target.closest('#account-geography-search')) {
                        geographyList.classList.remove('active');
                    }
                });

                // Initial render
                renderSelectedAccountGeographies();
                renderAccountGeographyList();
            }

            // Initialize accounts list
            renderBookmakerAccounts();

            // Fun√ß√£o para renderizar os deals por account
            function renderAccountDeals() {
                const accountDealsList = document.getElementById('account-deals-list');
                
                if (bookmakerAccounts.length === 0) {
                    accountDealsList.innerHTML = '<p><i>Nenhuma Account criada ainda. Adicione Accounts na aba "Bookmaker Account Settings"</i></p>';
                    return;
                }
                
                accountDealsList.innerHTML = '';
                
                bookmakerAccounts.forEach((account, accountIndex) => {
                    const accountDealContainer = document.createElement('div');
                    accountDealContainer.className = 'account-deal-item';
                    accountDealContainer.style.border = '1px solid #e0e0e0';
                    accountDealContainer.style.borderRadius = '4px';
                    accountDealContainer.style.padding = '15px';
                    accountDealContainer.style.marginBottom = '15px';
                    
                    // Header com informa√ß√µes da conta
                    const accountHeader = document.createElement('div');
                    accountHeader.innerHTML = `
                        <h5>${account.username} (${account.owner.name})</h5>
                        <div style="margin-bottom: 10px;">
                            <strong>Status:</strong> ${account.status}
                        </div>
                    `;
                    accountDealContainer.appendChild(accountHeader);
                    
                    // Deal da Account
                    const accountDealSection = document.createElement('div');
                    accountDealSection.style.marginBottom = '15px';
                    accountDealSection.style.padding = '10px';
                    accountDealSection.style.backgroundColor = '#f9f9f9';
                    
                    accountDealSection.innerHTML = `
                        <h6>Deal da Account</h6>
                        <div class="form-group">
                            <label for="account-deal-type-${accountIndex}">Deal Type</label>
                            <select id="account-deal-type-${accountIndex}" class="form-control" data-account-index="${accountIndex}">
                                <option value="revshare" ${account.dealType === 'revshare' ? 'selected' : ''}>Rev Share</option>
                                <option value="cpa" ${account.dealType === 'cpa' ? 'selected' : ''}>CPA</option>
                                <option value="hybrid" ${account.dealType === 'hybrid' ? 'selected' : ''}>Hybrid</option>
                                <option value="flatfee" ${account.dealType === 'flatfee' ? 'selected' : ''}>Flat Fee</option>
                                <option value="other" ${account.dealType === 'other' ? 'selected' : ''}>Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-deal-description-${accountIndex}">Deal Description</label>
                            <textarea id="account-deal-description-${accountIndex}" class="form-control" rows="3" placeholder="Enter deal description" data-account-index="${accountIndex}">${account.dealDescription || ''}</textarea>
                        </div>
                    `;
                    accountDealContainer.appendChild(accountDealSection);
                    
                    // Toggle para mostrar deals por geografia
                    if (account.geographies.length > 0) {
                        const geoToggleSection = document.createElement('div');
                        geoToggleSection.style.marginBottom = '10px';
                        geoToggleSection.innerHTML = `
                            <div class="form-check">
                                <input type="checkbox" id="use-geo-deals-${accountIndex}" class="form-check-input" ${account.geographies.some(geo => geo.dealType !== null) ? 'checked' : ''}>
                                <label for="use-geo-deals-${accountIndex}">Definir Deals espec√≠ficos por Geografia</label>
                            </div>
                        `;
                        accountDealContainer.appendChild(geoToggleSection);
                        
                        // Container para deals por geografia
                        const geoDealsContainer = document.createElement('div');
                        geoDealsContainer.id = `geo-deals-container-${accountIndex}`;
                        geoDealsContainer.style.marginTop = '10px';
                        geoDealsContainer.style.display = account.geographies.some(geo => geo.dealType !== null) ? 'block' : 'none';
                        
                        // Deals para cada geografia
                        account.geographies.forEach((geo, geoIndex) => {
                            const geoDealItem = document.createElement('div');
                            geoDealItem.style.marginBottom = '15px';
                            geoDealItem.style.padding = '10px';
                            geoDealItem.style.backgroundColor = '#f5f5f5';
                            geoDealItem.style.border = '1px solid #ddd';
                            geoDealItem.style.borderRadius = '4px';
                            
                            geoDealItem.innerHTML = `
                                <h6>${geo.flag} ${geo.name}</h6>
                                <div class="form-group">
                                    <label for="geo-deal-type-${accountIndex}-${geoIndex}">Deal Type</label>
                                    <select id="geo-deal-type-${accountIndex}-${geoIndex}" class="form-control" data-account-index="${accountIndex}" data-geo-index="${geoIndex}">
                                        <option value="revshare" ${geo.dealType === 'revshare' ? 'selected' : ''}>Rev Share</option>
                                        <option value="cpa" ${geo.dealType === 'cpa' ? 'selected' : ''}>CPA</option>
                                        <option value="hybrid" ${geo.dealType === 'hybrid' ? 'selected' : ''}>Hybrid</option>
                                        <option value="flatfee" ${geo.dealType === 'flatfee' ? 'selected' : ''}>Flat Fee</option>
                                        <option value="other" ${geo.dealType === 'other' ? 'selected' : ''}>Outro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="geo-deal-description-${accountIndex}-${geoIndex}">Deal Description</label>
                                    <textarea id="geo-deal-description-${accountIndex}-${geoIndex}" class="form-control" rows="3" placeholder="Enter deal description" data-account-index="${accountIndex}" data-geo-index="${geoIndex}">${geo.dealDescription || ''}</textarea>
                                </div>
                            `;
                            
                            geoDealsContainer.appendChild(geoDealItem);
                        });
                        
                        accountDealContainer.appendChild(geoDealsContainer);
                        
                        // Adiciona event listener para o checkbox de toggle
                        accountDealContainer.querySelector(`#use-geo-deals-${accountIndex}`).addEventListener('change', function() {
                            const geoDealsContainer = document.getElementById(`geo-deals-container-${accountIndex}`);
                            geoDealsContainer.style.display = this.checked ? 'block' : 'none';
                            
                            // Se desativar, limpa os deals espec√≠ficos das geografias
                            if (!this.checked) {
                                account.geographies.forEach(geo => {
                                    geo.dealType = null;
                                    geo.dealDescription = null;
                                });
                            } else {
                                // Se ativar, inicializa cada geografia com o deal da conta
                                account.geographies.forEach(geo => {
                                    geo.dealType = account.dealType;
                                    geo.dealDescription = account.dealDescription;
                                });
                            }
                        });
                    }
                    
                    accountDealsList.appendChild(accountDealContainer);
                });
                
                // Adiciona event listeners para os campos de deal da account
                bookmakerAccounts.forEach((_, accountIndex) => {
                    const dealTypeSelect = document.getElementById(`account-deal-type-${accountIndex}`);
                    const dealDescriptionTextarea = document.getElementById(`account-deal-description-${accountIndex}`);
                    
                    if (dealTypeSelect && dealDescriptionTextarea) {
                        dealTypeSelect.addEventListener('change', function() {
                            const accountIndex = parseInt(this.getAttribute('data-account-index'));
                            bookmakerAccounts[accountIndex].dealType = this.value;
                            
                            // Se n√£o estiver usando deals espec√≠ficos por geografia,
                            // atualiza tamb√©m os deals das geografias
                            const useGeoDeals = document.getElementById(`use-geo-deals-${accountIndex}`);
                            if (!useGeoDeals || !useGeoDeals.checked) {
                                bookmakerAccounts[accountIndex].geographies.forEach(geo => {
                                    geo.dealType = null;
                                });
                            }
                        });
                        
                        dealDescriptionTextarea.addEventListener('input', function() {
                            const accountIndex = parseInt(this.getAttribute('data-account-index'));
                            bookmakerAccounts[accountIndex].dealDescription = this.value;
                            
                            // Se n√£o estiver usando deals espec√≠ficos por geografia,
                            // atualiza tamb√©m os deals das geografias
                            const useGeoDeals = document.getElementById(`use-geo-deals-${accountIndex}`);
                            if (!useGeoDeals || !useGeoDeals.checked) {
                                bookmakerAccounts[accountIndex].geographies.forEach(geo => {
                                    geo.dealDescription = null;
                                });
                            }
                        });
                    }
                });
                
                // Adiciona event listeners para os campos de deal das geografias
                bookmakerAccounts.forEach((account, accountIndex) => {
                    account.geographies.forEach((geo, geoIndex) => {
                        const geoDealTypeSelect = document.getElementById(`geo-deal-type-${accountIndex}-${geoIndex}`);
                        const geoDealDescriptionTextarea = document.getElementById(`geo-deal-description-${accountIndex}-${geoIndex}`);
                        
                        if (geoDealTypeSelect && geoDealDescriptionTextarea) {
                            geoDealTypeSelect.addEventListener('change', function() {
                                const accountIndex = parseInt(this.getAttribute('data-account-index'));
                                const geoIndex = parseInt(this.getAttribute('data-geo-index'));
                                bookmakerAccounts[accountIndex].geographies[geoIndex].dealType = this.value;
                            });
                            
                            geoDealDescriptionTextarea.addEventListener('input', function() {
                                const accountIndex = parseInt(this.getAttribute('data-account-index'));
                                const geoIndex = parseInt(this.getAttribute('data-geo-index'));
                                bookmakerAccounts[accountIndex].geographies[geoIndex].dealDescription = this.value;
                            });
                        }
                    });
                });
            }
            
            // Save bookmaker
            bookmakerSaveBtn.addEventListener('click', function() {
                const bookmakerId = Date.now().toString(); // Generate a unique ID
                const bookmakerData = {
                    id: bookmakerId,
                    group: document.getElementById('bookmaker-group').value,
                    status: document.getElementById('bookmaker-status').value,
                    name: document.getElementById('bookmaker-name').value,
                    affiliateUrl: document.getElementById('bookmaker-affiliate-url').value,
                    geographies: selectedGeographies.map(country => ({
                        code: country.code,
                        name: country.name,
                        flag: country.flag
                    })),
                    accounts: bookmakerAccounts,
                    defaultDeal: {
                        type: document.getElementById('bookmaker-deal-type').value,
                        description: document.getElementById('bookmaker-deal-description').value
                    }
                };
                
                // Garante que todos os accounts t√™m deals definidos (ou na conta ou em cada geografia)
                bookmakerData.accounts.forEach(account => {
                    // Se a conta n√£o tem deal definido, usa-se o deal default do bookmaker
                    if (!account.dealType || !account.dealDescription) {
                        account.dealType = account.dealType || bookmakerData.defaultDeal.type;
                        account.dealDescription = account.dealDescription || bookmakerData.defaultDeal.description;
                    }
                    
                    // Para cada geografia que n√£o tem deal espec√≠fico, usa o deal da conta
                    account.geographies.forEach(geo => {
                        if (!geo.dealType || !geo.dealDescription) {
                            geo.dealType = account.dealType;
                            geo.dealDescription = account.dealDescription;
                        }
                    });
                });

                // Validar que todos os accounts t√™m deals definidos
                let dealsMissing = false;
                let missingDealAccounts = [];
                
                bookmakerAccounts.forEach(account => {
                    // Verifica se o deal da conta est√° definido
                    const hasAccountDeal = account.dealType && account.dealDescription;
                    
                    if (!hasAccountDeal) {
                        // Se n√£o tem deal na conta, verifica se todas as geografias t√™m deals espec√≠ficos
                        const hasGeoDeals = account.geographies.every(geo => geo.dealType && geo.dealDescription);
                        
                        if (!hasGeoDeals) {
                            dealsMissing = true;
                            missingDealAccounts.push(account.username);
                        }
                    }
                });
                
                if (dealsMissing) {
                    alert(`Os seguintes accounts n√£o t√™m deals completos: ${missingDealAccounts.join(', ')}. Por favor, defina Deal Type e Deal Description para cada account ou para cada geografia associada.`);
                    // Muda para a aba de deals
                    bookmakerModal.querySelector('.tab[data-tab="bookmaker-deal"]').click();
                    return;
                }

                // Add to bookmakers array
                bookmakersData.push(bookmakerData);

                console.log('Bookmaker data:', bookmakerData);
                alert('Bookmaker added successfully!');
                closeBookmakerModal();

                // Optionally, add the new bookmaker to the table
                addBookmakerToTable(bookmakerData);
            });

            function resetBookmakerForm() {
                // Reset Bookmaker Settings fields
                document.getElementById('bookmaker-group').selectedIndex = 0;
                document.getElementById('bookmaker-status').value = 'active';
                document.getElementById('bookmaker-name').value = '';
                document.getElementById('bookmaker-logo').value = '';
                document.getElementById('bookmaker-logo-preview').innerHTML = '';
                document.getElementById('bookmaker-affiliate-url').value = '';

                // Clear selected geographies
                selectedGeographies = [];
                document.getElementById('selected-geographies').innerHTML = '<i>No countries selected</i>';

                // Clear geography search
                document.getElementById('bookmaker-geography-search').value = '';
                document.getElementById('bookmaker-geography-list').classList.remove('active');

                // Reset deal settings
                document.getElementById('bookmaker-deal-type').value = 'revshare';
                document.getElementById('bookmaker-deal-description').value = '';
                document.getElementById('account-deals-list').innerHTML = '<p><i>Nenhuma Account criada ainda. Adicione Accounts na aba "Bookmaker Account Settings"</i></p>';

                // Reset accounts
                bookmakerAccounts = [];
                accountsContainer.innerHTML = '<p><i>No accounts added yet</i></p>';
                hideAccountForm();
                resetAccountForm();

                // Reset to first tab
                bookmakerModal.querySelector('.tab[data-tab="bookmaker-settings"]').click();
            }

            // Add a new bookmaker to the table
            function addBookmakerToTable(bookmaker) {
                const table = document.querySelector('.bookmaker-table tbody');
                if (!table) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bookmaker.id}</td>
                    <td>${bookmaker.name}</td>
                    <td>${bookmaker.affiliateUrl || '-'}</td>
                    <td>${bookmaker.status}</td>
                    <td class="action-buttons">
                        <button class="btn btn-edit">Editar</button>
                        <button class="btn btn-delete">Excluir</button>
                    </td>
                `;

                // Add event listeners for the new buttons
                row.querySelector('.btn-edit').addEventListener('click', function() {
                    alert(`Editando bookmaker com ID: ${bookmaker.id}`);
                });

                row.querySelector('.btn-delete').addEventListener('click', function() {
                    if (confirm(`Tem certeza que deseja excluir o bookmaker "${bookmaker.name}"?`)) {
                        row.remove();
                        bookmakersData = bookmakersData.filter(b => b.id !== bookmaker.id);
                        alert(`Bookmaker "${bookmaker.name}" exclu√≠do.`);
                    }
                });

                table.appendChild(row);
            }

            // Configurar listeners para bot√µes de edi√ß√£o existentes
            document.querySelectorAll('.btn-edit').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const id = row.cells[0].textContent;
                    alert(`Editando bookmaker com ID: ${id}`);
                });
            });

            // Configurar listeners para bot√µes de exclus√£o existentes
            document.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const id = row.cells[0].textContent;
                    const name = row.cells[1].textContent;

                    if (confirm(`Tem certeza que deseja excluir o bookmaker "${name}"?`)) {
                        row.remove();
                        bookmakersData = bookmakersData.filter(b => b.id !== id);
                        alert(`Bookmaker "${name}" exclu√≠do.`);
                    }
                });
            });
        });
    </script>
</body>
</html>