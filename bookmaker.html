<!doctype html>
<html lang="pt">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bookmaker Manager - CRM System</title>
        <link rel="stylesheet" href="styles.css" />
        <style>
            /* Estilos espec√≠ficos para a p√°gina de Bookmaker */
            .bookmaker-container {
                padding: 20px;
            }

            .bookmaker-header {
                margin-bottom: 25px;
            }

            .bookmaker-panel {
                background-color: #fff;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                padding: 20px;
                margin-bottom: 20px;
            }

            .btn {
                display: inline-block;
                padding: 8px 16px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
            }

            .btn:hover {
                background-color: #0069d9;
            }

            .bookmaker-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }

            .bookmaker-table th,
            .bookmaker-table td {
                padding: 12px 15px;
                text-align: left;
                border-bottom: 1px solid #e0e0e0;
            }

            .bookmaker-table th {
                background-color: #f8f9fa;
                font-weight: 600;
            }

            .action-buttons {
                display: flex;
                gap: 8px;
            }

            .action-buttons .btn {
                padding: 5px 10px;
                font-size: 12px;
            }

            .btn-edit {
                background-color: #ffc107;
            }

            .btn-delete {
                background-color: #dc3545;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h1>CRM</h1>
                </div>
                <nav class="sidebar-nav">
                    <ul>
                        <li>
                            <a href="index.html" data-section="homepage">
                                <span class="icon">üè†</span>
                                <span>Homepage</span>
                            </a>
                        </li>
                        <li class="active">
                            <a href="bookmaker.html" data-section="bookmaker">
                                <span class="icon">üìö</span>
                                <span>Bookmaker Manager</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-section="user">
                                <span class="icon">üë§</span>
                                <span>User Manager</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>

            <main class="content">
                <header class="content-header">
                    <h2 id="section-title">Bookmaker Manager</h2>
                </header>

                <div class="bookmaker-container">
                    <div class="bookmaker-panel">
                        <div class="bookmaker-header">
                            <h3>Gerenciar Bookmakers</h3>
                            <p>
                                Adicione, edite ou remova bookmakers no sistema.
                            </p>
                        </div>

                        <div
                            class="bookmaker-actions"
                            style="margin-bottom: 20px"
                        >
                            <button
                                class="btn"
                                id="addOwner"
                                style="margin-right: 10px"
                            >
                                Add Owner
                            </button>
                            <button
                                class="btn"
                                id="addGroup"
                                style="margin-right: 10px"
                            >
                                Add Group
                            </button>
                            <button class="btn" id="addBookmaker">
                                Add Bookmaker
                            </button>
                        </div>

                        <table class="bookmaker-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Grupo</th>
                                    <th>URL</th>
                                    <th>Status</th>
                                    <th>Geographies</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="bookmakers-table-body">
                                <!-- Bookmakers will be listed here dynamically -->
                                <tr id="no-bookmakers-row">
                                    <td colspan="7" style="text-align: center; font-style: italic;">Nenhum bookmaker cadastrado.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Owner Modal -->
        <div id="ownerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add Owner</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="tabs">
                        <div class="tab active" data-tab="owner-settings">
                            Owner Settings
                        </div>
                        <div class="tab" data-tab="owner-billing">
                            Owner Billing Details
                        </div>
                    </div>

                    <div class="tab-content active" id="owner-settings">
                        <div class="form-group">
                            <label for="owner-status">Owner Status</label>
                            <select id="owner-status" class="form-control">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="owner-name">Owner Name</label>
                            <input
                                type="text"
                                id="owner-name"
                                class="form-control"
                                placeholder="Enter owner name"
                            />
                        </div>
                        <div class="form-group">
                            <label for="owner-logo">Owner Logo</label>
                            <input
                                type="file"
                                id="owner-logo"
                                class="form-control"
                                accept="image/*"
                            />
                            <div
                                id="logo-preview"
                                style="margin-top: 10px"
                            ></div>
                        </div>
                    </div>

                    <div class="tab-content" id="owner-billing">
                        <div class="form-check">
                            <input
                                type="checkbox"
                                id="apply-billing"
                                class="form-control"
                                style="width: auto"
                            />
                            <label for="apply-billing"
                                >Apply Billing Details by Owner?</label
                            >
                        </div>

                        <div id="billing-details" style="display: none">
                            <div class="form-group">
                                <label for="billing-name">Name</label>
                                <input
                                    type="text"
                                    id="billing-name"
                                    class="form-control"
                                    placeholder="Enter billing name"
                                />
                            </div>
                            <div class="form-group">
                                <label for="billing-vat">VAT</label>
                                <input
                                    type="text"
                                    id="billing-vat"
                                    class="form-control"
                                    placeholder="Enter VAT number"
                                />
                            </div>
                            <div class="form-group">
                                <label for="billing-address1">Address 1</label>
                                <input
                                    type="text"
                                    id="billing-address1"
                                    class="form-control"
                                    placeholder="Enter address line 1"
                                />
                            </div>
                            <div class="form-group">
                                <label for="billing-address2">Address 2</label>
                                <input
                                    type="text"
                                    id="billing-address2"
                                    class="form-control"
                                    placeholder="Enter address line 2"
                                />
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="billing-city">City</label>
                                    <input
                                        type="text"
                                        id="billing-city"
                                        class="form-control"
                                        placeholder="Enter city"
                                    />
                                </div>
                                <div class="form-col">
                                    <label for="billing-state"
                                        >State/Province/Region</label
                                    >
                                    <input
                                        type="text"
                                        id="billing-state"
                                        class="form-control"
                                        placeholder="Enter state/province"
                                    />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="billing-zipcode"
                                        >Zip-Code</label
                                    >
                                    <input
                                        type="text"
                                        id="billing-zipcode"
                                        class="form-control"
                                        placeholder="Enter zip code"
                                    />
                                </div>
                                <div class="form-col">
                                    <label for="billing-country">Country</label>
                                    <div class="country-selector">
                                        <input
                                            type="text"
                                            id="country-search"
                                            class="country-search"
                                            placeholder="Search country"
                                        />
                                        <div
                                            id="country-list"
                                            class="country-list"
                                        ></div>
                                        <div
                                            id="selected-country"
                                            class="selected-country"
                                            style="display: none"
                                        >
                                            <span
                                                id="selected-flag"
                                                class="country-flag"
                                            ></span>
                                            <span id="selected-name"></span>
                                            <span class="country-remove"
                                                >√ó</span
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" style="background-color: #6c757d">
                        Cancel
                    </button>
                    <button class="btn" id="save-owner">Save Owner</button>
                </div>
            </div>
        </div>

        <!-- Group Modal -->
        <div id="groupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add Group</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="tabs">
                        <div class="tab active" data-tab="group-settings">
                            Group Settings
                        </div>
                        <div class="tab" data-tab="group-account">
                            Group Account Settings
                        </div>
                        <div class="tab" data-tab="group-billing">
                            Group Billing Settings
                        </div>
                        <div class="tab" data-tab="group-deal">
                            Group Deal Settings
                        </div>
                    </div>

                    <!-- Group Settings Tab -->
                    <div class="tab-content active" id="group-settings">
                        <div class="form-group">
                            <label for="group-status">Group Status</label>
                            <select id="group-status" class="form-control">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="group-name">Group Name</label>
                            <input
                                type="text"
                                id="group-name"
                                class="form-control"
                                placeholder="Enter group name"
                            />
                        </div>
                        <div class="form-group">
                            <label for="group-logo">Group Logo</label>
                            <input
                                type="file"
                                id="group-logo"
                                class="form-control"
                                accept="image/*"
                            />
                            <div
                                id="group-logo-preview"
                                class="image-preview"
                            ></div>
                        </div>
                        <div class="form-group">
                            <label for="group-url">Group URL</label>
                            <input
                                type="url"
                                id="group-url"
                                class="form-control"
                                placeholder="Enter group URL"
                            />
                        </div>
                        <div class="form-group">
                            <label for="group-affiliate-url"
                                >Group Affiliate URL</label
                            >
                            <input
                                type="url"
                                id="group-affiliate-url"
                                class="form-control"
                                placeholder="Enter group affiliate URL"
                            />
                        </div>
                    </div>

                    <!-- Group Account Settings Tab -->
                    <div class="tab-content" id="group-account">
                        <div class="form-check">
                            <input
                                type="checkbox"
                                id="apply-account"
                                class="form-check-input"
                            />
                            <label for="apply-account"
                                >Apply Account Settings by Group?</label
                            >
                        </div>

                        <div id="account-details" style="display: none">
                            <div class="form-group">
                                <label for="account-owner">Owner</label>
                                <select id="account-owner" class="form-control">
                                    <option value="">Select an owner</option>
                                    <!-- Owners will be populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="account-status"
                                    >Account Status</label
                                >
                                <select
                                    id="account-status"
                                    class="form-control"
                                >
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="account-username"
                                    >Username/Email</label
                                >
                                <input
                                    type="text"
                                    id="account-username"
                                    class="form-control"
                                    placeholder="Enter username or email"
                                />
                            </div>
                            <div class="form-group">
                                <label for="account-password">Password</label>
                                <input
                                    type="password"
                                    id="account-password"
                                    class="form-control"
                                    placeholder="Enter password"
                                />
                            </div>
                        </div>
                    </div>

                    <!-- Group Billing Settings Tab -->
                    <div class="tab-content" id="group-billing">
                        <div class="form-check">
                            <input
                                type="checkbox"
                                id="apply-group-billing"
                                class="form-check-input"
                            />
                            <label for="apply-group-billing"
                                >Apply Billing Settings by Group?</label
                            >
                        </div>

                        <div id="group-billing-details" style="display: none">
                            <div class="form-group">
                                <label for="group-billing-name">Name</label>
                                <input
                                    type="text"
                                    id="group-billing-name"
                                    class="form-control"
                                    placeholder="Enter billing name"
                                />
                            </div>
                            <div class="form-group">
                                <label for="group-billing-vat">VAT</label>
                                <input
                                    type="text"
                                    id="group-billing-vat"
                                    class="form-control"
                                    placeholder="Enter VAT number"
                                />
                            </div>
                            <div class="form-group">
                                <label for="group-billing-address1"
                                    >Address 1</label
                                >
                                <input
                                    type="text"
                                    id="group-billing-address1"
                                    class="form-control"
                                    placeholder="Enter address line 1"
                                />
                            </div>
                            <div class="form-group">
                                <label for="group-billing-address2"
                                    >Address 2</label
                                >
                                <input
                                    type="text"
                                    id="group-billing-address2"
                                    class="form-control"
                                    placeholder="Enter address line 2"
                                />
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="group-billing-city">City</label>
                                    <input
                                        type="text"
                                        id="group-billing-city"
                                        class="form-control"
                                        placeholder="Enter city"
                                    />
                                </div>
                                <div class="form-col">
                                    <label for="group-billing-state"
                                        >State/Province/Region</label
                                    >
                                    <input
                                        type="text"
                                        id="group-billing-state"
                                        class="form-control"
                                        placeholder="Enter state/province"
                                    />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="group-billing-zipcode"
                                        >Zip-Code</label
                                    >
                                    <input
                                        type="text"
                                        id="group-billing-zipcode"
                                        class="form-control"
                                        placeholder="Enter zip code"
                                    />
                                </div>
                                <div class="form-col">
                                    <label for="group-billing-country"
                                        >Country</label
                                    >
                                    <div class="country-selector">
                                        <input
                                            type="text"
                                            id="group-country-search"
                                            class="country-search"
                                            placeholder="Search country"
                                        />
                                        <div
                                            id="group-country-list"
                                            class="country-list"
                                        ></div>
                                        <div
                                            id="group-selected-country"
                                            class="selected-country"
                                            style="display: none"
                                        >
                                            <span
                                                id="group-selected-flag"
                                                class="country-flag"
                                            ></span>
                                            <span
                                                id="group-selected-name"
                                            ></span>
                                            <span class="country-remove"
                                                >√ó</span
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Group Deal Settings Tab -->
                    <div class="tab-content" id="group-deal">
                        <div class="form-check">
                            <input
                                type="checkbox"
                                id="apply-deal"
                                class="form-check-input"
                            />
                            <label for="apply-deal"
                                >Apply Deal Settings by Group?</label
                            >
                        </div>

                        <div id="deal-details" style="display: none">
                            <div class="form-group">
                                <label for="deal-type">Deal Type</label>
                                <select id="deal-type" class="form-control">
                                    <option value="revshare">Rev Share</option>
                                    <option value="cpa">CPA</option>
                                    <option value="hybrid">Hybrid</option>
                                    <option value="flatfee">Flat Fee</option>
                                    <option value="other">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deal-description"
                                    >Deal Description</label
                                >
                                <textarea
                                    id="deal-description"
                                    class="form-control"
                                    rows="4"
                                    placeholder="Enter deal description"
                                ></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" style="background-color: #6c757d">
                        Cancel
                    </button>
                    <button class="btn" id="save-group">Save Group</button>
                </div>
            </div>
        </div>

        <!-- Bookmaker Modal -->
        <div id="bookmakerModal" class="modal">
            <div class="modal-content bookmaker-modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add Bookmaker</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="tabs">
                        <div class="tab active" data-tab="bookmaker-settings">
                            Bookmaker Settings
                        </div>
                        <div class="tab" data-tab="bookmaker-url">
                            Bookmaker URL
                        </div>
                        <div class="tab" data-tab="bookmaker-affiliate-urls">
                            Bookmaker Affiliate URL
                        </div>
                        <div class="tab" data-tab="bookmaker-games">
                            Games
                        </div>
                        <div class="tab" data-tab="bookmaker-contacts">
                            Contacts
                        </div>
                        <div class="tab" data-tab="bookmaker-account">
                            Bookmaker Account Settings
                        </div>
                        <div class="tab" data-tab="bookmaker-billing">
                            Bookmaker Billing Settings
                        </div>
                        <div class="tab" data-tab="bookmaker-deal">
                            Bookmaker Deal Settings
                        </div>
                    </div>

                    <!-- Bookmaker Settings Tab -->
                    <div class="tab-content active" id="bookmaker-settings">
                        <div class="form-group">
                            <label for="bookmaker-group">Bookmaker Group</label>
                            <select id="bookmaker-group" class="form-control">
                                <option value="">Select a group</option>
                                <!-- Groups will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bookmaker-status"
                                >Bookmaker Status</label
                            >
                            <select id="bookmaker-status" class="form-control">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bookmaker-name">Bookmaker Name</label>
                            <input
                                type="text"
                                id="bookmaker-name"
                                class="form-control"
                                placeholder="Enter bookmaker name"
                            />
                        </div>
                        <div class="form-group">
                            <label for="bookmaker-logo">Bookmaker Logo</label>
                            <input
                                type="file"
                                id="bookmaker-logo"
                                class="form-control"
                                accept="image/*"
                            />
                            <div
                                id="bookmaker-logo-preview"
                                class="image-preview"
                            ></div>
                        </div>
                        <div class="form-group">
                            <label for="bookmaker-affiliate-url"
                                >Bookmaker Affiliate URL</label
                            >
                            <input
                                type="url"
                                id="bookmaker-affiliate-url"
                                class="form-control"
                                placeholder="Enter bookmaker affiliate URL"
                            />
                        </div>
                        <div class="form-group">
                            <label for="bookmaker-geographies"
                                >Geographies</label
                            >
                            <div class="country-selector">
                                <input
                                    type="text"
                                    id="bookmaker-geography-search"
                                    class="country-search"
                                    placeholder="Search countries"
                                />
                                <div
                                    id="bookmaker-geography-list"
                                    class="geography-list"
                                ></div>
                            </div>
                            <div
                                class="selected-geographies"
                                id="selected-geographies"
                            >
                                <!-- Selected countries will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Bookmaker URL Tab -->
                    <div class="tab-content" id="bookmaker-url">
                        <div id="url-no-geographies-message" class="no-geographies-message">
                            <p>Please select geographies in the "Bookmaker Settings" tab first before configuring URLs.</p>
                        </div>

                        <div id="url-geographies-container">
                            <!-- Geography URL fields will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Bookmaker Affiliate URL Tab -->
                    <div class="tab-content" id="bookmaker-affiliate-urls">
                        <div id="affiliate-url-no-geographies-message" class="no-geographies-message">
                            <p>Please select geographies in the "Bookmaker Settings" tab first before configuring affiliate URLs.</p>
                        </div>

                        <div id="affiliate-url-geographies-container">
                            <!-- Geography Affiliate URL fields will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Bookmaker Games Tab -->
                    <div class="tab-content" id="bookmaker-games">
                        <div id="games-no-geographies-message" class="no-geographies-message">
                            <p>Please select geographies in the "Bookmaker Settings" tab first before configuring games.</p>
                        </div>

                        <div id="games-geographies-container">
                            <!-- Geography Games selection fields will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Bookmaker Contacts Tab -->
                    <div class="tab-content" id="bookmaker-contacts">
                        <div id="contacts-no-geographies-message" class="no-geographies-message">
                            <p>Please select geographies in the "Bookmaker Settings" tab first before adding contacts.</p>
                        </div>

                        <div id="contacts-container" style="display: none;">
                            <div class="contacts-header">
                                <button type="button" id="add-contact" class="btn" style="margin-bottom: 15px;">
                                    Add Contact
                                </button>
                            </div>
                            
                            <div id="contacts-list">
                                <!-- Contacts will be added here dynamically -->
                                <p id="no-contacts-message"><i>No contacts added yet</i></p>
                            </div>
                            
                            <!-- Contact Form -->
                            <div id="contact-form" style="display: none; border: 1px solid #e0e0e0; padding: 15px; margin-top: 15px; border-radius: 4px; background-color: #f9f9f9;">
                                <h4 style="margin-top: 0;">Add New Contact</h4>
                                
                                <div class="form-group">
                                    <label for="contact-name">Name</label>
                                    <input type="text" id="contact-name" class="form-control" placeholder="Enter contact name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="contact-department">Departments</label>
                                    <div class="department-selector" style="position: relative;">
                                        <input type="text" id="department-search" class="form-control" placeholder="Search departments..." autocomplete="off">
                                        <div id="departments-dropdown" class="dropdown-list" style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 100; background-color: white; border: 1px solid #ced4da; border-radius: 4px;">
                                            <div class="dropdown-item" data-value="CEO">CEO</div>
                                            <div class="dropdown-item" data-value="CMO">CMO</div>
                                            <div class="dropdown-item" data-value="CTO">CTO</div>
                                            <div class="dropdown-item" data-value="CFO">CFO</div>
                                            <div class="dropdown-item" data-value="IT">IT</div>
                                            <div class="dropdown-item" data-value="Finance">Finance</div>
                                            <div class="dropdown-item" data-value="Sales">Sales</div>
                                            <div class="dropdown-item" data-value="Affiliate Manager">Affiliate Manager</div>
                                            <div class="dropdown-item" data-value="General">General</div>
                                            <div class="dropdown-item" data-value="Outro">Outro</div>
                                        </div>
                                        <div id="contact-selected-departments" class="selected-items" style="margin-top: 5px;">
                                            <!-- Selected departments will appear here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contact-geographies">Geographies</label>
                                    <div class="geography-selector" style="position: relative;">
                                        <input type="text" id="contact-geography-search" class="form-control" placeholder="Search geographies..." autocomplete="off">
                                        <div id="contact-geography-dropdown" class="dropdown-list" style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 100; background-color: white; border: 1px solid #ced4da; border-radius: 4px;">
                                            <!-- Geography options will be added dynamically -->
                                        </div>
                                        <div id="contact-selected-geographies" class="selected-items" style="margin-top: 5px;">
                                            <!-- Selected geographies will appear here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="contact-methods-container">
                                    <h5>Contact Methods</h5>
                                    <div id="contact-methods-list">
                                        <!-- Contact methods will be added here -->
                                    </div>
                                    
                                    <button type="button" id="add-contact-method" class="btn btn-sm" style="margin-top: 10px;">
                                        Add Contact Method
                                    </button>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <button type="button" id="save-contact" class="btn">Save Contact</button>
                                    <button type="button" id="cancel-contact" class="btn" style="background-color: #6c757d; margin-left: 10px;">Cancel</button>
                                </div>
                            </div>
                            
                            <!-- Contact Method Template (hidden) -->
                            <div id="contact-method-template" style="display: none;">
                                <div class="contact-method" style="display: flex; align-items: flex-end; margin-bottom: 10px; border: 1px solid #e0e0e0; padding: 10px; border-radius: 4px;">
                                    <div style="flex: 1;">
                                        <div class="form-group">
                                            <label>Contact Type</label>
                                            <div class="contact-type-selector" style="position: relative;">
                                                <input type="text" class="contact-type-search form-control" placeholder="Search contact types..." autocomplete="off">
                                                <div class="contact-type-dropdown dropdown-list" style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 100; background-color: white; border: 1px solid #ced4da; border-radius: 4px;">
                                                    <div class="dropdown-item" data-value="Email">Email</div>
                                                    <div class="dropdown-item" data-value="WhatsApp">WhatsApp</div>
                                                    <div class="dropdown-item" data-value="Skype">Skype</div>
                                                    <div class="dropdown-item" data-value="Telegram">Telegram</div>
                                                    <div class="dropdown-item" data-value="LinkedIn">LinkedIn</div>
                                                    <div class="dropdown-item" data-value="Instagram">Instagram</div>
                                                    <div class="dropdown-item" data-value="Microsoft Teams">Microsoft Teams</div>
                                                    <div class="dropdown-item" data-value="Cellphone">Cellphone</div>
                                                </div>
                                                <input type="hidden" class="contact-type-value" value="">
                                                <div class="selected-contact-type selected-value" style="display: none;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="flex: 1; margin-left: 10px;">
                                        <div class="form-group">
                                            <label>Contact</label>
                                            <input type="text" class="contact-value form-control" placeholder="Enter contact information">
                                        </div>
                                    </div>
                                    <div style="margin-left: 10px; margin-bottom: 0.5rem;">
                                        <button type="button" class="btn btn-sm btn-delete remove-contact-method" style="padding: 3px 8px; font-size: 12px;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bookmaker Account Settings Tab -->
                    <div class="tab-content" id="bookmaker-account">
                        <div class="form-group">
                            <button
                                type="button"
                                id="add-account"
                                class="btn"
                                style="margin-bottom: 15px"
                            >
                                Add Account
                            </button>
                        </div>

                        <div id="accounts-container">
                            <!-- Accounts will be added here dynamically -->
                        </div>

                        <div
                            id="account-form"
                            style="
                                display: none;
                                border: 1px solid #e0e0e0;
                                padding: 15px;
                                margin-top: 15px;
                                border-radius: 4px;
                            "
                        >
                            <div class="form-group">
                                <button
                                    type="button"
                                    id="auto-fill-from-group"
                                    class="btn"
                                    style="
                                        margin-bottom: 15px;
                                        background-color: #28a745;
                                    "
                                >
                                    Auto-fill from Group Account
                                </button>
                            </div>
                            <div class="form-group">
                                <label for="bookmaker-account-owner"
                                    >Owner</label
                                >
                                <select
                                    id="bookmaker-account-owner"
                                    class="form-control"
                                >
                                    <option value="">Select an owner</option>
                                    <!-- Owners will be populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="account-status"
                                    >Account Status</label
                                >
                                <select
                                    id="account-status"
                                    class="form-control"
                                >
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="bookmaker-account-username"
                                    >Username/Email</label
                                >
                                <input
                                    type="text"
                                    id="bookmaker-account-username"
                                    class="form-control"
                                    placeholder="Enter username or email"
                                />
                            </div>
                            <div class="form-group">
                                <label for="bookmaker-account-password"
                                    >Password</label
                                >
                                <input
                                    type="password"
                                    id="bookmaker-account-password"
                                    class="form-control"
                                    placeholder="Enter password"
                                />
                            </div>
                            <div class="form-group">
                                <label for="account-geographies"
                                    >Associated Geographies</label
                                >
                                <div class="country-selector">
                                    <input
                                        type="text"
                                        id="account-geography-search"
                                        class="country-search"
                                        placeholder="Search countries"
                                    />
                                    <div
                                        id="account-geography-list"
                                        class="geography-list"
                                    ></div>
                                </div>
                                <div
                                    class="selected-geographies"
                                    id="account-selected-geographies"
                                >
                                    <!-- Selected countries will appear here -->
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 15px">
                                <button
                                    type="button"
                                    id="save-account"
                                    class="btn"
                                >
                                    Save Account
                                </button>
                                <button
                                    type="button"
                                    id="cancel-account"
                                    class="btn"
                                    style="
                                        background-color: #6c757d;
                                        margin-left: 10px;
                                    "
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bookmaker Billing Settings Tab -->
                    <div class="tab-content" id="bookmaker-billing">
                        <div
                            id="billing-no-accounts-message"
                            class="no-accounts-message"
                        >
                            <p>
                                Please add accounts in the "Bookmaker Account
                                Settings" tab first before configuring billing
                                details.
                            </p>
                        </div>

                        <div id="billing-accounts-container">
                            <!-- Account billing cards will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Bookmaker Deal Settings Tab -->
                    <div class="tab-content" id="bookmaker-deal">
                        <div
                            id="no-accounts-message"
                            class="no-accounts-message"
                        >
                            <p>
                                Please add accounts in the "Bookmaker Account
                                Settings" tab first before configuring deals.
                            </p>
                        </div>

                        <div id="deal-accounts-container">
                            <!-- Account deal cards will be added here dynamically -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" style="background-color: #6c757d">
                        Cancel
                    </button>
                    <button class="btn" id="save-bookmaker">
                        Save Bookmaker
                    </button>
                </div>
            </div>
        </div>

        <link rel="stylesheet" href="owner-modal.css" />
        <link rel="stylesheet" href="group-modal.css" />
        <link rel="stylesheet" href="bookmaker-modal.css" />

        <script src="database.js"></script>
        <script src="script.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Inicialize o banco de dados
                if (window.DB) {
                    window.DB.init();
                    console.log("Banco de dados inicializado com sucesso na p√°gina bookmaker.html");
                    
                    // Carrega os dados existentes do localStorage
                    window.ownersData = window.DB.owners.get() || [];
                    window.groupsData = window.DB.groups.get() || [];
                    window.bookmakersData = window.DB.bookmakers.get() || [];
                    
                    console.log("Dados carregados com sucesso:", {
                        owners: window.ownersData.length,
                        groups: window.groupsData.length,
                        bookmakers: window.bookmakersData.length
                    });
                    
                    // Atualiza vari√°veis locais para garantir sincroniza√ß√£o
                    ownersData = window.ownersData;
                    groupsData = window.groupsData;
                    bookmakersData = window.bookmakersData;
                    
                    console.log("Inicializando tabela de bookmakers...");
                    setTimeout(renderBookmakersTable, 100);
                }
                
                // Get country data from countries.js
                let countriesData = [];
                // Array para armazenar owners registrados - carregar do localStorage
                let ownersData = window.ownersData || [];
                // Array para armazenar groups registrados - carregar do localStorage
                let groupsData = window.groupsData || [];
                // Array para armazenar bookmakers registrados - carregar do localStorage
                let bookmakersData = window.bookmakersData || [];
                // Array para armazenar geographies selecionadas
                let selectedGeographies = [];

                // Try to import countries first
                // Load the countries.js file as a regular script
                const countriesScript = document.createElement("script");
                countriesScript.src = "./countries.js";
                countriesScript.onload = function () {
                    // Access the countries through the global variable
                    if (
                        window.countriesModule &&
                        window.countriesModule.countries
                    ) {
                        countriesData = window.countriesModule.countries;
                        initCountrySelectors();
                        initGeographySelector();
                    } else {
                        console.error("Countries module not properly loaded");
                        fetchCountries();
                    }
                };
                countriesScript.onerror = function () {
                    console.error("Error loading countries script");
                    fetchCountries();
                };
                document.head.appendChild(countriesScript);

                function fetchCountries() {
                    // Fallback method to get countries
                    fetch("./countries.js")
                        .then((response) => response.text())
                        .then((text) => {
                            // Extract the countries array from the JS file content
                            try {
                                const startIndex = text.indexOf(
                                    "const countries = [",
                                );
                                const endIndex = text.indexOf("module.exports");
                                if (startIndex !== -1 && endIndex !== -1) {
                                    const countriesStr = text.substring(
                                        startIndex,
                                        endIndex,
                                    );
                                    // Using Function constructor to safely evaluate the array
                                    const getCountries = new Function(
                                        "return " +
                                            countriesStr
                                                .replace(
                                                    "const countries = ",
                                                    "",
                                                )
                                                .trim()
                                                .slice(0, -1),
                                    );
                                    countriesData = getCountries();
                                    initCountrySelectors();
                                    initGeographySelector();
                                }
                            } catch (error) {
                                console.error(
                                    "Error parsing countries:",
                                    error,
                                );
                            }
                        })
                        .catch((error) =>
                            console.error("Error fetching countries:", error),
                        );
                }

                // OWNER MODAL FUNCTIONALITY
                const ownerModal = document.getElementById("ownerModal");
                const ownerCloseBtn = ownerModal.querySelector(".modal-close");
                const ownerCancelBtn = ownerModal.querySelector(
                    ".modal-footer .btn:first-child",
                );

                // Open owner modal when Add Owner button is clicked
                document
                    .getElementById("addOwner")
                    .addEventListener("click", function () {
                        ownerModal.classList.add("active");
                    });

                // Close modal when close button or cancel is clicked
                ownerCloseBtn.addEventListener("click", function () {
                    closeOwnerModal();
                });
                ownerCancelBtn.addEventListener("click", function () {
                    closeOwnerModal();
                });

                function closeOwnerModal() {
                    ownerModal.classList.remove("active");
                    resetOwnerForm();
                }

                // Toggle billing details based on checkbox
                const applyBillingCheckbox =
                    document.getElementById("apply-billing");
                const billingDetailsSection =
                    document.getElementById("billing-details");

                applyBillingCheckbox.addEventListener("change", function () {
                    billingDetailsSection.style.display = this.checked
                        ? "block"
                        : "none";
                });

                // Logo preview functionality for owner
                const ownerLogoInput = document.getElementById("owner-logo");
                const logoPreview = document.getElementById("logo-preview");

                ownerLogoInput.addEventListener("change", function (e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            logoPreview.innerHTML = `
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 150px;">
                            <button type="button" id="remove-logo" style="display: block; margin-top: 5px;" class="btn btn-sm btn-delete">Remove</button>
                        `;

                            document
                                .getElementById("remove-logo")
                                .addEventListener("click", function () {
                                    ownerLogoInput.value = "";
                                    logoPreview.innerHTML = "";
                                });
                        };

                        reader.readAsDataURL(file);
                    }
                });

                // Function to initialize both country selectors (owner and group)
                function initCountrySelectors() {
                    // Initialize owner country selector
                    initCountrySelector(
                        "country-search",
                        "country-list",
                        "selected-country",
                        "selected-flag",
                        "selected-name",
                    );

                    // Initialize group country selector
                    initCountrySelector(
                        "group-country-search",
                        "group-country-list",
                        "group-selected-country",
                        "group-selected-flag",
                        "group-selected-name",
                    );
                }

                // Country selector functionality (reusable)
                function initCountrySelector(
                    searchId,
                    listId,
                    selectedId,
                    flagId,
                    nameId,
                ) {
                    const countrySearch = document.getElementById(searchId);
                    const countryList = document.getElementById(listId);
                    const selectedCountry = document.getElementById(selectedId);
                    const selectedFlag = document.getElementById(flagId);
                    const selectedName = document.getElementById(nameId);
                    const countryRemove =
                        selectedCountry.querySelector(".country-remove");

                    if (!countrySearch || !countryList || !selectedCountry) {
                        console.error(
                            `One of the country selector elements not found: ${searchId}, ${listId}, ${selectedId}`,
                        );
                        return;
                    }

                    // Populate country list
                    function renderCountryList(filter = "") {
                        countryList.innerHTML = "";

                        const filteredCountries = filter
                            ? countriesData.filter((c) =>
                                  c.name
                                      .toLowerCase()
                                      .includes(filter.toLowerCase()),
                              )
                            : countriesData;

                        filteredCountries.forEach((country) => {
                            const item = document.createElement("div");
                            item.className = "country-item";
                            item.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        `;

                            item.addEventListener("click", function () {
                                // Set selected country
                                selectedFlag.textContent = country.flag;
                                selectedName.textContent = country.name;
                                selectedCountry.style.display = "flex";
                                countrySearch.value = "";
                                countryList.classList.remove("active");

                                // Store the country data
                                selectedCountry.dataset.code = country.code;
                            });

                            countryList.appendChild(item);
                        });
                    }

                    // Show country list on focus
                    countrySearch.addEventListener("focus", function () {
                        countryList.classList.add("active");
                        renderCountryList();
                    });

                    // Filter countries on search
                    countrySearch.addEventListener("input", function () {
                        renderCountryList(this.value);
                        countryList.classList.add("active");
                    });

                    // Remove selected country
                    countryRemove.addEventListener("click", function () {
                        selectedCountry.style.display = "none";
                        delete selectedCountry.dataset.code;
                    });

                    // Close country list when clicking outside
                    document.addEventListener("click", function (e) {
                        if (!e.target.closest(".country-selector")) {
                            countryList.classList.remove("active");
                        }
                    });

                    // Initial render
                    renderCountryList();
                }

                // Save owner
                document
                    .getElementById("save-owner")
                    .addEventListener("click", function () {
                        const ownerId = Date.now().toString(); // Generate a unique ID
                        const ownerData = {
                            id: ownerId,
                            status: document.getElementById("owner-status")
                                .value,
                            name: document.getElementById("owner-name").value,
                            // Logo handling would typically involve uploading the file to a server
                            applyBilling:
                                document.getElementById("apply-billing")
                                    .checked,
                        };

                        if (ownerData.applyBilling) {
                            ownerData.billing = {
                                name: document.getElementById("billing-name")
                                    .value,
                                vat: document.getElementById("billing-vat")
                                    .value,
                                address1:
                                    document.getElementById("billing-address1")
                                        .value,
                                address2:
                                    document.getElementById("billing-address2")
                                        .value,
                                city: document.getElementById("billing-city")
                                    .value,
                                state: document.getElementById("billing-state")
                                    .value,
                                zipCode:
                                    document.getElementById("billing-zipcode")
                                        .value,
                                country:
                                    document.getElementById("selected-country")
                                        .dataset.code,
                            };
                        }

                        // Add to owners array
                        ownersData.push(ownerData);
                        
                        // Salvar no banco de dados local
                        window.DB.owners.save(ownersData);

                        // Update owner dropdown in group modal
                        updateOwnerDropdown();

                        console.log("Owner data:", ownerData);
                        alert("Owner added successfully!");
                        closeOwnerModal();
                    });

                function resetOwnerForm() {
                    // Reset form fields
                    document.getElementById("owner-status").value = "active";
                    document.getElementById("owner-name").value = "";
                    document.getElementById("owner-logo").value = "";
                    document.getElementById("logo-preview").innerHTML = "";

                    document.getElementById("apply-billing").checked = false;
                    document.getElementById("billing-details").style.display =
                        "none";

                    document.getElementById("billing-name").value = "";
                    document.getElementById("billing-vat").value = "";
                    document.getElementById("billing-address1").value = "";
                    document.getElementById("billing-address2").value = "";
                    document.getElementById("billing-city").value = "";
                    document.getElementById("billing-state").value = "";
                    document.getElementById("billing-zipcode").value = "";

                    document.getElementById("country-search").value = "";
                    document.getElementById("selected-country").style.display =
                        "none";
                    delete document.getElementById("selected-country").dataset
                        .code;

                    // Reset to first tab
                    ownerModal
                        .querySelector('.tab[data-tab="owner-settings"]')
                        .click();
                }

                // Update the owner dropdown in the group modal
                function updateOwnerDropdown() {
                    const ownerDropdown =
                        document.getElementById("account-owner");
                    if (!ownerDropdown) return;

                    // Clear current options except the first one
                    while (ownerDropdown.options.length > 1) {
                        ownerDropdown.remove(1);
                    }

                    // Add owners to dropdown
                    ownersData.forEach((owner) => {
                        const option = document.createElement("option");
                        option.value = owner.id;
                        option.textContent = owner.name;
                        ownerDropdown.appendChild(option);
                    });
                }

                // GROUP MODAL FUNCTIONALITY
                const groupModal = document.getElementById("groupModal");
                const groupCloseBtn = groupModal.querySelector(".modal-close");
                const groupCancelBtn = groupModal.querySelector(
                    ".modal-footer .btn:first-child",
                );
                const groupSaveBtn = document.getElementById("save-group");

                // Open group modal when Add Group button is clicked
                document
                    .getElementById("addGroup")
                    .addEventListener("click", function () {
                        groupModal.classList.add("active");
                        // Update owner dropdown when opening modal
                        updateOwnerDropdown();
                    });

                // Close modal when close button or cancel is clicked
                groupCloseBtn.addEventListener("click", function () {
                    closeGroupModal();
                });
                groupCancelBtn.addEventListener("click", function () {
                    closeGroupModal();
                });

                function closeGroupModal() {
                    groupModal.classList.remove("active");
                    resetGroupForm();
                }

                // Tab functionality for all modals
                const tabsContainers = document.querySelectorAll(".tabs");

                tabsContainers.forEach((container) => {
                    const tabs = container.querySelectorAll(".tab");
                    // Find the parent modal
                    const modal = container.closest(".modal");
                    // Get all tab contents in this modal
                    const tabContents = modal.querySelectorAll(".tab-content");

                    tabs.forEach((tab) => {
                        tab.addEventListener("click", function () {
                            const target = this.getAttribute("data-tab");

                            // Remove active class from all tabs and contents within this modal
                            tabs.forEach((t) => t.classList.remove("active"));
                            tabContents.forEach((content) =>
                                content.classList.remove("active"),
                            );

                            // Add active class to clicked tab and corresponding content
                            this.classList.add("active");
                            modal
                                .querySelector(`#${target}`)
                                .classList.add("active");

                            // If this is the bookmaker deal or billing tab, render the accounts
                            if (target === "bookmaker-deal") {
                                renderDealAccounts();
                            }

                            if (target === "bookmaker-billing") {
                                renderBillingAccounts();
                            }
                        });
                    });
                });

                // Logo preview functionality for group
                const groupLogoInput = document.getElementById("group-logo");
                const groupLogoPreview =
                    document.getElementById("group-logo-preview");

                groupLogoInput.addEventListener("change", function (e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            groupLogoPreview.innerHTML = `
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 150px;">
                            <button type="button" id="remove-group-logo" style="display: block; margin-top: 5px;" class="btn btn-sm btn-delete">Remove</button>
                        `;

                            document
                                .getElementById("remove-group-logo")
                                .addEventListener("click", function () {
                                    groupLogoInput.value = "";
                                    groupLogoPreview.innerHTML = "";
                                });
                        };

                        reader.readAsDataURL(file);
                    }
                });

                // Toggle account details
                const applyAccountCheckbox =
                    document.getElementById("apply-account");
                const accountDetailsSection =
                    document.getElementById("account-details");

                applyAccountCheckbox.addEventListener("change", function () {
                    accountDetailsSection.style.display = this.checked
                        ? "block"
                        : "none";
                });

                // Toggle group billing details
                const applyGroupBillingCheckbox = document.getElementById(
                    "apply-group-billing",
                );
                const groupBillingDetailsSection = document.getElementById(
                    "group-billing-details",
                );

                applyGroupBillingCheckbox.addEventListener(
                    "change",
                    function () {
                        groupBillingDetailsSection.style.display = this.checked
                            ? "block"
                            : "none";
                    },
                );

                // Toggle deal details
                const applyDealCheckbox = document.getElementById("apply-deal");
                const dealDetailsSection =
                    document.getElementById("deal-details");

                applyDealCheckbox.addEventListener("change", function () {
                    dealDetailsSection.style.display = this.checked
                        ? "block"
                        : "none";
                });

                // Save group
                groupSaveBtn.addEventListener("click", function () {
                    const groupId = Date.now().toString(); // Generate a unique ID
                    const groupData = {
                        id: groupId,
                        status: document.getElementById("group-status").value,
                        name: document.getElementById("group-name").value,
                        url: document.getElementById("group-url").value,
                        affiliateUrl: document.getElementById(
                            "group-affiliate-url",
                        ).value,
                    };

                    // Check if account settings are enabled
                    if (document.getElementById("apply-account").checked) {
                        groupData.account = {
                            owner: document.getElementById("account-owner")
                                .value,
                            status: document.getElementById("account-status")
                                .value,
                            username:
                                document.getElementById("account-username")
                                    .value,
                            password:
                                document.getElementById("account-password")
                                    .value,
                        };
                    }

                    // Check if billing settings are enabled
                    if (
                        document.getElementById("apply-group-billing").checked
                    ) {
                        groupData.billing = {
                            name: document.getElementById("group-billing-name")
                                .value,
                            vat: document.getElementById("group-billing-vat")
                                .value,
                            address1: document.getElementById(
                                "group-billing-address1",
                            ).value,
                            address2: document.getElementById(
                                "group-billing-address2",
                            ).value,
                            city: document.getElementById("group-billing-city")
                                .value,
                            state: document.getElementById(
                                "group-billing-state",
                            ).value,
                            zipCode: document.getElementById(
                                "group-billing-zipcode",
                            ).value,
                            country: document.getElementById(
                                "group-selected-country",
                            ).dataset.code,
                        };
                    }

                    // Check if deal settings are enabled
                    if (document.getElementById("apply-deal").checked) {
                        groupData.deal = {
                            type: document.getElementById("deal-type").value,
                            description:
                                document.getElementById("deal-description")
                                    .value,
                        };
                    }

                    // Add to groups array
                    groupsData.push(groupData);
                    
                    // Salvar no banco de dados local
                    window.DB.groups.save(groupsData);

                    // Update group dropdown in bookmaker modal
                    updateGroupDropdown();

                    console.log("Group data:", groupData);
                    alert("Group added successfully!");
                    closeGroupModal();
                });

                function resetGroupForm() {
                    // Reset Group Settings tab
                    document.getElementById("group-status").value = "active";
                    document.getElementById("group-name").value = "";
                    document.getElementById("group-logo").value = "";
                    document.getElementById("group-logo-preview").innerHTML =
                        "";
                    document.getElementById("group-url").value = "";
                    document.getElementById("group-affiliate-url").value = "";

                    // Reset Group Account Settings tab
                    document.getElementById("apply-account").checked = false;
                    document.getElementById("account-details").style.display =
                        "none";
                    document.getElementById("account-owner").selectedIndex = 0;
                    document.getElementById("account-status").value = "active";
                    document.getElementById("account-username").value = "";
                    document.getElementById("account-password").value = "";

                    // Reset Group Billing Settings tab
                    document.getElementById("apply-group-billing").checked =
                        false;
                    document.getElementById(
                        "group-billing-details",
                    ).style.display = "none";
                    document.getElementById("group-billing-name").value = "";
                    document.getElementById("group-billing-vat").value = "";
                    document.getElementById("group-billing-address1").value =
                        "";
                    document.getElementById("group-billing-address2").value =
                        "";
                    document.getElementById("group-billing-city").value = "";
                    document.getElementById("group-billing-state").value = "";
                    document.getElementById("group-billing-zipcode").value = "";
                    document.getElementById("group-country-search").value = "";
                    document.getElementById(
                        "group-selected-country",
                    ).style.display = "none";
                    delete document.getElementById("group-selected-country")
                        .dataset.code;

                    // Reset Group Deal Settings tab
                    document.getElementById("apply-deal").checked = false;
                    document.getElementById("deal-details").style.display =
                        "none";
                    document.getElementById("deal-type").value = "revshare";
                    document.getElementById("deal-description").value = "";

                    // Reset to first tab
                    groupModal
                        .querySelector('.tab[data-tab="group-settings"]')
                        .click();
                }

                // Update the group dropdown in the bookmaker modal
                function updateGroupDropdown() {
                    const groupDropdown =
                        document.getElementById("bookmaker-group");
                    if (!groupDropdown) return;

                    // Clear current options except the first one
                    while (groupDropdown.options.length > 1) {
                        groupDropdown.remove(1);
                    }

                    // Add groups to dropdown
                    groupsData.forEach((group) => {
                        const option = document.createElement("option");
                        option.value = group.id;
                        option.textContent = group.name;
                        groupDropdown.appendChild(option);
                    });
                }

                // BOOKMAKER MODAL FUNCTIONALITY
                const bookmakerModal =
                    document.getElementById("bookmakerModal");
                const bookmakerCloseBtn =
                    bookmakerModal.querySelector(".modal-close");
                const bookmakerCancelBtn = bookmakerModal.querySelector(
                    ".modal-footer .btn:first-child",
                );
                const bookmakerSaveBtn =
                    document.getElementById("save-bookmaker");

                // Open bookmaker modal when Add Bookmaker button is clicked
                document
                    .getElementById("addBookmaker")
                    .addEventListener("click", function () {
                        bookmakerModal.classList.add("active");
                        // Update group dropdown when opening modal
                        updateGroupDropdown();
                    });

                // Close modal when close button or cancel is clicked
                bookmakerCloseBtn.addEventListener("click", function () {
                    closeBookmakerModal();
                });
                bookmakerCancelBtn.addEventListener("click", function () {
                    closeBookmakerModal();
                });

                function closeBookmakerModal() {
                    bookmakerModal.classList.remove("active");
                    resetBookmakerForm();
                }

                // Logo preview functionality for bookmaker
                const bookmakerLogoInput =
                    document.getElementById("bookmaker-logo");
                const bookmakerLogoPreview = document.getElementById(
                    "bookmaker-logo-preview",
                );

                bookmakerLogoInput.addEventListener("change", function (e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            bookmakerLogoPreview.innerHTML = `
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 150px;">
                            <button type="button" id="remove-bookmaker-logo" style="display: block; margin-top: 5px;" class="btn btn-sm btn-delete">Remove</button>
                        `;

                            document
                                .getElementById("remove-bookmaker-logo")
                                .addEventListener("click", function () {
                                    bookmakerLogoInput.value = "";
                                    bookmakerLogoPreview.innerHTML = "";
                                });
                        };

                        reader.readAsDataURL(file);
                    }
                });

                // Initialize geography selector for multiple country selection
                function initGeographySelector() {
                    const geographySearch = document.getElementById(
                        "bookmaker-geography-search",
                    );
                    const geographyList = document.getElementById(
                        "bookmaker-geography-list",
                    );
                    const selectedGeographiesContainer =
                        document.getElementById("selected-geographies");

                    if (
                        !geographySearch ||
                        !geographyList ||
                        !selectedGeographiesContainer
                    ) {
                        console.error("Geography selector elements not found");
                        return;
                    }

                    // Populate country list for multiple selection
                    function renderGeographyList(filter = "") {
                        geographyList.innerHTML = "";

                        const filteredCountries = filter
                            ? countriesData.filter((c) =>
                                  c.name
                                      .toLowerCase()
                                      .includes(filter.toLowerCase()),
                              )
                            : countriesData;

                        filteredCountries.forEach((country) => {
                            // Skip if already selected
                            if (
                                selectedGeographies.some(
                                    (selected) =>
                                        selected.code === country.code,
                                )
                            ) {
                                return;
                            }

                            const item = document.createElement("div");
                            item.className = "geography-item";
                            item.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        `;

                            item.addEventListener("click", function () {
                                // Add to selected geographies
                                addGeography(country);

                                // Clear search and hide list
                                geographySearch.value = "";
                                geographyList.classList.remove("active");

                                // Re-render geography list to exclude selected items
                                renderGeographyList();
                            });

                            geographyList.appendChild(item);
                        });
                    }

                    // Add a country to selected geographies
                    function addGeography(country) {
                        // Check if already selected
                        if (
                            selectedGeographies.some(
                                (selected) => selected.code === country.code,
                            )
                        ) {
                            return;
                        }

                        // Add to selected array
                        selectedGeographies.push(country);

                        // Add to UI
                        renderSelectedGeographies();
                    }

                    // Remove a country from selected geographies
                    function removeGeography(countryCode) {
                        selectedGeographies = selectedGeographies.filter(
                            (country) => country.code !== countryCode,
                        );
                        renderSelectedGeographies();
                        // Re-render geography list since a country was removed
                        renderGeographyList(geographySearch.value);
                    }

                    // Render selected geographies in the UI
                    function renderSelectedGeographies() {
                        selectedGeographiesContainer.innerHTML = "";

                        if (selectedGeographies.length === 0) {
                            selectedGeographiesContainer.innerHTML =
                                "<i>No countries selected</i>";
                            return;
                        }

                        selectedGeographies.forEach((country) => {
                            const tag = document.createElement("div");
                            tag.className = "geography-tag";
                            tag.dataset.code = country.code;
                            tag.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                            <span class="remove-geography">√ó</span>
                        `;

                            tag.querySelector(
                                ".remove-geography",
                            ).addEventListener("click", function () {
                                removeGeography(country.code);
                            });

                            selectedGeographiesContainer.appendChild(tag);
                        });
                    }

                    // Show geography list on focus
                    geographySearch.addEventListener("focus", function () {
                        geographyList.classList.add("active");
                        renderGeographyList();
                    });

                    // Filter countries on search
                    geographySearch.addEventListener("input", function () {
                        renderGeographyList(this.value);
                        geographyList.classList.add("active");
                    });

                    // Close geography list when clicking outside
                    document.addEventListener("click", function (e) {
                        if (!e.target.closest(".country-selector")) {
                            geographyList.classList.remove("active");
                        }
                    });

                    // Initial render
                    renderSelectedGeographies();
                    renderGeographyList();
                }

                // Bookmaker Account Settings functionality
                const addAccountBtn = document.getElementById("add-account");
                const accountForm = document.getElementById("account-form");
                const accountsContainer =
                    document.getElementById("accounts-container");
                const saveAccountBtn = document.getElementById("save-account");
                const cancelAccountBtn =
                    document.getElementById("cancel-account");

                // Array to store the accounts for this bookmaker
                let bookmakerAccounts = [];
                let selectedAccountGeographies = [];
                let currentEditIndex = -1;

                // Add account button click
                addAccountBtn.addEventListener("click", function () {
                    showAccountForm();
                    currentEditIndex = -1;
                    // Update owner dropdown in the account form
                    updateAccountOwnerDropdown();
                });

                // Auto-fill from Group Account Settings
                document
                    .getElementById("auto-fill-from-group")
                    .addEventListener("click", function () {
                        const groupSelect =
                            document.getElementById("bookmaker-group");
                        if (!groupSelect || !groupSelect.value) {
                            alert(
                                "Please select a group in the Bookmaker Settings tab first.",
                            );
                            return;
                        }

                        const selectedGroupId = groupSelect.value;
                        const selectedGroup = groupsData.find(
                            (group) => group.id === selectedGroupId,
                        );

                        if (!selectedGroup) {
                            alert("Selected group not found.");
                            return;
                        }

                        if (!selectedGroup.account) {
                            alert(
                                "The selected group does not have account settings configured.",
                            );
                            return;
                        }

                        // Fill the account form with group account settings
                        const ownerSelect = document.getElementById(
                            "bookmaker-account-owner",
                        );
                        const statusSelect =
                            document.getElementById("account-status");
                        const usernameField = document.getElementById(
                            "bookmaker-account-username",
                        );
                        const passwordField = document.getElementById(
                            "bookmaker-account-password",
                        );

                        // Set owner
                        for (let i = 0; i < ownerSelect.options.length; i++) {
                            if (
                                ownerSelect.options[i].value ===
                                selectedGroup.account.owner
                            ) {
                                ownerSelect.selectedIndex = i;
                                break;
                            }
                        }

                        // Set status
                        statusSelect.value =
                            selectedGroup.account.status || "active";

                        // Set username and password
                        usernameField.value =
                            selectedGroup.account.username || "";
                        passwordField.value =
                            selectedGroup.account.password || "";

                        alert(
                            "Account details auto-filled from group account settings.",
                        );
                    });

                // Cancel account button click
                cancelAccountBtn.addEventListener("click", function () {
                    hideAccountForm();
                });

                // Save account button click
                saveAccountBtn.addEventListener("click", function () {
                    const ownerSelect = document.getElementById(
                        "bookmaker-account-owner",
                    );
                    const ownerId = ownerSelect.value;
                    const ownerName =
                        ownerSelect.options[ownerSelect.selectedIndex].text;

                    // Obtenha os valores corretos dos campos de formul√°rio
                    const statusField =
                        document.getElementById("account-status");
                    const usernameField = document.getElementById(
                        "bookmaker-account-username",
                    );
                    const passwordField = document.getElementById(
                        "bookmaker-account-password",
                    );

                    const accountData = {
                        id: Date.now().toString(),
                        owner: {
                            id: ownerId,
                            name: ownerName,
                        },
                        status: statusField.value,
                        username: usernameField.value,
                        password: passwordField.value,
                        geographies: selectedAccountGeographies.map(
                            (country) => ({
                                code: country.code,
                                name: country.name,
                                flag: country.flag,
                            }),
                        ),
                        // Initialize deal data
                        deal: {
                            type: "revshare", // Default deal type
                            description: "", // Empty description
                            perGeography: false, // Not per geography by default
                            geographyDeals: [], // Empty array for geography-specific deals
                        },
                    };

                    console.log("Valores dos campos:", {
                        username: usernameField.value,
                        password: passwordField.value,
                    });

                    // Validate
                    if (!accountData.owner.id) {
                        alert("Please select an owner");
                        return;
                    }

                    if (!accountData.username) {
                        alert("Please enter a username/email");
                        return;
                    }

                    if (!accountData.password) {
                        alert("Please enter a password");
                        return;
                    }

                    if (currentEditIndex >= 0) {
                        // Update existing account
                        bookmakerAccounts[currentEditIndex] = accountData;
                    } else {
                        // Add new account
                        bookmakerAccounts.push(accountData);
                    }

                    // Update UI
                    renderBookmakerAccounts();
                    renderDealAccounts(); // Update the deal settings tab
                    renderBillingAccounts(); // Update the billing settings tab
                    hideAccountForm();
                    resetAccountForm();
                });

                // Function to show the account form
                function showAccountForm() {
                    accountForm.style.display = "block";
                    // Copy selected geographies to account geographies for selection
                    updateAccountGeographies();
                }

                // Function to hide the account form
                function hideAccountForm() {
                    accountForm.style.display = "none";
                }

                // Function to render selected account geographies in the UI
                function renderSelectedAccountGeographies() {
                    const selectedGeographiesContainer =
                        document.getElementById("account-selected-geographies");

                    if (!selectedGeographiesContainer) return;

                    selectedGeographiesContainer.innerHTML = "";

                    if (selectedAccountGeographies.length === 0) {
                        selectedGeographiesContainer.innerHTML =
                            "<i>No countries selected</i>";
                        return;
                    }

                    selectedAccountGeographies.forEach((country) => {
                        const tag = document.createElement("div");
                        tag.className = "geography-tag";
                        tag.dataset.code = country.code;
                        tag.innerHTML = `
                        <span class="country-flag">${country.flag}</span>
                        <span>${country.name}</span>
                        <span class="remove-geography">√ó</span>
                    `;

                        tag.querySelector(".remove-geography").addEventListener(
                            "click",
                            function () {
                                selectedAccountGeographies =
                                    selectedAccountGeographies.filter(
                                        (c) => c.code !== country.code,
                                    );
                                renderSelectedAccountGeographies();
                            },
                        );

                        selectedGeographiesContainer.appendChild(tag);
                    });
                }

                // Function to reset the account form
                function resetAccountForm() {
                    document.getElementById(
                        "bookmaker-account-owner",
                    ).selectedIndex = 0;
                    document.getElementById("account-status").value = "active";
                    document.getElementById(
                        "bookmaker-account-username",
                    ).value = "";
                    document.getElementById(
                        "bookmaker-account-password",
                    ).value = "";
                    selectedAccountGeographies = [];
                    renderSelectedAccountGeographies();
                }

                // Function to render the bookmaker accounts in the UI
                function renderBookmakerAccounts() {
                    accountsContainer.innerHTML = "";

                    if (bookmakerAccounts.length === 0) {
                        accountsContainer.innerHTML =
                            "<p><i>No accounts added yet</i></p>";
                        return;
                    }

                    bookmakerAccounts.forEach((account, index) => {
                        const accountEl = document.createElement("div");
                        accountEl.className = "account-item";
                        accountEl.style.border = "1px solid #e0e0e0";
                        accountEl.style.borderRadius = "4px";
                        accountEl.style.padding = "10px";
                        accountEl.style.marginBottom = "10px";

                        const geographiesText =
                            account.geographies.length > 0
                                ? account.geographies
                                      .map((g) => `${g.flag} ${g.name}`)
                                      .join(", ")
                                : "No geographies selected";

                        accountEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${account.username}</strong> (${account.owner.name})
                                <div style="font-size: 0.9em; color: #666;">Status: ${account.status}</div>
                                <div style="font-size: 0.9em; margin-top: 5px;">
                                    <strong>Geographies:</strong> ${geographiesText}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-edit edit-account" data-index="${index}" style="padding: 3px 8px; font-size: 12px;">Edit</button>
                                <button class="btn btn-delete delete-account" data-index="${index}" style="padding: 3px 8px; font-size: 12px;">Delete</button>
                            </div>
                        </div>
                    `;

                        accountsContainer.appendChild(accountEl);
                    });

                    // Add event listeners for edit and delete buttons
                    document
                        .querySelectorAll(".edit-account")
                        .forEach((button) => {
                            button.addEventListener("click", function () {
                                const index = parseInt(
                                    this.getAttribute("data-index"),
                                );
                                editAccount(index);
                            });
                        });

                    document
                        .querySelectorAll(".delete-account")
                        .forEach((button) => {
                            button.addEventListener("click", function () {
                                const index = parseInt(
                                    this.getAttribute("data-index"),
                                );
                                deleteAccount(index);
                            });
                        });
                }

                // Function to edit an account
                function editAccount(index) {
                    const account = bookmakerAccounts[index];
                    currentEditIndex = index;

                    // Update owner dropdown
                    updateAccountOwnerDropdown();

                    // Set form values
                    const ownerSelect = document.getElementById(
                        "bookmaker-account-owner",
                    );
                    for (let i = 0; i < ownerSelect.options.length; i++) {
                        if (ownerSelect.options[i].value === account.owner.id) {
                            ownerSelect.selectedIndex = i;
                            break;
                        }
                    }

                    document.getElementById("account-status").value =
                        account.status;
                    document.getElementById(
                        "bookmaker-account-username",
                    ).value = account.username;
                    document.getElementById(
                        "bookmaker-account-password",
                    ).value = account.password;

                    // Set selected geographies
                    selectedAccountGeographies = account.geographies.map(
                        (geo) => {
                            const country = countriesData.find(
                                (c) => c.code === geo.code,
                            );
                            return country || geo;
                        },
                    );

                    renderSelectedAccountGeographies();
                    showAccountForm();
                }

                // Function to delete an account
                function deleteAccount(index) {
                    if (
                        confirm("Are you sure you want to delete this account?")
                    ) {
                        bookmakerAccounts.splice(index, 1);
                        renderBookmakerAccounts();
                        renderDealAccounts(); // Update the deal settings tab
                        renderBillingAccounts(); // Update the billing settings tab
                    }
                }

                // Update the owner dropdown in the account form
                function updateAccountOwnerDropdown() {
                    const ownerDropdown = document.getElementById(
                        "bookmaker-account-owner",
                    );
                    if (!ownerDropdown) return;

                    // Clear current options except the first one
                    while (ownerDropdown.options.length > 1) {
                        ownerDropdown.remove(1);
                    }

                    // Add owners to dropdown
                    ownersData.forEach((owner) => {
                        const option = document.createElement("option");
                        option.value = owner.id;
                        option.textContent = owner.name;
                        ownerDropdown.appendChild(option);
                    });
                }

                // Initialize account geography selector
                function updateAccountGeographies() {
                    // Initialize with the bookmaker geographies
                    initAccountGeographySelector();
                }

                // Initialize geography selector for account geographies
                function initAccountGeographySelector() {
                    const geographySearch = document.getElementById(
                        "account-geography-search",
                    );
                    const geographyList = document.getElementById(
                        "account-geography-list",
                    );
                    const selectedGeographiesContainer =
                        document.getElementById("account-selected-geographies");

                    if (
                        !geographySearch ||
                        !geographyList ||
                        !selectedGeographiesContainer
                    ) {
                        console.error(
                            "Account geography selector elements not found",
                        );
                        return;
                    }

                    // Populate country list for multiple selection with only the countries selected in bookmaker settings
                    function renderAccountGeographyList(filter = "") {
                        geographyList.innerHTML = "";

                        // Filter from the main bookmaker geographies
                        const availableGeographies = selectedGeographies.filter(
                            (country) =>
                                !selectedAccountGeographies.some(
                                    (selected) =>
                                        selected.code === country.code,
                                ),
                        );

                        const filteredCountries = filter
                            ? availableGeographies.filter((c) =>
                                  c.name
                                      .toLowerCase()
                                      .includes(filter.toLowerCase()),
                              )
                            : availableGeographies;

                        filteredCountries.forEach((country) => {
                            const item = document.createElement("div");
                            item.className = "geography-item";
                            item.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        `;

                            item.addEventListener("click", function () {
                                // Add to selected account geographies
                                addAccountGeography(country);

                                // Clear search and hide list
                                geographySearch.value = "";
                                geographyList.classList.remove("active");

                                // Re-render geography list
                                renderAccountGeographyList();
                            });

                            geographyList.appendChild(item);
                        });
                    }

                    // Add a country to selected account geographies
                    function addAccountGeography(country) {
                        // Check if already selected
                        if (
                            selectedAccountGeographies.some(
                                (selected) => selected.code === country.code,
                            )
                        ) {
                            return;
                        }

                        // Add to selected array
                        selectedAccountGeographies.push(country);

                        // Add to UI
                        renderSelectedAccountGeographies();
                    }

                    // Remove a country from selected account geographies
                    function removeAccountGeography(countryCode) {
                        selectedAccountGeographies =
                            selectedAccountGeographies.filter(
                                (country) => country.code !== countryCode,
                            );
                        renderSelectedAccountGeographies();
                        renderAccountGeographyList(geographySearch.value);
                    }

                    // Handle removing geography specifically within this context
                    function removeAccountGeography(countryCode) {
                        selectedAccountGeographies =
                            selectedAccountGeographies.filter(
                                (country) => country.code !== countryCode,
                            );
                        renderSelectedAccountGeographies();
                        renderAccountGeographyList(geographySearch.value);
                    }

                    // Use the global renderSelectedAccountGeographies function

                    // Show geography list on focus
                    geographySearch.addEventListener("focus", function () {
                        geographyList.classList.add("active");
                        renderAccountGeographyList();
                    });

                    // Filter countries on search
                    geographySearch.addEventListener("input", function () {
                        renderAccountGeographyList(this.value);
                        geographyList.classList.add("active");
                    });

                    // Close geography list when clicking outside
                    document.addEventListener("click", function (e) {
                        if (
                            !e.target.closest("#account-geography-list") &&
                            !e.target.closest("#account-geography-search")
                        ) {
                            geographyList.classList.remove("active");
                        }
                    });

                    // Initial render
                    renderSelectedAccountGeographies();
                    renderAccountGeographyList();
                }

                // Initialize accounts list
                renderBookmakerAccounts();

                // Function to render geography URL fields
                function renderGeographyURLs() {
                    const urlContainer = document.getElementById("url-geographies-container");
                    const noGeographiesMessage = document.getElementById("url-no-geographies-message");
                    
                    if (!urlContainer) return;
                    
                    // Show or hide the no geographies message
                    if (selectedGeographies.length === 0) {
                        noGeographiesMessage.style.display = "block";
                        urlContainer.innerHTML = "";
                        return;
                    } else {
                        noGeographiesMessage.style.display = "none";
                    }
                    
                    urlContainer.innerHTML = "";
                    
                    // Create URL field for each geography
                    selectedGeographies.forEach((geography) => {
                        // Find existing URL or create empty one
                        const geographyURL = bookmakerURLs.find(u => u.geographyCode === geography.code)?.url || "";
                        
                        const urlFieldContainer = document.createElement("div");
                        urlFieldContainer.className = "geography-url-field";
                        urlFieldContainer.innerHTML = `
                            <div class="geography-name" style="margin-top: 15px; margin-bottom: 5px;">
                                <span class="country-flag">${geography.flag}</span>
                                <strong>${geography.name}</strong>
                            </div>
                            <div class="form-group">
                                <label for="geography-url-${geography.code}">URL for ${geography.name}</label>
                                <input 
                                    type="url" 
                                    id="geography-url-${geography.code}" 
                                    class="form-control geography-url" 
                                    data-geography-code="${geography.code}" 
                                    placeholder="Enter URL for ${geography.name}"
                                    value="${geographyURL}"
                                />
                            </div>
                        `;
                        
                        urlContainer.appendChild(urlFieldContainer);
                    });
                    
                    // Add event listeners for URL changes
                    document.querySelectorAll(".geography-url").forEach(input => {
                        input.addEventListener("input", function() {
                            const geographyCode = this.dataset.geographyCode;
                            const urlValue = this.value;
                            
                            // Find if URL already exists for this geography
                            const existingURLIndex = bookmakerURLs.findIndex(u => u.geographyCode === geographyCode);
                            
                            if (existingURLIndex !== -1) {
                                bookmakerURLs[existingURLIndex].url = urlValue;
                            } else {
                                bookmakerURLs.push({
                                    geographyCode: geographyCode,
                                    url: urlValue
                                });
                            }
                        });
                    });
                }
                
                // Function to render geography affiliate URL fields
                function renderGeographyAffiliateURLs() {
                    const urlContainer = document.getElementById("affiliate-url-geographies-container");
                    const noGeographiesMessage = document.getElementById("affiliate-url-no-geographies-message");
                    
                    if (!urlContainer) return;
                    
                    // Show or hide the no geographies message
                    if (selectedGeographies.length === 0) {
                        noGeographiesMessage.style.display = "block";
                        urlContainer.innerHTML = "";
                        return;
                    } else {
                        noGeographiesMessage.style.display = "none";
                    }
                    
                    urlContainer.innerHTML = "";
                    
                    // Create affiliate URL field for each geography
                    selectedGeographies.forEach((geography) => {
                        // Find existing affiliate URL or create empty one
                        const geographyAffiliateURL = bookmakerAffiliateURLs.find(u => u.geographyCode === geography.code)?.url || "";
                        
                        const urlFieldContainer = document.createElement("div");
                        urlFieldContainer.className = "geography-url-field";
                        urlFieldContainer.innerHTML = `
                            <div class="geography-name" style="margin-top: 15px; margin-bottom: 5px;">
                                <span class="country-flag">${geography.flag}</span>
                                <strong>${geography.name}</strong>
                            </div>
                            <div class="auto-fill-buttons" style="margin-bottom: 10px;">
                                <button type="button" class="btn auto-fill-affiliate-bookmaker" 
                                    data-geography-code="${geography.code}" 
                                    style="margin-right: 10px; background-color: #28a745; font-size: 12px; padding: 4px 8px;">
                                    Auto-fill from Bookmaker
                                </button>
                                <button type="button" class="btn auto-fill-affiliate-group" 
                                    data-geography-code="${geography.code}" 
                                    style="background-color: #17a2b8; font-size: 12px; padding: 4px 8px;">
                                    Auto-fill from Group
                                </button>
                            </div>
                            <div class="form-group">
                                <label for="geography-affiliate-url-${geography.code}">Affiliate URL for ${geography.name}</label>
                                <input 
                                    type="url" 
                                    id="geography-affiliate-url-${geography.code}" 
                                    class="form-control geography-affiliate-url" 
                                    data-geography-code="${geography.code}" 
                                    placeholder="Enter affiliate URL for ${geography.name}"
                                    value="${geographyAffiliateURL}"
                                />
                            </div>
                        `;
                        
                        urlContainer.appendChild(urlFieldContainer);
                    });
                    
                    // Add event listeners for affiliate URL changes
                    document.querySelectorAll(".geography-affiliate-url").forEach(input => {
                        input.addEventListener("input", function() {
                            const geographyCode = this.dataset.geographyCode;
                            const urlValue = this.value;
                            
                            // Find if affiliate URL already exists for this geography
                            const existingURLIndex = bookmakerAffiliateURLs.findIndex(u => u.geographyCode === geographyCode);
                            
                            if (existingURLIndex !== -1) {
                                bookmakerAffiliateURLs[existingURLIndex].url = urlValue;
                            } else {
                                bookmakerAffiliateURLs.push({
                                    geographyCode: geographyCode,
                                    url: urlValue
                                });
                            }
                        });
                    });
                    
                    // Add event listeners for auto-fill buttons
                    addAffiliateAutoFillEventListeners();
                }
                
                // Function to add event listeners for affiliate URL auto-fill buttons
                function addAffiliateAutoFillEventListeners() {
                    // Auto-fill from Bookmaker
                    document.querySelectorAll(".auto-fill-affiliate-bookmaker").forEach(button => {
                        button.addEventListener("click", function() {
                            const geographyCode = this.dataset.geographyCode;
                            
                            // Get bookmaker general affiliate URL from settings
                            const bookmakerAffiliateURL = document.getElementById("bookmaker-affiliate-url").value;
                            
                            if (!bookmakerAffiliateURL) {
                                alert("No affiliate URL is set in the Bookmaker Settings tab. Please set it first.");
                                return;
                            }
                            
                            // Set the affiliate URL for this geography
                            const affiliateUrlInput = document.getElementById(`geography-affiliate-url-${geographyCode}`);
                            if (affiliateUrlInput) {
                                affiliateUrlInput.value = bookmakerAffiliateURL;
                                
                                // Update the stored data
                                const existingURLIndex = bookmakerAffiliateURLs.findIndex(u => u.geographyCode === geographyCode);
                                if (existingURLIndex !== -1) {
                                    bookmakerAffiliateURLs[existingURLIndex].url = bookmakerAffiliateURL;
                                } else {
                                    bookmakerAffiliateURLs.push({
                                        geographyCode: geographyCode,
                                        url: bookmakerAffiliateURL
                                    });
                                }
                                
                                alert(`Affiliate URL for ${geographyCode} has been set from Bookmaker Settings.`);
                            }
                        });
                    });
                    
                    // Auto-fill from Group
                    document.querySelectorAll(".auto-fill-affiliate-group").forEach(button => {
                        button.addEventListener("click", function() {
                            const geographyCode = this.dataset.geographyCode;
                            
                            // Get selected group 
                            const selectedGroupId = document.getElementById("bookmaker-group").value;
                            if (!selectedGroupId) {
                                alert("Please select a group in the Bookmaker Settings tab first.");
                                return;
                            }
                            
                            // Find the group
                            const group = groupsData.find(g => g.id === selectedGroupId);
                            if (!group) {
                                alert("Selected group not found.");
                                return;
                            }
                            
                            // Check if group has affiliate URL
                            if (!group.affiliateUrl) {
                                alert("The selected group does not have an affiliate URL configured.");
                                return;
                            }
                            
                            // Set the affiliate URL for this geography
                            const affiliateUrlInput = document.getElementById(`geography-affiliate-url-${geographyCode}`);
                            if (affiliateUrlInput) {
                                affiliateUrlInput.value = group.affiliateUrl;
                                
                                // Update the stored data
                                const existingURLIndex = bookmakerAffiliateURLs.findIndex(u => u.geographyCode === geographyCode);
                                if (existingURLIndex !== -1) {
                                    bookmakerAffiliateURLs[existingURLIndex].url = group.affiliateUrl;
                                } else {
                                    bookmakerAffiliateURLs.push({
                                        geographyCode: geographyCode,
                                        url: group.affiliateUrl
                                    });
                                }
                                
                                alert(`Affiliate URL for ${geographyCode} has been set from Group Settings.`);
                            }
                        });
                    });
                }
                
                // Function to render game selection for each geography
                function renderGeographyGames() {
                    const gamesContainer = document.getElementById("games-geographies-container");
                    const noGeographiesMessage = document.getElementById("games-no-geographies-message");
                    
                    if (!gamesContainer) return;
                    
                    // Show or hide the no geographies message
                    if (selectedGeographies.length === 0) {
                        noGeographiesMessage.style.display = "block";
                        gamesContainer.innerHTML = "";
                        return;
                    } else {
                        noGeographiesMessage.style.display = "none";
                    }
                    
                    gamesContainer.innerHTML = "";
                    
                    // Create game selection for each geography
                    selectedGeographies.forEach((geography) => {
                        // Find existing games for this geography or create empty array
                        const geographyGames = bookmakerGames.find(g => g.geographyCode === geography.code)?.games || [];
                        
                        const gameSelectionContainer = document.createElement("div");
                        gameSelectionContainer.className = "geography-games-field";
                        gameSelectionContainer.innerHTML = `
                            <div class="geography-name" style="margin-top: 15px; margin-bottom: 5px;">
                                <span class="country-flag">${geography.flag}</span>
                                <strong>${geography.name}</strong>
                            </div>
                            <div class="form-group">
                                <label for="geography-games-${geography.code}">Games for ${geography.name}</label>
                                <div class="multi-select-container" style="position: relative;">
                                    <div class="selected-games-display" id="selected-games-display-${geography.code}" style="
                                        border: 1px solid #ced4da;
                                        border-radius: 4px;
                                        padding: 6px 12px;
                                        min-height: 38px;
                                        cursor: pointer;
                                        display: flex;
                                        flex-wrap: wrap;
                                        gap: 5px;
                                        align-items: center;
                                    ">
                                        ${geographyGames.length === 0 ? '<span class="placeholder" style="color: #6c757d;">Select games...</span>' : ''}
                                        ${geographyGames.map(game => `
                                            <span class="selected-game-tag" data-game="${game}" style="
                                                background-color: #f0f0f0;
                                                border-radius: 3px;
                                                padding: 2px 8px;
                                                display: flex;
                                                align-items: center;
                                            ">
                                                ${game}
                                                <span class="remove-game" style="margin-left: 5px; cursor: pointer;">√ó</span>
                                            </span>
                                        `).join('')}
                                    </div>
                                    <div class="games-dropdown" id="games-dropdown-${geography.code}" style="
                                        display: none;
                                        position: absolute;
                                        width: 100%;
                                        max-height: 200px;
                                        overflow-y: auto;
                                        z-index: 100;
                                        background-color: white;
                                        border: 1px solid #ced4da;
                                        border-radius: 4px;
                                        margin-top: 5px;
                                    ">
                                        <div class="games-search-container" style="padding: 8px; border-bottom: 1px solid #e0e0e0;">
                                            <input type="text" class="games-search form-control" id="games-search-${geography.code}" placeholder="Search games..." style="width: 100%;">
                                        </div>
                                        <div class="games-options" id="games-options-${geography.code}">
                                            ${availableGames.map(game => `
                                                <div class="game-option${geographyGames.includes(game) ? ' selected' : ''}" data-game="${game}" style="
                                                    padding: 8px 12px;
                                                    cursor: pointer;
                                                    display: flex;
                                                    align-items: center;
                                                ">
                                                    <input type="checkbox" style="margin-right: 8px;" ${geographyGames.includes(game) ? 'checked' : ''}>
                                                    <span>${game}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        gamesContainer.appendChild(gameSelectionContainer);
                    });
                    
                    // Add event listeners for game selection
                    addGameSelectionEventListeners();
                }
                
                // Function to add event listeners for game selection
                function addGameSelectionEventListeners() {
                    // Toggle dropdown when clicking on selected games display
                    document.querySelectorAll(".selected-games-display").forEach(display => {
                        const geographyCode = display.id.replace('selected-games-display-', '');
                        const dropdown = document.getElementById(`games-dropdown-${geographyCode}`);
                        
                        display.addEventListener("click", function() {
                            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                        });
                    });
                    
                    // Handle option selection
                    document.querySelectorAll(".game-option").forEach(option => {
                        const gameValue = option.dataset.game;
                        const checkbox = option.querySelector('input[type="checkbox"]');
                        const geographyCode = option.closest('.games-dropdown').id.replace('games-dropdown-', '');
                        
                        option.addEventListener("click", function() {
                            checkbox.checked = !checkbox.checked;
                            option.classList.toggle('selected');
                            
                            updateSelectedGames(geographyCode, gameValue, checkbox.checked);
                        });
                    });
                    
                    // Handle search in dropdown
                    document.querySelectorAll(".games-search").forEach(searchInput => {
                        const geographyCode = searchInput.id.replace('games-search-', '');
                        const optionsContainer = document.getElementById(`games-options-${geographyCode}`);
                        
                        searchInput.addEventListener("input", function() {
                            const searchValue = this.value.toLowerCase();
                            
                            optionsContainer.querySelectorAll('.game-option').forEach(option => {
                                const gameName = option.dataset.game.toLowerCase();
                                if (gameName.includes(searchValue)) {
                                    option.style.display = 'flex';
                                } else {
                                    option.style.display = 'none';
                                }
                            });
                        });
                        
                        // Prevent dropdown from closing when clicking on search input
                        searchInput.addEventListener("click", function(e) {
                            e.stopPropagation();
                        });
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener("click", function(e) {
                        if (!e.target.closest('.multi-select-container')) {
                            document.querySelectorAll('.games-dropdown').forEach(dropdown => {
                                dropdown.style.display = 'none';
                            });
                        }
                    });
                    
                    // Handle removing a game tag
                    document.querySelectorAll(".remove-game").forEach(removeBtn => {
                        const gameTag = removeBtn.closest('.selected-game-tag');
                        const gameValue = gameTag.dataset.game;
                        const geographyCode = gameTag.closest('.selected-games-display').id.replace('selected-games-display-', '');
                        
                        removeBtn.addEventListener("click", function(e) {
                            e.stopPropagation();
                            updateSelectedGames(geographyCode, gameValue, false);
                        });
                    });
                }
                
                // Function to update selected games
                function updateSelectedGames(geographyCode, gameValue, isSelected) {
                    // Find existing games for this geography or create a new entry
                    let geographyGamesIndex = bookmakerGames.findIndex(g => g.geographyCode === geographyCode);
                    
                    if (geographyGamesIndex === -1) {
                        // Create new entry if it doesn't exist
                        bookmakerGames.push({
                            geographyCode: geographyCode,
                            games: isSelected ? [gameValue] : []
                        });
                        geographyGamesIndex = bookmakerGames.length - 1;
                    } else {
                        // Update existing entry
                        if (isSelected) {
                            // Add game if not already present
                            if (!bookmakerGames[geographyGamesIndex].games.includes(gameValue)) {
                                bookmakerGames[geographyGamesIndex].games.push(gameValue);
                            }
                        } else {
                            // Remove game
                            bookmakerGames[geographyGamesIndex].games = bookmakerGames[geographyGamesIndex].games.filter(game => game !== gameValue);
                        }
                    }
                    
                    // Update UI
                    renderGeographyGames();
                }
                
                // Array to store geography URLs
                let bookmakerURLs = [];
                // Array to store geography affiliate URLs
                let bookmakerAffiliateURLs = [];
                // Array to store geography games
                let bookmakerGames = [];
                // Available games options
                const availableGames = ["Sports Betting", "Casino", "Poker", "Bingo", "Lottery", "Horse Racing"];
                
                // Array to store contacts
                let bookmakerContacts = [];
                // Available contact types
                const availableContactTypes = ["Email", "WhatsApp", "Skype", "Telegram", "LinkedIn", "Instagram", "Microsoft Teams", "Cellphone"];
                // Available departments
                const availableDepartments = ["CEO", "CMO", "CTO", "CFO", "IT", "Finance", "Sales", "Affiliate Manager", "General", "Outro"];
                
                // Add event listener to the Bookmaker URL tab to render URLs when tab is clicked
                const bookmakerURLTab = document.querySelector('.tab[data-tab="bookmaker-url"]');
                bookmakerURLTab.addEventListener("click", renderGeographyURLs);
                
                // Add event listener to the Bookmaker Affiliate URL tab to render affiliate URLs when tab is clicked
                const bookmakerAffiliateURLTab = document.querySelector('.tab[data-tab="bookmaker-affiliate-urls"]');
                bookmakerAffiliateURLTab.addEventListener("click", renderGeographyAffiliateURLs);
                
                // Add event listener to the Bookmaker Games tab to render games when tab is clicked
                const bookmakerGamesTab = document.querySelector('.tab[data-tab="bookmaker-games"]');
                bookmakerGamesTab.addEventListener("click", renderGeographyGames);
                
                // Add event listener to the Bookmaker Contacts tab to initialize contacts when tab is clicked
                const bookmakerContactsTab = document.querySelector('.tab[data-tab="bookmaker-contacts"]');
                bookmakerContactsTab.addEventListener("click", initializeContacts);
                
                // Add event listener to render URL tab content when geographies change
                const geographiesObserver = new MutationObserver(function(mutations) {
                    for (let mutation of mutations) {
                        if (mutation.type === 'childList') {
                            // If the current active tab is bookmaker-url, render the URLs
                            if (document.querySelector('.tab[data-tab="bookmaker-url"]').classList.contains('active')) {
                                renderGeographyURLs();
                            }
                            // If the current active tab is bookmaker-affiliate-urls, render the affiliate URLs
                            if (document.querySelector('.tab[data-tab="bookmaker-affiliate-urls"]').classList.contains('active')) {
                                renderGeographyAffiliateURLs();
                            }
                        }
                    }
                });
                
                // Start observing the selected-geographies container for changes
                geographiesObserver.observe(document.getElementById("selected-geographies"), {
                    childList: true,
                    subtree: true
                });
                
                // Initialize contacts section
                function initializeContacts() {
                    const contactsContainer = document.getElementById("contacts-container");
                    const noGeographiesMessage = document.getElementById("contacts-no-geographies-message");
                    
                    // Show or hide the no geographies message
                    if (selectedGeographies.length === 0) {
                        noGeographiesMessage.style.display = "block";
                        contactsContainer.style.display = "none";
                    } else {
                        noGeographiesMessage.style.display = "none";
                        contactsContainer.style.display = "block";
                    }
                    
                    // Render existing contacts
                    renderContacts();
                    
                    // Add event listener for Add Contact button if not already added
                    const addContactBtn = document.getElementById("add-contact");
                    if (addContactBtn) {
                        // Remove existing event listener to prevent duplicates
                        const newAddContactBtn = addContactBtn.cloneNode(true);
                        addContactBtn.parentNode.replaceChild(newAddContactBtn, addContactBtn);
                        
                        // Add event listener to the new button
                        newAddContactBtn.addEventListener("click", showContactForm);
                    }
                    
                    // Add event listener for Save Contact button
                    const saveContactBtn = document.getElementById("save-contact");
                    if (saveContactBtn) {
                        // Remove existing event listener to prevent duplicates
                        const newSaveContactBtn = saveContactBtn.cloneNode(true);
                        saveContactBtn.parentNode.replaceChild(newSaveContactBtn, saveContactBtn);
                        
                        // Add event listener to the new button
                        newSaveContactBtn.addEventListener("click", saveContact);
                    }
                    
                    // Add event listener for Cancel Contact button
                    const cancelContactBtn = document.getElementById("cancel-contact");
                    if (cancelContactBtn) {
                        // Remove existing event listener to prevent duplicates
                        const newCancelContactBtn = cancelContactBtn.cloneNode(true);
                        cancelContactBtn.parentNode.replaceChild(newCancelContactBtn, cancelContactBtn);
                        
                        // Add event listener to the new button
                        newCancelContactBtn.addEventListener("click", hideContactForm);
                    }
                    
                    // Add event listener for Add Contact Method button
                    const addContactMethodBtn = document.getElementById("add-contact-method");
                    if (addContactMethodBtn) {
                        // Remove existing event listener to prevent duplicates
                        const newAddContactMethodBtn = addContactMethodBtn.cloneNode(true);
                        addContactMethodBtn.parentNode.replaceChild(newAddContactMethodBtn, addContactMethodBtn);
                        
                        // Add event listener to the new button
                        newAddContactMethodBtn.addEventListener("click", addContactMethod);
                    }
                    
                    // Initialize department dropdown
                    initDepartmentDropdown();
                    
                    // Initialize contact geography dropdown with selected geographies
                    initContactGeographyDropdown();
                }
                
                // Function to safely set value on form elements
                function safeSetValue(elementId, value) {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value;
                    } else {
                        console.error(`Element with ID '${elementId}' not found.`);
                    }
                }
                
                // Function to show the contact form
                function showContactForm() {
                    const contactForm = document.getElementById("contact-form");
                    if (contactForm) {
                        contactForm.style.display = "block";
                    } else {
                        console.error("Element with ID 'contact-form' not found.");
                        return; // Exit the function if the form doesn't exist
                    }
                    
                    // Safely clear form fields
                    safeSetValue("contact-name", "");
                    safeSetValue("department-search", "");
                    
                    const selectedDepartments = document.getElementById("contact-selected-departments");
                    if (selectedDepartments) {
                        selectedDepartments.innerHTML = "";
                    } else {
                        console.error("Element with ID 'contact-selected-departments' not found.");
                    }
                    
                    safeSetValue("contact-geography-search", "");
                    
                    const contactSelectedGeographies = document.getElementById("contact-selected-geographies");
                    if (contactSelectedGeographies) {
                        contactSelectedGeographies.innerHTML = "";
                    } else {
                        console.error("Element with ID 'contact-selected-geographies' not found.");
                    }
                    
                    // Clear contact methods
                    const contactMethodsList = document.getElementById("contact-methods-list");
                    if (contactMethodsList) {
                        contactMethodsList.innerHTML = "";
                        
                        // Add an initial contact method
                        addContactMethod();
                    } else {
                        console.error("Element with ID 'contact-methods-list' not found.");
                    }
                }
                
                // Function to hide the contact form
                function hideContactForm() {
                    document.getElementById("contact-form").style.display = "none";
                }
                
                // Function to initialize department dropdown
                function initDepartmentDropdown() {
                    const departmentSearch = document.getElementById("department-search");
                    const departmentsDropdown = document.getElementById("departments-dropdown");
                    const selectedDepartmentsContainer = document.getElementById("contact-selected-departments");
                    
                    // Show dropdown on focus
                    departmentSearch.addEventListener("focus", function() {
                        departmentsDropdown.style.display = "block";
                        filterDepartments("");
                    });
                    
                    // Filter departments on search
                    departmentSearch.addEventListener("input", function() {
                        departmentsDropdown.style.display = "block";
                        filterDepartments(this.value);
                    });
                    
                    // Handle department selection
                    departmentsDropdown.querySelectorAll(".dropdown-item").forEach(item => {
                        item.addEventListener("click", function() {
                            const department = this.dataset.value;
                            
                            // Check if already selected
                            if (!isDepartmentSelected(department)) {
                                addSelectedDepartment(department);
                            }
                            
                            departmentSearch.value = "";
                            departmentsDropdown.style.display = "none";
                        });
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener("click", function(e) {
                        if (!e.target.closest(".department-selector")) {
                            departmentsDropdown.style.display = "none";
                        }
                    });
                    
                    // Function to check if department is already selected
                    function isDepartmentSelected(department) {
                        return selectedDepartmentsContainer.querySelector(`.selected-item[data-value="${department}"]`) !== null;
                    }
                    
                    // Function to add a selected department
                    function addSelectedDepartment(department) {
                        const item = document.createElement("div");
                        item.className = "selected-item";
                        item.dataset.value = department;
                        item.innerHTML = `
                            <span>${department}</span>
                            <span class="remove-item">√ó</span>
                        `;
                        
                        // Add event listener to remove item
                        item.querySelector(".remove-item").addEventListener("click", function() {
                            item.remove();
                        });
                        
                        selectedDepartmentsContainer.appendChild(item);
                    }
                    
                    // Filter departments based on search
                    function filterDepartments(query) {
                        const items = departmentsDropdown.querySelectorAll(".dropdown-item");
                        if (!query) {
                            items.forEach(item => item.style.display = "block");
                            return;
                        }
                        
                        query = query.toLowerCase();
                        items.forEach(item => {
                            const department = item.dataset.value.toLowerCase();
                            if (department.includes(query)) {
                                item.style.display = "block";
                            } else {
                                item.style.display = "none";
                            }
                        });
                    }
                }
                
                // Function to initialize contact geography dropdown
                function initContactGeographyDropdown() {
                    const geographySearch = document.getElementById("contact-geography-search");
                    const geographyDropdown = document.getElementById("contact-geography-dropdown");
                    const selectedGeographiesContainer = document.getElementById("contact-selected-geographies");
                    
                    // Clear the dropdown
                    geographyDropdown.innerHTML = "";
                    
                    // Add geography options based on selected geographies in bookmaker settings
                    selectedGeographies.forEach(geography => {
                        const option = document.createElement("div");
                        option.className = "dropdown-item";
                        option.dataset.code = geography.code;
                        option.dataset.name = geography.name;
                        option.dataset.flag = geography.flag;
                        option.innerHTML = `<span class="country-flag">${geography.flag}</span> ${geography.name}`;
                        
                        option.addEventListener("click", function() {
                            // Check if already selected
                            if (!isGeographySelected(this.dataset.code)) {
                                addSelectedGeography(this.dataset.code, this.dataset.name, this.dataset.flag);
                            }
                            
                            // Clear search and hide dropdown
                            geographySearch.value = "";
                            geographyDropdown.style.display = "none";
                        });
                        
                        geographyDropdown.appendChild(option);
                    });
                    
                    // Show dropdown on focus
                    geographySearch.addEventListener("focus", function() {
                        geographyDropdown.style.display = "block";
                        filterGeographies("");
                    });
                    
                    // Filter geographies on search
                    geographySearch.addEventListener("input", function() {
                        geographyDropdown.style.display = "block";
                        filterGeographies(this.value);
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener("click", function(e) {
                        if (!e.target.closest(".geography-selector")) {
                            geographyDropdown.style.display = "none";
                        }
                    });
                    
                    // Function to check if geography is already selected
                    function isGeographySelected(code) {
                        return selectedGeographiesContainer.querySelector(`.selected-item[data-code="${code}"]`) !== null;
                    }
                    
                    // Function to add a selected geography
                    function addSelectedGeography(code, name, flag) {
                        const item = document.createElement("div");
                        item.className = "selected-item";
                        item.dataset.code = code;
                        item.innerHTML = `
                            <span class="country-flag">${flag}</span>
                            <span>${name}</span>
                            <span class="remove-item">√ó</span>
                        `;
                        
                        // Add event listener to remove item
                        item.querySelector(".remove-item").addEventListener("click", function() {
                            item.remove();
                        });
                        
                        selectedGeographiesContainer.appendChild(item);
                    }
                    
                    // Function to filter geographies based on search
                    function filterGeographies(query) {
                        const items = geographyDropdown.querySelectorAll(".dropdown-item");
                        if (!query) {
                            items.forEach(item => item.style.display = "block");
                            return;
                        }
                        
                        query = query.toLowerCase();
                        items.forEach(item => {
                            const geography = item.dataset.name.toLowerCase();
                            if (geography.includes(query)) {
                                item.style.display = "block";
                            } else {
                                item.style.display = "none";
                            }
                        });
                    }
                }
                
                // Function to add a contact method
                function addContactMethod() {
                    const contactMethodsList = document.getElementById("contact-methods-list");
                    const template = document.getElementById("contact-method-template");
                    
                    // Clone the template content
                    const templateContent = template.innerHTML;
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = templateContent;
                    const contactMethodElement = tempDiv.firstElementChild;
                    
                    // Append the contact method to the list
                    contactMethodsList.appendChild(contactMethodElement);
                    
                    // Initialize contact type dropdown
                    initContactTypeDropdown(contactMethodElement);
                    
                    // Add event listener for remove button
                    contactMethodElement.querySelector(".remove-contact-method").addEventListener("click", function() {
                        contactMethodElement.remove();
                    });
                    
                    return contactMethodElement;
                }
                
                // Function to initialize contact type dropdown
                function initContactTypeDropdown(contactMethodElement) {
                    const contactTypeSearch = contactMethodElement.querySelector(".contact-type-search");
                    const contactTypeDropdown = contactMethodElement.querySelector(".contact-type-dropdown");
                    const selectedContactType = contactMethodElement.querySelector(".selected-contact-type");
                    const contactTypeValueInput = contactMethodElement.querySelector(".contact-type-value");
                    
                    // Show dropdown on focus
                    contactTypeSearch.addEventListener("focus", function() {
                        contactTypeDropdown.style.display = "block";
                        filterContactTypes("");
                    });
                    
                    // Filter contact types on search
                    contactTypeSearch.addEventListener("input", function() {
                        contactTypeDropdown.style.display = "block";
                        filterContactTypes(this.value);
                    });
                    
                    // Handle contact type selection
                    contactTypeDropdown.querySelectorAll(".dropdown-item").forEach(item => {
                        item.addEventListener("click", function() {
                            const contactType = this.dataset.value;
                            contactTypeValueInput.value = contactType;
                            contactTypeSearch.value = "";
                            selectedContactType.textContent = contactType;
                            selectedContactType.style.display = "inline-block";
                            contactTypeDropdown.style.display = "none";
                        });
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener("click", function(e) {
                        if (!e.target.closest(".contact-type-selector")) {
                            contactTypeDropdown.style.display = "none";
                        }
                    });
                    
                    // Filter contact types based on search
                    function filterContactTypes(query) {
                        const items = contactTypeDropdown.querySelectorAll(".dropdown-item");
                        if (!query) {
                            items.forEach(item => item.style.display = "block");
                            return;
                        }
                        
                        query = query.toLowerCase();
                        items.forEach(item => {
                            const contactType = item.dataset.value.toLowerCase();
                            if (contactType.includes(query)) {
                                item.style.display = "block";
                            } else {
                                item.style.display = "none";
                            }
                        });
                    }
                }
                
                // Function to save a contact
                function saveContact() {
                    const name = document.getElementById("contact-name").value;
                    
                    // Validate required fields
                    if (!name) {
                        alert("Please enter a contact name");
                        return;
                    }
                    
                    // Get selected departments
                    const selectedDepartmentElements = document.getElementById("contact-selected-departments").querySelectorAll(".selected-item");
                    const departments = Array.from(selectedDepartmentElements).map(element => element.dataset.value);
                    
                    // Validate at least one department
                    if (departments.length === 0) {
                        alert("Please select at least one department");
                        return;
                    }
                    
                    // Get selected geographies
                    const selectedGeographyElements = document.getElementById("contact-selected-geographies").querySelectorAll(".selected-item");
                    const geographies = Array.from(selectedGeographyElements).map(element => ({
                        code: element.dataset.code,
                        name: element.querySelector("span:nth-child(2)").textContent,
                        flag: element.querySelector(".country-flag").textContent
                    }));
                    
                    // Validate at least one geography
                    if (geographies.length === 0) {
                        alert("Please select at least one geography");
                        return;
                    }
                    
                    // Get contact methods
                    const contactMethodElements = document.getElementById("contact-methods-list").querySelectorAll(".contact-method");
                    const contactMethods = [];
                    
                    let hasValidContactMethod = false;
                    
                    contactMethodElements.forEach(element => {
                        const type = element.querySelector(".contact-type-value").value;
                        const value = element.querySelector(".contact-value").value;
                        
                        if (type && value) {
                            contactMethods.push({ type, value });
                            hasValidContactMethod = true;
                        }
                    });
                    
                    // Validate at least one valid contact method
                    if (!hasValidContactMethod) {
                        alert("Please add at least one valid contact method");
                        return;
                    }
                    
                    // Create contact object
                    const contact = {
                        id: Date.now().toString(),
                        name,
                        departments,
                        geographies,
                        contactMethods
                    };
                    
                    // Add to contacts array
                    bookmakerContacts.push(contact);
                    
                    // Render contacts
                    renderContacts();
                    
                    // Hide the form
                    hideContactForm();
                }
                
                // Function to render contacts
                function renderContacts() {
                    const contactsList = document.getElementById("contacts-list");
                    const noContactsMessage = document.getElementById("no-contacts-message");
                    
                    if (!contactsList) {
                        console.error("Element with ID 'contacts-list' not found.");
                        return;
                    }
                    
                    if (bookmakerContacts.length === 0) {
                        if (noContactsMessage) {
                            noContactsMessage.style.display = "block";
                            // Clear any existing contacts except the message
                            while (contactsList.childElementCount > 1) {
                                contactsList.removeChild(contactsList.lastChild);
                            }
                        } else {
                            console.error("Element with ID 'no-contacts-message' not found.");
                            contactsList.innerHTML = "<p><i>No contacts added yet</i></p>";
                        }
                        return;
                    }
                    
                    // Hide the no contacts message
                    if (noContactsMessage) {
                        noContactsMessage.style.display = "none";
                    }
                    
                    // Clear existing contacts
                    contactsList.innerHTML = "";
                    
                    // Render each contact
                    bookmakerContacts.forEach(contact => {
                        const contactCard = document.createElement("div");
                        contactCard.className = "contact-card";
                        contactCard.dataset.id = contact.id;
                        
                        // Create the department tags
                        const departmentTags = (Array.isArray(contact.departments) ? contact.departments : [contact.department])
                            .map(dept => `<span class="department-tag" style="display: inline-block; margin-right: 5px; background-color: #e9ecef; padding: 2px 6px; border-radius: 3px;">${dept}</span>`)
                            .join(" ");
                        
                        // Create the geography tags
                        const geographyTags = contact.geographies.map(geo => 
                            `<div class="selected-item">
                                <span class="country-flag">${geo.flag}</span>
                                <span>${geo.name}</span>
                            </div>`
                        ).join("");
                        
                        // Create the contact methods list
                        const methodsList = contact.contactMethods.map(method => 
                            `<div class="contact-method-item">
                                <span class="contact-method-type">${method.type}:</span>
                                <span>${method.value}</span>
                            </div>`
                        ).join("");
                        
                        contactCard.innerHTML = `
                            <div class="contact-header">
                                <h4>${contact.name}</h4>
                                <div class="contact-actions">
                                    <button class="btn btn-edit edit-contact" data-id="${contact.id}" style="padding: 3px 8px; font-size: 12px; margin-right: 5px;">Edit</button>
                                    <button class="btn btn-delete delete-contact" data-id="${contact.id}" style="padding: 3px 8px; font-size: 12px;">Delete</button>
                                </div>
                            </div>
                            <div class="contact-info">
                                <strong>Departments:</strong> ${departmentTags}
                            </div>
                            <div class="contact-info">
                                <strong>Geographies:</strong>
                                <div class="contact-geographies">
                                    ${geographyTags}
                                </div>
                            </div>
                            <div class="contact-methods">
                                <strong>Contact Methods:</strong>
                                ${methodsList}
                            </div>
                        `;
                        
                        contactsList.appendChild(contactCard);
                    });
                    
                    // Add event listeners for edit and delete buttons
                    document.querySelectorAll(".edit-contact").forEach(button => {
                        button.addEventListener("click", function() {
                            editContact(this.dataset.id);
                        });
                    });
                    
                    document.querySelectorAll(".delete-contact").forEach(button => {
                        button.addEventListener("click", function() {
                            deleteContact(this.dataset.id);
                        });
                    });
                }
                
                // Function to edit a contact
                function editContact(contactId) {
                    const contact = bookmakerContacts.find(c => c.id === contactId);
                    if (!contact) return;
                    
                    // Show the contact form
                    showContactForm();
                    
                    // Fill the form with contact data
                    document.getElementById("contact-name").value = contact.name;
                    
                    // Clear existing departments
                    document.getElementById("contact-selected-departments").innerHTML = "";
                    
                    // Add selected departments
                    const departments = Array.isArray(contact.departments) ? contact.departments : [contact.department];
                    departments.forEach(dept => {
                        const item = document.createElement("div");
                        item.className = "selected-item";
                        item.dataset.value = dept;
                        item.innerHTML = `
                            <span>${dept}</span>
                            <span class="remove-item">√ó</span>
                        `;
                        
                        // Add event listener to remove item
                        item.querySelector(".remove-item").addEventListener("click", function() {
                            item.remove();
                        });
                        
                        document.getElementById("contact-selected-departments").appendChild(item);
                    });
                    
                    // Clear existing geographies
                    document.getElementById("contact-selected-geographies").innerHTML = "";
                    
                    // Add selected geographies
                    contact.geographies.forEach(geo => {
                        const item = document.createElement("div");
                        item.className = "selected-item";
                        item.dataset.code = geo.code;
                        item.innerHTML = `
                            <span class="country-flag">${geo.flag}</span>
                            <span>${geo.name}</span>
                            <span class="remove-item">√ó</span>
                        `;
                        
                        // Add event listener to remove item
                        item.querySelector(".remove-item").addEventListener("click", function() {
                            item.remove();
                        });
                        
                        document.getElementById("contact-selected-geographies").appendChild(item);
                    });
                    
                    // Clear existing contact methods
                    document.getElementById("contact-methods-list").innerHTML = "";
                    
                    // Add contact methods
                    contact.contactMethods.forEach(method => {
                        const methodElement = addContactMethod();
                        
                        // Set the contact type
                        methodElement.querySelector(".contact-type-value").value = method.type;
                        methodElement.querySelector(".selected-contact-type").textContent = method.type;
                        methodElement.querySelector(".selected-contact-type").style.display = "inline-block";
                        
                        // Set the contact value
                        methodElement.querySelector(".contact-value").value = method.value;
                    });
                    
                    // Store the contact ID for update
                    document.getElementById("contact-form").dataset.editId = contactId;
                    
                    // Update the save button event listener
                    const saveContactBtn = document.getElementById("save-contact");
                    const newSaveContactBtn = saveContactBtn.cloneNode(true);
                    saveContactBtn.parentNode.replaceChild(newSaveContactBtn, saveContactBtn);
                    
                    newSaveContactBtn.addEventListener("click", function() {
                        updateContact(contactId);
                    });
                }
                
                // Function to update a contact
                function updateContact(contactId) {
                    const name = document.getElementById("contact-name").value;
                    
                    // Validate required fields
                    if (!name) {
                        alert("Please enter a contact name");
                        return;
                    }
                    
                    // Get selected departments
                    const selectedDepartmentElements = document.getElementById("contact-selected-departments").querySelectorAll(".selected-item");
                    const departments = Array.from(selectedDepartmentElements).map(element => element.dataset.value);
                    
                    // Validate at least one department
                    if (departments.length === 0) {
                        alert("Please select at least one department");
                        return;
                    }
                    
                    // Get selected geographies
                    const selectedGeographyElements = document.getElementById("contact-selected-geographies").querySelectorAll(".selected-item");
                    const geographies = Array.from(selectedGeographyElements).map(element => ({
                        code: element.dataset.code,
                        name: element.querySelector("span:nth-child(2)").textContent,
                        flag: element.querySelector(".country-flag").textContent
                    }));
                    
                    // Validate at least one geography
                    if (geographies.length === 0) {
                        alert("Please select at least one geography");
                        return;
                    }
                    
                    // Get contact methods
                    const contactMethodElements = document.getElementById("contact-methods-list").querySelectorAll(".contact-method");
                    const contactMethods = [];
                    
                    let hasValidContactMethod = false;
                    
                    contactMethodElements.forEach(element => {
                        const type = element.querySelector(".contact-type-value").value;
                        const value = element.querySelector(".contact-value").value;
                        
                        if (type && value) {
                            contactMethods.push({ type, value });
                            hasValidContactMethod = true;
                        }
                    });
                    
                    // Validate at least one valid contact method
                    if (!hasValidContactMethod) {
                        alert("Please add at least one valid contact method");
                        return;
                    }
                    
                    // Find contact index
                    const contactIndex = bookmakerContacts.findIndex(c => c.id === contactId);
                    if (contactIndex === -1) return;
                    
                    // Update contact
                    bookmakerContacts[contactIndex] = {
                        id: contactId,
                        name,
                        departments,
                        geographies,
                        contactMethods
                    };
                    
                    // Render contacts
                    renderContacts();
                    
                    // Hide the form
                    hideContactForm();
                    
                    // Reset the form save button
                    const saveContactBtn = document.getElementById("save-contact");
                    const newSaveContactBtn = saveContactBtn.cloneNode(true);
                    saveContactBtn.parentNode.replaceChild(newSaveContactBtn, saveContactBtn);
                    
                    newSaveContactBtn.addEventListener("click", saveContact);
                }
                
                // Function to delete a contact
                function deleteContact(contactId) {
                    if (confirm("Are you sure you want to delete this contact?")) {
                        // Remove contact from array
                        bookmakerContacts = bookmakerContacts.filter(c => c.id !== contactId);
                        
                        // Render contacts
                        renderContacts();
                    }
                }

                // Save bookmaker
                bookmakerSaveBtn.addEventListener("click", function () {
                    const bookmakerId = Date.now().toString(); // Generate a unique ID
                    const bookmakerData = {
                        id: bookmakerId,
                        group: document.getElementById("bookmaker-group").value,
                        status: document.getElementById("bookmaker-status")
                            .value,
                        name: document.getElementById("bookmaker-name").value,
                        affiliateUrl: document.getElementById(
                            "bookmaker-affiliate-url",
                        ).value,
                        geographies: selectedGeographies.map((country) => ({
                            code: country.code,
                            name: country.name,
                            flag: country.flag,
                        })),
                        geographyURLs: bookmakerURLs,
                        geographyAffiliateURLs: bookmakerAffiliateURLs,
                        geographyGames: bookmakerGames,
                        accounts: bookmakerAccounts,
                    };

                    // Add to bookmakers array
                    bookmakersData.push(bookmakerData);
                    
                    // Salvar no banco de dados local
                    window.DB.bookmakers.save(bookmakersData);

                    console.log("Bookmaker data:", bookmakerData);
                    alert("Bookmaker added successfully!");
                    closeBookmakerModal();

                    // Atualizar a tabela de bookmakers
                    renderBookmakersTable();
                });

                function resetBookmakerForm() {
                    // Reset Bookmaker Settings fields
                    document.getElementById("bookmaker-group").selectedIndex =
                        0;
                    document.getElementById("bookmaker-status").value =
                        "active";
                    document.getElementById("bookmaker-name").value = "";
                    document.getElementById("bookmaker-logo").value = "";
                    document.getElementById(
                        "bookmaker-logo-preview",
                    ).innerHTML = "";
                    document.getElementById("bookmaker-affiliate-url").value =
                        "";

                    // Clear selected geographies
                    selectedGeographies = [];
                    document.getElementById("selected-geographies").innerHTML =
                        "<i>No countries selected</i>";

                    // Reset geography URLs
                    bookmakerURLs = [];
                    const urlGeographiesContainer = document.getElementById("url-geographies-container");
                    if (urlGeographiesContainer) {
                        urlGeographiesContainer.innerHTML = "";
                    }
                    const noGeographiesMessage = document.getElementById("url-no-geographies-message");
                    if (noGeographiesMessage) {
                        noGeographiesMessage.style.display = "block";
                    }
                    
                    // Reset geography affiliate URLs
                    bookmakerAffiliateURLs = [];
                    const affiliateUrlGeographiesContainer = document.getElementById("affiliate-url-geographies-container");
                    if (affiliateUrlGeographiesContainer) {
                        affiliateUrlGeographiesContainer.innerHTML = "";
                    }
                    const noAffiliateGeographiesMessage = document.getElementById("affiliate-url-no-geographies-message");
                    if (noAffiliateGeographiesMessage) {
                        noAffiliateGeographiesMessage.style.display = "block";
                    }
                    
                    // Reset geography games
                    bookmakerGames = [];
                    const gamesGeographiesContainer = document.getElementById("games-geographies-container");
                    if (gamesGeographiesContainer) {
                        gamesGeographiesContainer.innerHTML = "";
                    }
                    const noGamesGeographiesMessage = document.getElementById("games-no-geographies-message");
                    if (noGamesGeographiesMessage) {
                        noGamesGeographiesMessage.style.display = "block";
                    }

                    // Clear geography search
                    document.getElementById(
                        "bookmaker-geography-search",
                    ).value = "";
                    document
                        .getElementById("bookmaker-geography-list")
                        .classList.remove("active");

                    // Reset accounts
                    bookmakerAccounts = [];
                    accountsContainer.innerHTML =
                        "<p><i>No accounts added yet</i></p>";
                    hideAccountForm();
                    resetAccountForm();

                    // Reset deal accounts container
                    const dealAccountsContainer = document.getElementById(
                        "deal-accounts-container",
                    );
                    if (dealAccountsContainer) {
                        dealAccountsContainer.innerHTML = "";
                    }

                    // Reset billing accounts container
                    const billingAccountsContainer = document.getElementById(
                        "billing-accounts-container",
                    );
                    if (billingAccountsContainer) {
                        billingAccountsContainer.innerHTML = "";
                    }

                    // Show no accounts message in deal tab
                    const noAccountsMessage = document.getElementById(
                        "no-accounts-message",
                    );
                    if (noAccountsMessage) {
                        noAccountsMessage.style.display = "block";
                    }

                    // Show no accounts message in billing tab
                    const noBillingAccountsMessage = document.getElementById(
                        "billing-no-accounts-message",
                    );
                    if (noBillingAccountsMessage) {
                        noBillingAccountsMessage.style.display = "block";
                    }

                    // Reset to first tab
                    bookmakerModal
                        .querySelector('.tab[data-tab="bookmaker-settings"]')
                        .click();
                }

                // Render billing accounts in the Billing Settings tab
                function renderBillingAccounts() {
                    const billingAccountsContainer = document.getElementById(
                        "billing-accounts-container",
                    );
                    const noBillingAccountsMessage = document.getElementById(
                        "billing-no-accounts-message",
                    );

                    if (!billingAccountsContainer) return;

                    // Show or hide the no accounts message
                    if (bookmakerAccounts.length === 0) {
                        noBillingAccountsMessage.style.display = "block";
                        billingAccountsContainer.innerHTML = "";
                        return;
                    } else {
                        noBillingAccountsMessage.style.display = "none";
                    }

                    billingAccountsContainer.innerHTML = "";

                    // Create a card for each account
                    bookmakerAccounts.forEach((account, index) => {
                        // Initialize billing data if it doesn't exist
                        if (!account.billing) {
                            account.billing = {
                                name: "",
                                vat: "",
                                address1: "",
                                address2: "",
                                city: "",
                                state: "",
                                zipCode: "",
                                country: "",
                                perGeography: false,
                                geographyBilling: [],
                            };
                        }

                        const billingCard = document.createElement("div");
                        billingCard.className = "billing-card";
                        billingCard.dataset.accountId = account.id;

                        // Create the card header with account info
                        const cardHeader = document.createElement("div");
                        cardHeader.className = "billing-account-header";
                        cardHeader.innerHTML = `
                        <strong>${account.username}</strong> (${account.owner.name})
                    `;

                        billingCard.appendChild(cardHeader);

                        // Auto-fill buttons
                        const autoFillButtons = document.createElement("div");
                        autoFillButtons.className = "auto-fill-buttons";
                        autoFillButtons.style.marginBottom = "15px";
                        autoFillButtons.innerHTML = `
                        <button type="button" class="btn auto-fill-owner-button" data-account-id="${account.id}" style="margin-right: 10px; background-color: #28a745;">Auto-fill from Owner</button>
                        <button type="button" class="btn auto-fill-group-button" data-account-id="${account.id}" style="background-color: #17a2b8;">Auto-fill from Group</button>
                    `;

                        billingCard.appendChild(autoFillButtons);

                        // If the account has geographies, show the per-geography toggle
                        const hasMultipleGeographies =
                            account.geographies.length > 1;

                        // General billing settings section
                        const generalBillingSection =
                            document.createElement("div");
                        generalBillingSection.className =
                            "general-billing-section";
                        generalBillingSection.innerHTML = `
                        <div class="form-group">
                            <label for="billing-name-${account.id}">Name</label>
                            <input type="text" id="billing-name-${account.id}" class="form-control billing-name" data-account-id="${account.id}" value="${account.billing.name || ""}">
                        </div>
                        <div class="form-group">
                            <label for="billing-vat-${account.id}">VAT</label>
                            <input type="text" id="billing-vat-${account.id}" class="form-control billing-vat" data-account-id="${account.id}" value="${account.billing.vat || ""}">
                        </div>
                        <div class="form-group">
                            <label for="billing-address1-${account.id}">Address 1</label>
                            <input type="text" id="billing-address1-${account.id}" class="form-control billing-address1" data-account-id="${account.id}" value="${account.billing.address1 || ""}">
                        </div>
                        <div class="form-group">
                            <label for="billing-address2-${account.id}">Address 2</label>
                            <input type="text" id="billing-address2-${account.id}" class="form-control billing-address2" data-account-id="${account.id}" value="${account.billing.address2 || ""}">
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="billing-city-${account.id}">City</label>
                                <input type="text" id="billing-city-${account.id}" class="form-control billing-city" data-account-id="${account.id}" value="${account.billing.city || ""}">
                            </div>
                            <div class="form-col">
                                <label for="billing-state-${account.id}">State/Province/Region</label>
                                <input type="text" id="billing-state-${account.id}" class="form-control billing-state" data-account-id="${account.id}" value="${account.billing.state || ""}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="billing-zipcode-${account.id}">Zip-Code</label>
                                <input type="text" id="billing-zipcode-${account.id}" class="form-control billing-zipcode" data-account-id="${account.id}" value="${account.billing.zipCode || ""}">
                            </div>
                            <div class="form-col">
                                <label for="billing-country-${account.id}">Country</label>
                                <div class="country-selector" id="billing-country-selector-${account.id}">
                                    <input type="text" id="billing-country-search-${account.id}" class="country-search" placeholder="Search country">
                                    <div id="billing-country-list-${account.id}" class="country-list"></div>
                                    <div id="billing-selected-country-${account.id}" class="selected-country" style="${account.billing.country ? "display: flex;" : "display: none;"}">
                                        <span id="billing-selected-flag-${account.id}" class="country-flag">${account.billing.countryFlag || ""}</span>
                                        <span id="billing-selected-name-${account.id}">${account.billing.countryName || ""}</span>
                                        <span class="country-remove">√ó</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                        billingCard.appendChild(generalBillingSection);

                        // If multiple geographies, add the option to set per-geography billing
                        if (hasMultipleGeographies) {
                            const perGeographyToggle =
                                document.createElement("div");
                            perGeographyToggle.className =
                                "per-geography-billing-toggle form-check";
                            perGeographyToggle.innerHTML = `
                            <input type="checkbox" id="per-geography-billing-${account.id}" class="form-check-input per-geography-billing-checkbox" data-account-id="${account.id}" ${account.billing.perGeography ? "checked" : ""}>
                            <label for="per-geography-billing-${account.id}">Set different billing details for each geography</label>
                        `;

                            billingCard.appendChild(perGeographyToggle);

                            // Geography-specific billing section
                            const geographyBillingSection =
                                document.createElement("div");
                            geographyBillingSection.className =
                                "geography-billing";
                            geographyBillingSection.id = `geography-billing-${account.id}`;
                            geographyBillingSection.style.display = account
                                .billing.perGeography
                                ? "block"
                                : "none";

                            // Hide the general billing section if per-geography is enabled
                            if (account.billing.perGeography) {
                                generalBillingSection.classList.add("hidden");
                            }

                            // Add forms for each geography
                            account.geographies.forEach((geography) => {
                                // Find existing geography billing or create a new one
                                let geographyBilling =
                                    account.billing.geographyBilling.find(
                                        (billing) =>
                                            billing.geographyCode ===
                                            geography.code,
                                    ) || {
                                        geographyCode: geography.code,
                                        name: "",
                                        vat: "",
                                        address1: "",
                                        address2: "",
                                        city: "",
                                        state: "",
                                        zipCode: "",
                                        country: "",
                                        countryName: "",
                                        countryFlag: "",
                                    };

                                const geographyBillingItem =
                                    document.createElement("div");
                                geographyBillingItem.className =
                                    "geography-billing-item";
                                geographyBillingItem.innerHTML = `
                                <div class="geography-name">
                                    <span class="country-flag">${geography.flag}</span>
                                    <strong>${geography.name}</strong>
                                </div>
                                <div class="auto-fill-buttons" style="margin: 10px 0;">
                                    <button type="button" class="btn auto-fill-geo-owner-button" data-account-id="${account.id}" data-geography-code="${geography.code}" style="margin-right: 10px; background-color: #28a745; font-size: 12px; padding: 4px 8px;">Auto-fill from Owner</button>
                                    <button type="button" class="btn auto-fill-geo-group-button" data-account-id="${account.id}" data-geography-code="${geography.code}" style="background-color: #17a2b8; font-size: 12px; padding: 4px 8px;">Auto-fill from Group</button>
                                </div>
                                <div class="form-group">
                                    <label for="geo-billing-name-${account.id}-${geography.code}">Name</label>
                                    <input type="text" id="geo-billing-name-${account.id}-${geography.code}" class="form-control geo-billing-name" data-account-id="${account.id}" data-geography-code="${geography.code}" value="${geographyBilling.name || ""}">
                                </div>
                                <div class="form-group">
                                    <label for="geo-billing-vat-${account.id}-${geography.code}">VAT</label>
                                    <input type="text" id="geo-billing-vat-${account.id}-${geography.code}" class="form-control geo-billing-vat" data-account-id="${account.id}" data-geography-code="${geography.code}" value="${geographyBilling.vat || ""}">
                                </div>
                                <div class="form-group">
                                    <label for="geo-billing-address1-${account.id}-${geography.code}">Address 1</label>
                                    <input type="text" id="geo-billing-address1-${account.id}-${geography.code}" class="form-control geo-billing-address1" data-account-id="${account.id}" data-geography-code="${geography.code}" value="${geographyBilling.address1 || ""}">
                                </div>
                                <div class="form-group">
                                    <label for="geo-billing-address2-${account.id}-${geography.code}">Address 2</label>
                                    <input type="text" id="geo-billing-address2-${account.id}-${geography.code}" class="form-control geo-billing-address2" data-account-id="${account.id}" data-geography-code="${geography.code}" value="${geographyBilling.address2 || ""}">
                                </div>
                                <div class="form-row">
                                    <div class="form-col">
                                        <label for="geo-billing-city-${account.id}-${geography.code}">City</label>
                                        <input type="text" id="geo-billing-city-${account.id}-${geography.code}" class="form-control geo-billing-city" data-account-id="${account.id}" data-geography-code="${geography.code}" value="${geographyBilling.city || ""}">
                                    </div>
                                    <div class="form-col">
                                        <label for="geo-billing-state-${account.id}-${geography.code}">State/Province/Region</label>
                                        <input type="text" id="geo-billing-state-${account.id}-${geography.code}" class="form-control geo-billing-state" data-account-id="${account.id}" data-geography-code="${geography.code}" value="${geographyBilling.state || ""}">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-col">
                                        <label for="geo-billing-zipcode-${account.id}-${geography.code}">Zip-Code</label>
                                        <input type="text" id="geo-billing-zipcode-${account.id}-${geography.code}" class="form-control geo-billing-zipcode" data-account-id="${account.id}" data-geography-code="${geography.code}" value="${geographyBilling.zipCode || ""}">
                                    </div>
                                    <div class="form-col">
                                        <label for="geo-billing-country-${account.id}-${geography.code}">Country</label>
                                        <div class="country-selector" id="geo-billing-country-selector-${account.id}-${geography.code}">
                                            <input type="text" id="geo-billing-country-search-${account.id}-${geography.code}" class="country-search" placeholder="Search country">
                                            <div id="geo-billing-country-list-${account.id}-${geography.code}" class="country-list"></div>
                                            <div id="geo-billing-selected-country-${account.id}-${geography.code}" class="selected-country" style="${geographyBilling.country ? "display: flex;" : "display: none;"}">
                                                <span id="geo-billing-selected-flag-${account.id}-${geography.code}" class="country-flag">${geographyBilling.countryFlag || ""}</span>
                                                <span id="geo-billing-selected-name-${account.id}-${geography.code}">${geographyBilling.countryName || ""}</span>
                                                <span class="country-remove">√ó</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                                geographyBillingSection.appendChild(
                                    geographyBillingItem,
                                );
                            });

                            billingCard.appendChild(geographyBillingSection);
                        }

                        billingAccountsContainer.appendChild(billingCard);
                    });

                    // Initialize country selectors for each account
                    bookmakerAccounts.forEach((account) => {
                        initBillingCountrySelector(
                            account.id,
                            "billing-country-search-",
                            "billing-country-list-",
                            "billing-selected-country-",
                            "billing-selected-flag-",
                            "billing-selected-name-",
                        );

                        if (
                            account.geographies.length > 1 &&
                            account.billing.perGeography
                        ) {
                            account.geographies.forEach((geography) => {
                                initBillingCountrySelector(
                                    account.id,
                                    "geo-billing-country-search-",
                                    "geo-billing-country-list-",
                                    "geo-billing-selected-country-",
                                    "geo-billing-selected-flag-",
                                    "geo-billing-selected-name-",
                                    geography.code,
                                );
                            });
                        }
                    });

                    // Add event listeners for billing form fields
                    addBillingEventListeners();

                    // Add event listeners for auto-fill buttons
                    addAutoFillEventListeners();
                }

                // Add event listeners for auto-fill buttons
                function addAutoFillEventListeners() {
                    // Auto-fill from Owner buttons (general billing)
                    document
                        .querySelectorAll(".auto-fill-owner-button")
                        .forEach((button) => {
                            button.addEventListener("click", function () {
                                const accountId = this.dataset.accountId;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );

                                if (!account) return;

                                // Find the owner
                                const owner = ownersData.find(
                                    (o) => o.id === account.owner.id,
                                );

                                if (
                                    !owner ||
                                    !owner.applyBilling ||
                                    !owner.billing
                                ) {
                                    alert(
                                        "The owner has no billing details configured.",
                                    );
                                    return;
                                }

                                // Fill the billing fields with owner data
                                account.billing.name = owner.billing.name || "";
                                account.billing.vat = owner.billing.vat || "";
                                account.billing.address1 =
                                    owner.billing.address1 || "";
                                account.billing.address2 =
                                    owner.billing.address2 || "";
                                account.billing.city = owner.billing.city || "";
                                account.billing.state =
                                    owner.billing.state || "";
                                account.billing.zipCode =
                                    owner.billing.zipCode || "";

                                // Update the country if it exists
                                if (owner.billing.country) {
                                    const country = countriesData.find(
                                        (c) => c.code === owner.billing.country,
                                    );
                                    if (country) {
                                        account.billing.country = country.code;
                                        account.billing.countryName =
                                            country.name;
                                        account.billing.countryFlag =
                                            country.flag;

                                        // Update the UI for country
                                        const selectedCountryEl =
                                            document.getElementById(
                                                `billing-selected-country-${accountId}`,
                                            );
                                        const selectedFlagEl =
                                            document.getElementById(
                                                `billing-selected-flag-${accountId}`,
                                            );
                                        const selectedNameEl =
                                            document.getElementById(
                                                `billing-selected-name-${accountId}`,
                                            );

                                        if (
                                            selectedCountryEl &&
                                            selectedFlagEl &&
                                            selectedNameEl
                                        ) {
                                            selectedCountryEl.style.display =
                                                "flex";
                                            selectedFlagEl.textContent =
                                                country.flag;
                                            selectedNameEl.textContent =
                                                country.name;
                                            selectedCountryEl.dataset.code =
                                                country.code;
                                        }
                                    }
                                }

                                // Update the form fields
                                document.getElementById(
                                    `billing-name-${accountId}`,
                                ).value = account.billing.name;
                                document.getElementById(
                                    `billing-vat-${accountId}`,
                                ).value = account.billing.vat;
                                document.getElementById(
                                    `billing-address1-${accountId}`,
                                ).value = account.billing.address1;
                                document.getElementById(
                                    `billing-address2-${accountId}`,
                                ).value = account.billing.address2;
                                document.getElementById(
                                    `billing-city-${accountId}`,
                                ).value = account.billing.city;
                                document.getElementById(
                                    `billing-state-${accountId}`,
                                ).value = account.billing.state;
                                document.getElementById(
                                    `billing-zipcode-${accountId}`,
                                ).value = account.billing.zipCode;

                                alert(
                                    "Billing details filled from Owner data.",
                                );
                            });
                        });

                    // Auto-fill from Group buttons (general billing)
                    document
                        .querySelectorAll(".auto-fill-group-button")
                        .forEach((button) => {
                            button.addEventListener("click", function () {
                                const accountId = this.dataset.accountId;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );

                                if (!account) return;

                                // Get selected group from bookmaker settings
                                const selectedGroupId =
                                    document.getElementById(
                                        "bookmaker-group",
                                    ).value;
                                if (!selectedGroupId) {
                                    alert(
                                        "Please select a group in the Bookmaker Settings tab first.",
                                    );
                                    return;
                                }

                                // Find the group
                                const group = groupsData.find(
                                    (g) => g.id === selectedGroupId,
                                );

                                if (!group || !group.billing) {
                                    alert(
                                        "The selected group has no billing details configured.",
                                    );
                                    return;
                                }

                                // Fill the billing fields with group data
                                account.billing.name = group.billing.name || "";
                                account.billing.vat = group.billing.vat || "";
                                account.billing.address1 =
                                    group.billing.address1 || "";
                                account.billing.address2 =
                                    group.billing.address2 || "";
                                account.billing.city = group.billing.city || "";
                                account.billing.state =
                                    group.billing.state || "";
                                account.billing.zipCode =
                                    group.billing.zipCode || "";

                                // Update the country if it exists
                                if (group.billing.country) {
                                    const country = countriesData.find(
                                        (c) => c.code === group.billing.country,
                                    );
                                    if (country) {
                                        account.billing.country = country.code;
                                        account.billing.countryName =
                                            country.name;
                                        account.billing.countryFlag =
                                            country.flag;

                                        // Update the UI for country
                                        const selectedCountryEl =
                                            document.getElementById(
                                                `billing-selected-country-${accountId}`,
                                            );
                                        const selectedFlagEl =
                                            document.getElementById(
                                                `billing-selected-flag-${accountId}`,
                                            );
                                        const selectedNameEl =
                                            document.getElementById(
                                                `billing-selected-name-${accountId}`,
                                            );

                                        if (
                                            selectedCountryEl &&
                                            selectedFlagEl &&
                                            selectedNameEl
                                        ) {
                                            selectedCountryEl.style.display =
                                                "flex";
                                            selectedFlagEl.textContent =
                                                country.flag;
                                            selectedNameEl.textContent =
                                                country.name;
                                            selectedCountryEl.dataset.code =
                                                country.code;
                                        }
                                    }
                                }

                                // Update the form fields
                                document.getElementById(
                                    `billing-name-${accountId}`,
                                ).value = account.billing.name;
                                document.getElementById(
                                    `billing-vat-${accountId}`,
                                ).value = account.billing.vat;
                                document.getElementById(
                                    `billing-address1-${accountId}`,
                                ).value = account.billing.address1;
                                document.getElementById(
                                    `billing-address2-${accountId}`,
                                ).value = account.billing.address2;
                                document.getElementById(
                                    `billing-city-${accountId}`,
                                ).value = account.billing.city;
                                document.getElementById(
                                    `billing-state-${accountId}`,
                                ).value = account.billing.state;
                                document.getElementById(
                                    `billing-zipcode-${accountId}`,
                                ).value = account.billing.zipCode;

                                alert(
                                    "Billing details filled from Group data.",
                                );
                            });
                        });

                    // Auto-fill from Owner buttons (per-geography billing)
                    document
                        .querySelectorAll(".auto-fill-geo-owner-button")
                        .forEach((button) => {
                            button.addEventListener("click", function () {
                                const accountId = this.dataset.accountId;
                                const geographyCode =
                                    this.dataset.geographyCode;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );

                                if (!account) return;

                                // Find the owner
                                const owner = ownersData.find(
                                    (o) => o.id === account.owner.id,
                                );

                                if (
                                    !owner ||
                                    !owner.applyBilling ||
                                    !owner.billing
                                ) {
                                    alert(
                                        "The owner has no billing details configured.",
                                    );
                                    return;
                                }

                                // Find or create the geography billing
                                let geographyBilling =
                                    account.billing.geographyBilling.find(
                                        (b) =>
                                            b.geographyCode === geographyCode,
                                    );
                                if (!geographyBilling) {
                                    geographyBilling = {
                                        geographyCode: geographyCode,
                                        name: "",
                                        vat: "",
                                        address1: "",
                                        address2: "",
                                        city: "",
                                        state: "",
                                        zipCode: "",
                                        country: "",
                                        countryName: "",
                                        countryFlag: "",
                                    };
                                    account.billing.geographyBilling.push(
                                        geographyBilling,
                                    );
                                }

                                // Fill the geography billing fields with owner data
                                geographyBilling.name =
                                    owner.billing.name || "";
                                geographyBilling.vat = owner.billing.vat || "";
                                geographyBilling.address1 =
                                    owner.billing.address1 || "";
                                geographyBilling.address2 =
                                    owner.billing.address2 || "";
                                geographyBilling.city =
                                    owner.billing.city || "";
                                geographyBilling.state =
                                    owner.billing.state || "";
                                geographyBilling.zipCode =
                                    owner.billing.zipCode || "";

                                // Update the country if it exists
                                if (owner.billing.country) {
                                    const country = countriesData.find(
                                        (c) => c.code === owner.billing.country,
                                    );
                                    if (country) {
                                        geographyBilling.country = country.code;
                                        geographyBilling.countryName =
                                            country.name;
                                        geographyBilling.countryFlag =
                                            country.flag;

                                        // Update the UI for country
                                        const selectedCountryEl =
                                            document.getElementById(
                                                `geo-billing-selected-country-${accountId}-${geographyCode}`,
                                            );
                                        const selectedFlagEl =
                                            document.getElementById(
                                                `geo-billing-selected-flag-${accountId}-${geographyCode}`,
                                            );
                                        const selectedNameEl =
                                            document.getElementById(
                                                `geo-billing-selected-name-${accountId}-${geographyCode}`,
                                            );

                                        if (
                                            selectedCountryEl &&
                                            selectedFlagEl &&
                                            selectedNameEl
                                        ) {
                                            selectedCountryEl.style.display =
                                                "flex";
                                            selectedFlagEl.textContent =
                                                country.flag;
                                            selectedNameEl.textContent =
                                                country.name;
                                            selectedCountryEl.dataset.code =
                                                country.code;
                                        }
                                    }
                                }

                                // Update the form fields
                                document.getElementById(
                                    `geo-billing-name-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.name;
                                document.getElementById(
                                    `geo-billing-vat-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.vat;
                                document.getElementById(
                                    `geo-billing-address1-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.address1;
                                document.getElementById(
                                    `geo-billing-address2-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.address2;
                                document.getElementById(
                                    `geo-billing-city-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.city;
                                document.getElementById(
                                    `geo-billing-state-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.state;
                                document.getElementById(
                                    `geo-billing-zipcode-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.zipCode;

                                alert(
                                    `Billing details for ${geographyCode} filled from Owner data.`,
                                );
                            });
                        });

                    // Auto-fill from Group buttons (per-geography billing)
                    document
                        .querySelectorAll(".auto-fill-geo-group-button")
                        .forEach((button) => {
                            button.addEventListener("click", function () {
                                const accountId = this.dataset.accountId;
                                const geographyCode =
                                    this.dataset.geographyCode;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );

                                if (!account) return;

                                // Get selected group from bookmaker settings
                                const selectedGroupId =
                                    document.getElementById(
                                        "bookmaker-group",
                                    ).value;
                                if (!selectedGroupId) {
                                    alert(
                                        "Please select a group in the Bookmaker Settings tab first.",
                                    );
                                    return;
                                }

                                // Find the group
                                const group = groupsData.find(
                                    (g) => g.id === selectedGroupId,
                                );

                                if (!group || !group.billing) {
                                    alert(
                                        "The selected group has no billing details configured.",
                                    );
                                    return;
                                }

                                // Find or create the geography billing
                                let geographyBilling =
                                    account.billing.geographyBilling.find(
                                        (b) =>
                                            b.geographyCode === geographyCode,
                                    );
                                if (!geographyBilling) {
                                    geographyBilling = {
                                        geographyCode: geographyCode,
                                        name: "",
                                        vat: "",
                                        address1: "",
                                        address2: "",
                                        city: "",
                                        state: "",
                                        zipCode: "",
                                        country: "",
                                        countryName: "",
                                        countryFlag: "",
                                    };
                                    account.billing.geographyBilling.push(
                                        geographyBilling,
                                    );
                                }

                                // Fill the geography billing fields with group data
                                geographyBilling.name =
                                    group.billing.name || "";
                                geographyBilling.vat = group.billing.vat || "";
                                geographyBilling.address1 =
                                    group.billing.address1 || "";
                                geographyBilling.address2 =
                                    group.billing.address2 || "";
                                geographyBilling.city =
                                    group.billing.city || "";
                                geographyBilling.state =
                                    group.billing.state || "";
                                geographyBilling.zipCode =
                                    group.billing.zipCode || "";

                                // Update the country if it exists
                                if (group.billing.country) {
                                    const country = countriesData.find(
                                        (c) => c.code === group.billing.country,
                                    );
                                    if (country) {
                                        geographyBilling.country = country.code;
                                        geographyBilling.countryName =
                                            country.name;
                                        geographyBilling.countryFlag =
                                            country.flag;

                                        // Update the UI for country
                                        const selectedCountryEl =
                                            document.getElementById(
                                                `geo-billing-selected-country-${accountId}-${geographyCode}`,
                                            );
                                        const selectedFlagEl =
                                            document.getElementById(
                                                `geo-billing-selected-flag-${accountId}-${geographyCode}`,
                                            );
                                        const selectedNameEl =
                                            document.getElementById(
                                                `geo-billing-selected-name-${accountId}-${geographyCode}`,
                                            );

                                        if (
                                            selectedCountryEl &&
                                            selectedFlagEl &&
                                            selectedNameEl
                                        ) {
                                            selectedCountryEl.style.display =
                                                "flex";
                                            selectedFlagEl.textContent =
                                                country.flag;
                                            selectedNameEl.textContent =
                                                country.name;
                                            selectedCountryEl.dataset.code =
                                                country.code;
                                        }
                                    }
                                }

                                // Update the form fields
                                document.getElementById(
                                    `geo-billing-name-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.name;
                                document.getElementById(
                                    `geo-billing-vat-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.vat;
                                document.getElementById(
                                    `geo-billing-address1-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.address1;
                                document.getElementById(
                                    `geo-billing-address2-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.address2;
                                document.getElementById(
                                    `geo-billing-city-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.city;
                                document.getElementById(
                                    `geo-billing-state-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.state;
                                document.getElementById(
                                    `geo-billing-zipcode-${accountId}-${geographyCode}`,
                                ).value = geographyBilling.zipCode;

                                alert(
                                    `Billing details for ${geographyCode} filled from Group data.`,
                                );
                            });
                        });
                }

                // Initialize country selector for billing
                function initBillingCountrySelector(
                    accountId,
                    searchIdPrefix,
                    listIdPrefix,
                    selectedIdPrefix,
                    flagIdPrefix,
                    nameIdPrefix,
                    geographyCode = "",
                ) {
                    const idSuffix = geographyCode
                        ? `-${accountId}-${geographyCode}`
                        : `-${accountId}`;
                    const countrySearch = document.getElementById(
                        `${searchIdPrefix}${accountId}${geographyCode ? `-${geographyCode}` : ""}`,
                    );
                    const countryList = document.getElementById(
                        `${listIdPrefix}${accountId}${geographyCode ? `-${geographyCode}` : ""}`,
                    );
                    const selectedCountry = document.getElementById(
                        `${selectedIdPrefix}${accountId}${geographyCode ? `-${geographyCode}` : ""}`,
                    );
                    const selectedFlag = document.getElementById(
                        `${flagIdPrefix}${accountId}${geographyCode ? `-${geographyCode}` : ""}`,
                    );
                    const selectedName = document.getElementById(
                        `${nameIdPrefix}${accountId}${geographyCode ? `-${geographyCode}` : ""}`,
                    );
                    const countryRemove =
                        selectedCountry.querySelector(".country-remove");

                    if (!countrySearch || !countryList || !selectedCountry) {
                        console.error(
                            `One of the country selector elements not found for account: ${accountId}`,
                        );
                        return;
                    }

                    // Populate country list
                    function renderCountryList(filter = "") {
                        countryList.innerHTML = "";

                        const filteredCountries = filter
                            ? countriesData.filter((c) =>
                                  c.name
                                      .toLowerCase()
                                      .includes(filter.toLowerCase()),
                              )
                            : countriesData;

                        filteredCountries.forEach((country) => {
                            const item = document.createElement("div");
                            item.className = "country-item";
                            item.innerHTML = `
                            <span class="country-flag">${country.flag}</span>
                            <span>${country.name}</span>
                        `;

                            item.addEventListener("click", function () {
                                // Set selected country
                                selectedFlag.textContent = country.flag;
                                selectedName.textContent = country.name;
                                selectedCountry.style.display = "flex";
                                countrySearch.value = "";
                                countryList.classList.remove("active");

                                // Store the country data in the dataset
                                selectedCountry.dataset.code = country.code;

                                // Update the account billing data
                                updateBillingCountry(
                                    accountId,
                                    country,
                                    geographyCode,
                                );
                            });

                            countryList.appendChild(item);
                        });
                    }

                    // Show country list on focus
                    countrySearch.addEventListener("focus", function () {
                        countryList.classList.add("active");
                        renderCountryList();
                    });

                    // Filter countries on search
                    countrySearch.addEventListener("input", function () {
                        renderCountryList(this.value);
                        countryList.classList.add("active");
                    });

                    // Remove selected country
                    countryRemove.addEventListener("click", function () {
                        selectedCountry.style.display = "none";
                        delete selectedCountry.dataset.code;

                        // Update the account billing data
                        updateBillingCountry(accountId, null, geographyCode);
                    });

                    // Close country list when clicking outside
                    document.addEventListener("click", function (e) {
                        if (
                            !e.target.closest(
                                `#billing-country-selector-${accountId}${geographyCode ? `-${geographyCode}` : ""}`,
                            ) &&
                            !e.target.closest(
                                `#geo-billing-country-selector-${accountId}${geographyCode ? `-${geographyCode}` : ""}`,
                            )
                        ) {
                            countryList.classList.remove("active");
                        }
                    });

                    // Initial render
                    renderCountryList();

// Salvar dados quando os modais forem fechados
function salvarDados() {
    if (window.DB) {
        if (window.ownersData) {
            window.DB.owners.save(window.ownersData);
        }
        
        if (window.groupsData) {
            window.DB.groups.save(window.groupsData);
        }
        
        if (window.bookmakersData) {
            window.DB.bookmakers.save(window.bookmakersData);
        }
        
        console.log("Dados salvos automaticamente:");
        console.log("Owners:", window.ownersData ? window.ownersData.length : 0);
        console.log("Groups:", window.groupsData ? window.groupsData.length : 0);
        console.log("Bookmakers:", window.bookmakersData ? window.bookmakersData.length : 0);
    } else {
        console.error("DB n√£o est√° dispon√≠vel");
    }
}

// Adicionar listeners para eventos de salvamento em bot√µes
document.querySelectorAll('#save-owner, #save-group, #save-bookmaker, #save-account').forEach(button => {
    button.addEventListener('click', function() {
        setTimeout(salvarDados, 500);
    });
});

// Adicionar listeners para fechamento dos modais
document.querySelectorAll('.modal-close, .modal-footer .btn').forEach(button => {
    button.addEventListener('click', function() {
        setTimeout(salvarDados, 500);
    });
});

window.addEventListener('beforeunload', function() {
    salvarDados();
});

                }

                // Update billing country data
                function updateBillingCountry(
                    accountId,
                    country,
                    geographyCode = "",
                ) {
                    const account = bookmakerAccounts.find(
                        (a) => a.id === accountId,
                    );
                    if (!account) return;

                    if (geographyCode) {
                        // Update geography billing
                        let geographyBilling =
                            account.billing.geographyBilling.find(
                                (billing) =>
                                    billing.geographyCode === geographyCode,
                            );

                        if (!geographyBilling) {
                            geographyBilling = {
                                geographyCode: geographyCode,
                                name: "",
                                vat: "",
                                address1: "",
                                address2: "",
                                city: "",
                                state: "",
                                zipCode: "",
                                country: "",
                                countryName: "",
                                countryFlag: "",
                            };
                            account.billing.geographyBilling.push(
                                geographyBilling,
                            );
                        }

                        if (country) {
                            geographyBilling.country = country.code;
                            geographyBilling.countryName = country.name;
                            geographyBilling.countryFlag = country.flag;
                        } else {
                            geographyBilling.country = "";
                            geographyBilling.countryName = "";
                            geographyBilling.countryFlag = "";
                        }
                    } else {
                        // Update general billing
                        if (country) {
                            account.billing.country = country.code;
                            account.billing.countryName = country.name;
                            account.billing.countryFlag = country.flag;
                        } else {
                            account.billing.country = "";
                            account.billing.countryName = "";
                            account.billing.countryFlag = "";
                        }
                    }
                }

                // Add event listeners for billing form fields
                function addBillingEventListeners() {
                    // General billing field listeners
                    document
                        .querySelectorAll(
                            ".billing-name, .billing-vat, .billing-address1, .billing-address2, .billing-city, .billing-state, .billing-zipcode",
                        )
                        .forEach((input) => {
                            input.addEventListener("input", function () {
                                const accountId = this.dataset.accountId;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );
                                if (!account) return;

                                const fieldName = this.className
                                    .split(" ")[1]
                                    .replace("billing-", "");
                                let billingField;

                                switch (fieldName) {
                                    case "name":
                                        billingField = "name";
                                        break;
                                    case "vat":
                                        billingField = "vat";
                                        break;
                                    case "address1":
                                        billingField = "address1";
                                        break;
                                    case "address2":
                                        billingField = "address2";
                                        break;
                                    case "city":
                                        billingField = "city";
                                        break;
                                    case "state":
                                        billingField = "state";
                                        break;
                                    case "zipcode":
                                        billingField = "zipCode";
                                        break;
                                }

                                account.billing[billingField] = this.value;
                            });
                        });

                    // Geography billing field listeners
                    document
                        .querySelectorAll(
                            ".geo-billing-name, .geo-billing-vat, .geo-billing-address1, .geo-billing-address2, .geo-billing-city, .geo-billing-state, .geo-billing-zipcode",
                        )
                        .forEach((input) => {
                            input.addEventListener("input", function () {
                                const accountId = this.dataset.accountId;
                                const geographyCode =
                                    this.dataset.geographyCode;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );
                                if (!account || !geographyCode) return;

                                let geographyBilling =
                                    account.billing.geographyBilling.find(
                                        (billing) =>
                                            billing.geographyCode ===
                                            geographyCode,
                                    );

                                if (!geographyBilling) {
                                    geographyBilling = {
                                        geographyCode: geographyCode,
                                        name: "",
                                        vat: "",
                                        address1: "",
                                        address2: "",
                                        city: "",
                                        state: "",
                                        zipCode: "",
                                        country: "",
                                        countryName: "",
                                        countryFlag: "",
                                    };
                                    account.billing.geographyBilling.push(
                                        geographyBilling,
                                    );
                                }

                                const fieldName = this.className
                                    .split(" ")[1]
                                    .replace("geo-billing-", "");
                                let billingField;

                                switch (fieldName) {
                                    case "name":
                                        billingField = "name";
                                        break;
                                    case "vat":
                                        billingField = "vat";
                                        break;
                                    case "address1":
                                        billingField = "address1";
                                        break;
                                    case "address2":
                                        billingField = "address2";
                                        break;
                                    case "city":
                                        billingField = "city";
                                        break;
                                    case "state":
                                        billingField = "state";
                                        break;
                                    case "zipcode":
                                        billingField = "zipCode";
                                        break;
                                }

                                geographyBilling[billingField] = this.value;
                            });
                        });

                    // Per geography toggle listeners
                    document
                        .querySelectorAll(".per-geography-billing-checkbox")
                        .forEach((checkbox) => {
                            checkbox.addEventListener("change", function () {
                                const accountId = this.dataset.accountId;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );
                                if (!account) return;

                                account.billing.perGeography = this.checked;

                                // Find the sections that need to be shown/hidden
                                const geographyBillingSection =
                                    document.getElementById(
                                        `geography-billing-${accountId}`,
                                    );
                                const generalBillingSection = this.closest(
                                    ".billing-card",
                                ).querySelector(".general-billing-section");

                                // Show/hide the appropriate sections
                                if (geographyBillingSection) {
                                    geographyBillingSection.style.display = this
                                        .checked
                                        ? "block"
                                        : "none";
                                }

                                if (generalBillingSection) {
                                    if (this.checked) {
                                        generalBillingSection.classList.add(
                                            "hidden",
                                        );
                                    } else {
                                        generalBillingSection.classList.remove(
                                            "hidden",
                                        );
                                    }
                                }

                                // Initialize geography billing if it doesn't exist
                                if (
                                    this.checked &&
                                    (!account.billing.geographyBilling ||
                                        account.billing.geographyBilling
                                            .length === 0)
                                ) {
                                    account.billing.geographyBilling =
                                        account.geographies.map(
                                            (geography) => ({
                                                geographyCode: geography.code,
                                                name:
                                                    account.billing.name || "",
                                                vat: account.billing.vat || "",
                                                address1:
                                                    account.billing.address1 ||
                                                    "",
                                                address2:
                                                    account.billing.address2 ||
                                                    "",
                                                city:
                                                    account.billing.city || "",
                                                state:
                                                    account.billing.state || "",
                                                zipCode:
                                                    account.billing.zipCode ||
                                                    "",
                                                country:
                                                    account.billing.country ||
                                                    "",
                                                countryName:
                                                    account.billing
                                                        .countryName || "",
                                                countryFlag:
                                                    account.billing
                                                        .countryFlag || "",
                                            }),
                                        );

                                    // Initialize the country selectors for each geography
                                    account.geographies.forEach((geography) => {
                                        initBillingCountrySelector(
                                            account.id,
                                            "geo-billing-country-search-",
                                            "geo-billing-country-list-",
                                            "geo-billing-selected-country-",
                                            "geo-billing-selected-flag-",
                                            "geo-billing-selected-name-",
                                            geography.code,
                                        );
                                    });
                                }
                            });
                        });
                }

                // Render deal accounts in the Deal Settings tab
                function renderDealAccounts() {
                    const dealAccountsContainer = document.getElementById(
                        "deal-accounts-container",
                    );
                    const noAccountsMessage = document.getElementById(
                        "no-accounts-message",
                    );

                    if (!dealAccountsContainer) return;

                    // Show or hide the no accounts message
                    if (bookmakerAccounts.length === 0) {
                        noAccountsMessage.style.display = "block";
                        dealAccountsContainer.innerHTML = "";
                        return;
                    } else {
                        noAccountsMessage.style.display = "none";
                    }

                    dealAccountsContainer.innerHTML = "";

                    // Create a card for each account
                    bookmakerAccounts.forEach((account, index) => {
                        const dealCard = document.createElement("div");
                        dealCard.className = "deal-card";
                        dealCard.dataset.accountId = account.id;

                        // Create the card header with account info
                        const cardHeader = document.createElement("div");
                        cardHeader.className = "deal-account-header";
                        cardHeader.innerHTML = `
                        <strong>${account.username}</strong> (${account.owner.name})
                    `;

                        dealCard.appendChild(cardHeader);

                        // If the account has geographies, show the per-geography toggle
                        const hasMultipleGeographies =
                            account.geographies.length > 1;

                        // General deal settings section
                        const generalDealSection =
                            document.createElement("div");
                        generalDealSection.className = "general-deal-section";
                        generalDealSection.innerHTML = `
                        <div class="form-group">
                            <label for="deal-type-${account.id}">Deal Type</label>
                            <select id="deal-type-${account.id}" class="form-control deal-type" data-account-id="${account.id}">
                                <option value="revshare" ${account.deal.type === "revshare" ? "selected" : ""}>Rev Share</option>
                                <option value="cpa" ${account.deal.type === "cpa" ? "selected" : ""}>CPA</option>
                                <option value="hybrid" ${account.deal.type === "hybrid" ? "selected" : ""}>Hybrid</option>
                                <option value="flatfee" ${account.deal.type === "flatfee" ? "selected" : ""}>Flat Fee</option>
                                <option value="other" ${account.deal.type === "other" ? "selected" : ""}>Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deal-description-${account.id}">Deal Description</label>
                            <textarea id="deal-description-${account.id}" class="form-control deal-description" data-account-id="${account.id}" rows="2" placeholder="Enter deal description">${account.deal.description || ""}</textarea>
                        </div>
                    `;

                        dealCard.appendChild(generalDealSection);

                        // If multiple geographies, add the option to set per-geography
                        if (hasMultipleGeographies) {
                            const perGeographyToggle =
                                document.createElement("div");
                            perGeographyToggle.className =
                                "per-geography-toggle form-check";
                            perGeographyToggle.innerHTML = `
                            <input type="checkbox" id="per-geography-${account.id}" class="form-check-input per-geography-checkbox" data-account-id="${account.id}" ${account.deal.perGeography ? "checked" : ""}>
                            <label for="per-geography-${account.id}">Set different deal for each geography</label>
                        `;

                            dealCard.appendChild(perGeographyToggle);

                            // Geography-specific deals section
                            const geographyDealsSection =
                                document.createElement("div");
                            geographyDealsSection.className = "geography-deals";
                            geographyDealsSection.id = `geography-deals-${account.id}`;
                            geographyDealsSection.style.display = account.deal
                                .perGeography
                                ? "block"
                                : "none";

                            // Ocultar a se√ß√£o geral se per-geography estiver ativado
                            if (account.deal.perGeography) {
                                generalDealSection.classList.add("hidden");
                            }

                            // Add forms for each geography
                            account.geographies.forEach((geography) => {
                                // Find existing geography deal or create a new one
                                let geographyDeal =
                                    account.deal.geographyDeals.find(
                                        (deal) =>
                                            deal.geographyCode ===
                                            geography.code,
                                    ) || {
                                        geographyCode: geography.code,
                                        type: "revshare",
                                        description: "",
                                    };

                                const geographyDealItem =
                                    document.createElement("div");
                                geographyDealItem.className =
                                    "geography-deal-item";
                                geographyDealItem.innerHTML = `
                                <div class="geography-name">
                                    <span class="country-flag">${geography.flag}</span>
                                    <strong>${geography.name}</strong>
                                </div>
                                <div class="form-group" style="margin-top: 8px;">
                                    <label for="geo-deal-type-${account.id}-${geography.code}">Deal Type</label>
                                    <select id="geo-deal-type-${account.id}-${geography.code}" class="form-control geo-deal-type" data-account-id="${account.id}" data-geography-code="${geography.code}">
                                        <option value="revshare" ${geographyDeal.type === "revshare" ? "selected" : ""}>Rev Share</option>
                                        <option value="cpa" ${geographyDeal.type === "cpa" ? "selected" : ""}>CPA</option>
                                        <option value="hybrid" ${geographyDeal.type === "hybrid" ? "selected" : ""}>Hybrid</option>
                                        <option value="flatfee" ${geographyDeal.type === "flatfee" ? "selected" : ""}>Flat Fee</option>
                                        <option value="other" ${geographyDeal.type === "other" ? "selected" : ""}>Outro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="geo-deal-description-${account.id}-${geography.code}">Deal Description</label>
                                    <textarea id="geo-deal-description-${account.id}-${geography.code}" class="form-control geo-deal-description" data-account-id="${account.id}" data-geography-code="${geography.code}" rows="2" placeholder="Enter deal description">${geographyDeal.description || ""}</textarea>
                                </div>
                            `;

                                geographyDealsSection.appendChild(
                                    geographyDealItem,
                                );
                            });

                            dealCard.appendChild(geographyDealsSection);
                        }

                        dealAccountsContainer.appendChild(dealCard);
                    });

                    // Add event listeners for deal changes
                    document
                        .querySelectorAll(".deal-type")
                        .forEach((select) => {
                            select.addEventListener("change", function () {
                                const accountId = this.dataset.accountId;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );
                                if (account) {
                                    account.deal.type = this.value;
                                }
                            });
                        });

                    document
                        .querySelectorAll(".deal-description")
                        .forEach((textarea) => {
                            textarea.addEventListener("input", function () {
                                const accountId = this.dataset.accountId;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );
                                if (account) {
                                    account.deal.description = this.value;
                                }
                            });
                        });

                    document
                        .querySelectorAll(".per-geography-checkbox")
                        .forEach((checkbox) => {
                            checkbox.addEventListener("change", function () {
                                const accountId = this.dataset.accountId;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );
                                if (account) {
                                    account.deal.perGeography = this.checked;
                                    // Encontrar as se√ß√µes que precisam ser mostradas/escondidas
                                    const geographyDealsSection =
                                        document.getElementById(
                                            `geography-deals-${accountId}`,
                                        );
                                    const generalDealSection = this.closest(
                                        ".deal-card",
                                    ).querySelector(".general-deal-section");

                                    // Mostrar/esconder as se√ß√µes adequadas
                                    if (geographyDealsSection) {
                                        geographyDealsSection.style.display =
                                            this.checked ? "block" : "none";
                                    }

                                    if (generalDealSection) {
                                        if (this.checked) {
                                            generalDealSection.classList.add(
                                                "hidden",
                                            );
                                        } else {
                                            generalDealSection.classList.remove(
                                                "hidden",
                                            );
                                        }
                                    }

                                    // Initialize geography deals if they don't exist
                                    if (
                                        this.checked &&
                                        (!account.deal.geographyDeals ||
                                            account.deal.geographyDeals
                                                .length === 0)
                                    ) {
                                        account.deal.geographyDeals =
                                            account.geographies.map(
                                                (geography) => ({
                                                    geographyCode:
                                                        geography.code,
                                                    type: account.deal.type,
                                                    description:
                                                        account.deal
                                                            .description,
                                                }),
                                            );
                                    }
                                }
                            });
                        });

                    document
                        .querySelectorAll(".geo-deal-type")
                        .forEach((select) => {
                            select.addEventListener("change", function () {
                                const accountId = this.dataset.accountId;
                                const geographyCode =
                                    this.dataset.geographyCode;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );

                                if (account && account.deal.perGeography) {
                                    let geographyDeal =
                                        account.deal.geographyDeals.find(
                                            (deal) =>
                                                deal.geographyCode ===
                                                geographyCode,
                                        );

                                    if (!geographyDeal) {
                                        geographyDeal = {
                                            geographyCode: geographyCode,
                                            type: this.value,
                                            description: "",
                                        };
                                        account.deal.geographyDeals.push(
                                            geographyDeal,
                                        );
                                    } else {
                                        geographyDeal.type = this.value;
                                    }
                                }
                            });
                        });

                    document
                        .querySelectorAll(".geo-deal-description")
                        .forEach((textarea) => {
                            textarea.addEventListener("input", function () {
                                const accountId = this.dataset.accountId;
                                const geographyCode =
                                    this.dataset.geographyCode;
                                const account = bookmakerAccounts.find(
                                    (a) => a.id === accountId,
                                );

                                if (account && account.deal.perGeography) {
                                    let geographyDeal =
                                        account.deal.geographyDeals.find(
                                            (deal) =>
                                                deal.geographyCode ===
                                                geographyCode,
                                        );

                                    if (!geographyDeal) {
                                        geographyDeal = {
                                            geographyCode: geographyCode,
                                            type: "revshare",
                                            description: this.value,
                                        };
                                        account.deal.geographyDeals.push(
                                            geographyDeal,
                                        );
                                    } else {
                                        geographyDeal.description = this.value;
                                    }
                                }
                            });
                        });
                }

                // Fun√ß√£o para inicializar a tabela de bookmakers quando a p√°gina carregar
                document.addEventListener("DOMContentLoaded", function() {
                    console.log("Inicializando tabela de bookmakers...");
                    console.log("Bookmakers dispon√≠veis:", bookmakersData ? bookmakersData.length : 0);
                    renderBookmakersTable();
                });

                // Fun√ß√£o para renderizar a tabela de bookmakers
                function renderBookmakersTable() {
                    const tableBody = document.getElementById("bookmakers-table-body");
                    const noBookmakersRow = document.getElementById("no-bookmakers-row");
                    
                    // Limpar a tabela
                    while (tableBody.children.length > 1) {
                        tableBody.removeChild(tableBody.lastChild);
                    }
                    
                    // Verificar se existem bookmakers
                    if (!bookmakersData || bookmakersData.length === 0) {
                        noBookmakersRow.style.display = "table-row";
                        return;
                    }
                    
                    // Esconder a linha de "nenhum bookmaker"
                    noBookmakersRow.style.display = "none";
                    
                    // Adicionar cada bookmaker √† tabela
                    bookmakersData.forEach(bookmaker => {
                        const row = document.createElement("tr");
                        
                        // Encontrar o nome do grupo
                        let groupName = "N/A";
                        if (bookmaker.group) {
                            const group = groupsData.find(g => g.id === bookmaker.group);
                            if (group) {
                                groupName = group.name;
                            }
                        }
                        
                        // Obter a primeira URL (se houver)
                        let mainUrl = "N/A";
                        if (bookmaker.geographyURLs && bookmaker.geographyURLs.length > 0) {
                            mainUrl = bookmaker.geographyURLs[0].url || "N/A";
                        }
                        
                        // Formatar geographies
                        let geographiesDisplay = "Nenhuma";
                        if (bookmaker.geographies && bookmaker.geographies.length > 0) {
                            if (bookmaker.geographies.length <= 3) {
                                geographiesDisplay = bookmaker.geographies.map(geo => 
                                    `<span title="${geo.name}">${geo.flag}</span>`
                                ).join(" ");
                            } else {
                                geographiesDisplay = `<span title="${bookmaker.geographies.length} geographies">${bookmaker.geographies.length} pa√≠ses</span>`;
                            }
                        }
                        
                        // Formatar status
                        let statusDisplay = bookmaker.status || "N/A";
                        // Capitalizar primeira letra
                        statusDisplay = statusDisplay.charAt(0).toUpperCase() + statusDisplay.slice(1);
                        
                        row.innerHTML = `
                            <td>${bookmaker.id}</td>
                            <td>${bookmaker.name}</td>
                            <td>${groupName}</td>
                            <td>${mainUrl}</td>
                            <td>${statusDisplay}</td>
                            <td>${geographiesDisplay}</td>
                            <td class="action-buttons">
                                <button class="btn btn-edit" data-id="${bookmaker.id}">Editar</button>
                                <button class="btn btn-delete" data-id="${bookmaker.id}">Excluir</button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Adicionar event listeners para os bot√µes
                    addBookmakerButtonListeners();
                }
                
                // Fun√ß√£o para adicionar listeners aos bot√µes de edi√ß√£o e exclus√£o
                function addBookmakerButtonListeners() {
                    // Event listeners para bot√µes de edi√ß√£o
                    document.querySelectorAll(".btn-edit").forEach(button => {
                        button.addEventListener("click", function() {
                            const bookmakerId = this.getAttribute("data-id");
                            const bookmaker = bookmakersData.find(b => b.id === bookmakerId);
                            
                            if (bookmaker) {
                                alert(`Editando bookmaker: ${bookmaker.name}`);
                                // Aqui voc√™ pode implementar a l√≥gica para editar o bookmaker
                                // Por exemplo, abrir o modal de bookmaker e preencher com os dados
                            }
                        });
                    });
                    
                    // Event listeners para bot√µes de exclus√£o
                    document.querySelectorAll(".btn-delete").forEach(button => {
                        button.addEventListener("click", function() {
                            const bookmakerId = this.getAttribute("data-id");
                            const bookmaker = bookmakersData.find(b => b.id === bookmakerId);
                            
                            if (bookmaker && confirm(`Tem certeza que deseja excluir o bookmaker "${bookmaker.name}"?`)) {
                                // Remover o bookmaker do array
                                bookmakersData = bookmakersData.filter(b => b.id !== bookmakerId);
                                
                                // Salvar no banco de dados local
                                window.DB.bookmakers.save(bookmakersData);
                                
                                // Atualizar a tabela
                                renderBookmakersTable();
                                
                                alert(`Bookmaker "${bookmaker.name}" exclu√≠do com sucesso!`);
                            }
                        });
                    });
                }
                
                // Renderizar a tabela ao carregar a p√°gina
                // Aguarde um momento para garantir que todos os dados foram carregados
                setTimeout(function() {
                    console.log("Inicializando tabela de bookmakers...");
                    console.log("Bookmakers dispon√≠veis:", bookmakersData ? bookmakersData.length : 0);
                    renderBookmakersTable();
                }, 300);
                
                // Renderizar a tabela novamente quando um novo bookmaker for adicionado
                bookmakerSaveBtn.addEventListener("click", function() {
                    // A l√≥gica existente para salvar o bookmaker
                    // ...
                    
                    // Ap√≥s salvar, renderizar a tabela novamente
                    setTimeout(renderBookmakersTable, 100);
                });
            });
        </script>
    </body>
</html>